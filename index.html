<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ด</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
        }
        th {
            background-color: #003366;
            color: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            font-weight: bold;
        }
        th:hover {
            background-color: #004080;
        }
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        th.sort-asc::after {
            border-bottom: 5px solid #fff;
            margin-top: -2.5px;
        }
        th.sort-desc::after {
            border-top: 5px solid #fff;
            margin-top: 2.5px;
        }
        /* ปรับแต่งไอคอน sort */
        th::before,
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.7;
        }
        th::before {
            top: 40%;
            border-bottom: 5px solid #fff;
        }
        th::after {
            top: 55%;
            border-top: 5px solid #fff;
        }
        /* ไอคอนเมื่อ active */
        th.sort-asc::before {
            opacity: 1;
            border-bottom-color: #fff;
        }
        th.sort-desc::after {
            opacity: 1;
            border-top-color: #fff;
        }
        /* เมื่อ hover ทำให้ไอคอนเด่นขึ้น */
        th:hover::before,
        th:hover::after {
            opacity: 0.9;
        }
        .pivot-table th {
            background-color: #f4f4f4;
            color: #333;
            font-weight: normal;
        }
        .pivot-table th:first-child {
            background-color: #f4f4f4;
            color: #333;
        }
        .grand-total th, .grand-total td {
            background-color: #b7e1cd;
            color: #333;
        }
        .pivot-table th, .pivot-table td {
            background-color: #e6f3ff;
        }
        .pivot-table th:first-child, .pivot-table td:first-child {
            background-color: #d9ead3;
        }
        .area-total {
            color: #006400; /* สีเขียวเข้ม */
        }
        canvas {
            margin-top: 20px;
            max-width: 800px; /* เพิ่มขนาดกราฟ */
            max-height: 400px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .controls button {
            margin-right: 10px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 25px;
            text-align: center;
            margin: 0;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-icon {
            width: 48px;
            height: 48px;
            color: #006400;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .card-content {
            flex-grow: 1;
        }
        .card-title {
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
            text-align: left;
        }
        .card-value {
            color: #006400;
            font-size: 20px;
            font-weight: bold;
            text-align: left;
        }
        #chart-container {
            margin-left: 320px;
            position: relative;
            display: flex;
            gap: 20px;
        }
        .chart-wrapper {
            flex: 1;
            min-width: 0;
            position: relative;
        }
        .total-display {
            position: absolute;
            top: -30px;
            right: 0;
            font-size: 16px;
            font-weight: bold;
            color: #006400;
        }
        #chart-label {
            position: absolute;
            top: -20px; /* ปรับตำแหน่งตามความเหมาะสม */
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
        }
        canvas#myChart, canvas#lineChart {
            height: 500px !important; /* เพิ่มความสูงของกราฟ */
            max-height: 500px !important;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 25px;
            text-align: center;
            margin: 0;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-content {
            flex: 1;
        }
        .card-icon {
            width: 48px;
            height: 48px;
            color: #006400;
        }
        .card-title {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .card-value {
            color: #006400;
            font-size: 24px;
            font-weight: bold;
        }
        /* สไตล์สำหรับตารางหลัก */
        #data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        #data-table th, #data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
            background-color: white;
            position: relative;
        }
        #data-table tbody tr td {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
        }
        #data-table th {
            background-color: #003366;
            color: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            font-weight: bold;
        }
        #data-table th:hover {
            background-color: #004080;
        }
        /* ไอคอน sort สำหรับตารางหลัก */
        #data-table th::before,
        #data-table th::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.7;
        }
        #data-table th::before {
            top: 40%;
            border-bottom: 5px solid #fff;
        }
        #data-table th::after {
            top: 55%;
            border-top: 5px solid #fff;
        }
        #data-table th.sort-asc::before {
            opacity: 1;
        }
        #data-table th.sort-desc::after {
            opacity: 1;
        }
        #data-table th:hover::before,
        #data-table th:hover::after {
            opacity: 0.9;
        }
        .table-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .table-header-container h2 {
            margin: 0;
        }
        .table-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .search-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        .search-input:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.1);
        }
        .table-buttons button {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .table-buttons button:hover {
            background-color: #f0f0f0;
        }
        .table-buttons button svg {
            width: 16px;
            height: 16px;
        }
        .legend-container {
            position: absolute;
            left: -200px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 180px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .legend-item:hover {
            background-color: #f5f5f5;
        }
        .legend-item.hidden .legend-color {
            opacity: 0.5;
        }
        .legend-item.hidden span {
            color: #999;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .header-container {
            background-color: #003366;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            width: 100%;
        }
        h1 {
            color: white;
            margin: 0;
            font-size: 24px;
        }
        #current-date {
            color: white;
            font-size: 16px;
        }
        /* สไตล์สำหรับการแบ่งหน้า */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 10px 0;
        }
        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .pagination-button {
            padding: 8px 12px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .pagination-button:hover {
            background-color: #004080;
        }
        .pagination-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .pagination-info {
            font-size: 14px;
            color: #333;
            margin: 0 10px;
        }
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page-size-selector select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .page-size-selector label {
            font-size: 14px;
            color: #333;
        }
        .pagination-pages {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .page-number {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .page-number.active {
            background-color: #003366;
            color: white;
            border-color: #003366;
        }
        .page-number:hover:not(.active) {
            background-color: #f5f5f5;
        }
        .page-ellipsis {
            padding: 6px 5px;
            font-size: 14px;
            color: #333;
        }

        /* Navigation Bar Styles */
        .nav-bar {
            background-color: #f8f9fa;
            border-bottom: 2px solid #003366;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-menu {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .nav-item {
            margin: 0;
        }

        .nav-link {
            display: block;
            padding: 15px 30px;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: #e9ecef;
            color: #003366;
        }

        .nav-link.active {
            background-color: #003366;
            color: white;
            border-bottom-color: #0056b3;
        }

        .nav-link.active:hover {
            background-color: #004080;
        }

        /* Section Styles */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #003366;
        }

        .section-header h2 {
            color: #003366;
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .section-header p {
            color: #666;
            margin: 0;
            font-size: 16px;
        }

        .placeholder-content {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        /* Loading state */
        .content-section.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .content-section.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #003366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Responsive navigation */
        @media (max-width: 768px) {
            .nav-menu {
                flex-direction: column;
            }

            .nav-link {
                padding: 12px 20px;
                text-align: center;
                border-bottom: 1px solid #ddd;
            }

            .nav-link.active {
                border-bottom: 3px solid #0056b3;
            }

            .section-header h2 {
                font-size: 20px;
            }

            .section-header p {
                font-size: 14px;
            }
        }

        /* Smooth transitions */
        .content-section {
            transition: opacity 0.3s ease-in-out;
        }

        .nav-link {
            transition: all 0.3s ease;
        }

        /* Group Code Chart Container */
        #group-code-chart-container {
            margin-left: 320px;
            position: relative;
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        #group-code-legend {
            position: absolute;
            left: -200px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 180px;
        }

        canvas#groupCodeChart, canvas#groupCodeLineChart {
            height: 500px !important;
            max-height: 500px !important;
        }

        /* Animation สำหรับ loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <div class="header-container">
        <h1>ข้อมูลแดชบอร์ดสถานะการอบรมช่างใหม่(2025)</h1>
        <p id="current-date"></p>
    </div>

    <!-- Training Status Section -->
    <div id="training-status">
        <div class="controls">
            <div style="display: flex; gap: 20px; justify-content: flex-end;">
                <div class="card">
                    <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14V16C8.69 16 6 18.69 6 22H4C4 17.58 7.58 14 12 14ZM12 13C9.33 13 7 10.67 7 8C7 5.33 9.33 3 12 3C14.67 3 17 5.33 17 8C17 10.67 14.67 13 12 13ZM12 5C10.44 5 9 6.44 9 8C9 9.56 10.44 11 12 11C13.56 11 15 9.56 15 8C15 6.44 13.56 5 12 5Z"/>
                    </svg>
                    <div class="card-content">
                        <div class="card-title">จำนวนช่างลงทะเบียนอบรม</div>
                        <div class="card-value" id="total-technician-count">-</div>
                    </div>
                </div>
                <div class="card">
                    <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                    <div class="card-content">
                        <div class="card-title">จำนวนช่างใหม่ที่ขึ้นทะเบียน</div>
                        <div class="card-value" id="new-technician-count">-</div>
                    </div>
                </div>
                <div class="card">
                    <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14V16C8.69 16 6 18.69 6 22H4C4 17.58 7.58 14 12 14ZM12 13C9.33 13 7 10.67 7 8C7 5.33 9.33 3 12 3C14.67 3 17 5.33 17 8C17 10.67 14.67 13 12 13ZM12 5C10.44 5 9 6.44 9 8C9 9.56 10.44 11 12 11C13.56 11 15 9.56 15 8C15 6.44 13.56 5 12 5ZM20.75 16C21.44 16 22 16.56 22 17.25C22 17.94 21.44 18.5 20.75 18.5H19.5V19.75C19.5 20.44 18.94 21 18.25 21C17.56 21 17 20.44 17 19.75V18.5H15.75C15.06 18.5 14.5 17.94 14.5 17.25C14.5 16.56 15.06 16 15.75 16H17V14.75C17 14.06 17.56 13.5 18.25 13.5C18.94 13.5 19.5 14.06 19.5 14.75V16H20.75Z"/>
                    </svg>
                    <div class="card-content">
                        <div class="card-title">SLA: การอบรม-การขึ้นทะเบียน</div>
                        <div class="card-value" id="sla-value">-</div>
                    </div>
                </div>
            </div>
        </div>

    <!-- เพิ่มการ์ดสถานะอื่นๆ -->
    <div style="display: flex; flex-wrap: nowrap; gap: 8px; margin-bottom: 20px; justify-content: center; overflow-x: auto;">
        <div class="card" style="background-color: #008080; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">เอกสารยังไม่ครบ</div>
                <div class="card-value" id="sla-incomplete-docs" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #DC143C; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ไม่เข้าอบรม</div>
                <div class="card-value" id="sla-not-attend" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #FF69B4; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ไม่ผ่านอบรม</div>
                <div class="card-value" id="sla-failed-training" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #FF6B00; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ช่างลาออก</div>
                <div class="card-value" id="sla-resigned" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #FF1493; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ตัวแทนยังไม่ส่งขึ้นทะเบียน</div>
                <div class="card-value" id="sla-not-submitted" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #4169E1; color: white; width: 12%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ติดประวัติอาชญากรรม</div>
                <div class="card-value" id="sla-criminal-record" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #4CA64C; color: white; width: 12%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">อยู่ระหว่างอบรมทฤษฎี</div>
                <div class="card-value" id="sla-theory-training" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #90EE90; color: white; width: 12%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">อยู่ระหว่างอบรมปฎิบัติ</div>
                <div class="card-value" id="sla-practical-training" style="font-size: 16px;">-</div>
            </div>
        </div>
    </div>

    <!-- SLA Analysis Section -->
    <div style="background-color: #f8f9fa; border: 2px solid #003366; border-radius: 8px; margin: 20px 0; padding: 20px;">
        <h3 style="color: #003366; text-align: center; margin-bottom: 20px;">การวิเคราะห์ SLA (Service Level Agreement)</h3>
        
        <!-- SLA Summary Cards -->
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; justify-content: center;">
            <div class="card" style="background-color: #28a745; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">SLA เฉลี่ย (ขึ้นทะเบียนสำเร็จ)</div>
                    <div class="card-value" id="sla-success-avg" style="font-size: 22px; color: white;">-</div>
                </div>
            </div>
            
            <div class="card" style="background-color: #17a2b8; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">SLA เฉลี่ย (ทั้งหมด)</div>
                    <div class="card-value" id="sla-overall-avg" style="font-size: 22px; color: white;">-</div>
                </div>
            </div>
            
            <div class="card" style="background-color: #6f42c1; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">เป้าหมาย SLA</div>
                    <div class="card-value" style="font-size: 22px; color: white;">≤ 30 วัน</div>
                </div>
            </div>
            
            <div class="card" style="background-color: #fd7e14; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">สถานะ SLA</div>
                    <div class="card-value" id="sla-status" style="font-size: 22px; color: white;">-</div>
                </div>
            </div>
        </div>

        <!-- SLA by Status Table -->
        <div style="margin: 20px 0;">
            <h4 style="color: #003366; margin-bottom: 15px;">การวิเคราะห์ SLA รายสถานะ</h4>
            <table id="sla-analysis-table" style="width: 100%; border-collapse: collapse; background-color: white;">
                <thead>
                    <tr style="background-color: #003366; color: white;">
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">สถานะ</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">จำนวน (คน)</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">SLA เฉลี่ย (วัน)</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">SLA สูงสุด (วัน)</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">SLA ต่ำสุด (วัน)</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">ประเมินผล</th>
                    </tr>
                </thead>
                <tbody id="sla-analysis-body">
                    <!-- จะถูกเติมด้วย JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- SLA Performance Indicators -->
        <div style="margin: 20px 0;">
            <h4 style="color: #003366; margin-bottom: 15px;">ตัวชี้วัดประสิทธิภาพ SLA</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                <div class="card" style="background-color: #20c997; color: white; min-width: 180px; padding: 12px 15px;">
                    <div class="card-content">
                        <div class="card-title" style="font-size: 14px; color: white;">% ขึ้นทะเบียนตรงเวลา</div>
                        <div class="card-value" id="sla-ontime-percentage" style="font-size: 18px; color: white;">-</div>
                    </div>
                </div>
                
                <div class="card" style="background-color: #e83e8c; color: white; min-width: 180px; padding: 12px 15px;">
                    <div class="card-content">
                        <div class="card-title" style="font-size: 14px; color: white;">% เกินกำหนด SLA</div>
                        <div class="card-value" id="sla-overdue-percentage" style="font-size: 18px; color: white;">-</div>
                    </div>
                </div>
                
                <div class="card" style="background-color: #ffc107; color: #212529; min-width: 180px; padding: 12px 15px;">
                    <div class="card-content">
                        <div class="card-title" style="font-size: 14px;">กรณีที่ต้องติดตาม</div>
                        <div class="card-value" id="sla-followup-count" style="font-size: 18px;">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chart-container">
        <div class="chart-wrapper">
            <div class="legend-container">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #006400;"></div>
                    <span>ขึ้นทะเบียนเรียบร้อย</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF6B00;"></div>
                    <span>ช่างลาออก</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF1493;"></div>
                    <span>ตัวแทนยังไม่ส่งขึ้นทะเบียน</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4169E1;"></div>
                    <span>ติดประวัติอาชญากรรม</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #90EE90;"></div>
                    <span>อยู่ระหว่างอบรมปฎิบัติ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #008080;"></div>
                    <span>เอกสารยังไม่ครบ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4CA64C;"></div>
                    <span>อยู่ระหว่างอบรมทฤษฎี</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF69B4;"></div>
                    <span>ไม่ผ่านอบรม</span>
                </div>
            </div>
            <div id="chart-label"></div>
            <canvas id="myChart" width="400" height="400"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="lineChart" width="400" height="400"></canvas>
        </div>
    </div>

    <h2 id="pivot-table-title">สถานะการอบรมช่างใหม่รายพื้นที่</h2>
    <table id="pivot-table" class="pivot-table">
        <thead>
            <tr id="pivot-header"></tr>
        </thead>
        <tbody id="pivot-body"></tbody>
    </table>

    <div class="table-header-container">
        <h2>รายละเอียดข้อมูลช่างลงทะเบียนอบรมช่างใหม่</h2>
    </div>
    <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
        <div class="card month-card" data-month="all" style="background-color: #003366; color: white; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">All</div>
        <div class="card month-card" data-month="Jan" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Jan</div>
        <div class="card month-card" data-month="Feb" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Feb</div>
        <div class="card month-card" data-month="Mar" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Mar</div>
        <div class="card month-card" data-month="Apr" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Apr</div>
        <div class="card month-card" data-month="May" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">May</div>
        <div class="card month-card" data-month="Jun" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Jun</div>
        <div class="card month-card" data-month="Jul" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Jul</div>
        <div class="card month-card" data-month="Aug" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Aug</div>
        <div class="card month-card" data-month="Sep" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Sep</div>
        <div class="card month-card" data-month="Oct" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Oct</div>
        <div class="card month-card" data-month="Nov" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Nov</div>
        <div class="card month-card" data-month="Dec" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Dec</div>
    </div>
    <div class="table-buttons" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: -40px; margin-bottom: 10px;">
        <form class="search-container" onsubmit="event.preventDefault(); searchTableData();">
            <input type="text" id="search-input" class="search-input" placeholder="พิมพ์คำค้นหา...">
            <button type="button" id="search-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                ค้นหา
            </button>
        </form>
        <button id="reset-filter-button" title="ล้างการกรอง">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 3h18v18H3z"></path>
                <path d="M21 3l-9 9M3 21l9-9"></path>
            </svg>
            ล้างตัวกรอง
        </button>
        <button id="refresh-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
            </svg>
            รีเฟรชข้อมูล
        </button>
        <button id="download-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            ดาวน์โหลด
        </button>
    </div>
    <table id="data-table">
        <thead>
            <tr>
                <th>พื้นที่</th>
                <th>รอบวันที่</th>
                <th>เดือนอบรม</th>
                <th>week</th>
                <th>ชื่อ-นามสกุล</th>
                <th>ชื่อ บจก./หจก/ร้าน (ตัวแทน)</th>
                <th>รหัสตัวแทน</th>
                <th>จังหวัดที่ตั้งร้านตัวแทน</th>
                <th>สถานะกองงาน (หัวหน้าหรือลูกน้อง)</th>
                <th>ผลการขึ้นทะเบียน</th>
                <th>Status ล่าสุด</th>
                <th>วันเริ่มต้น</th>
                <th>วันสิ้นสุด</th>
                <th>SLA</th>
                <th>ปี</th>
            </tr>
        </thead>
        <tbody id="data-body"></tbody>
    </table>

    <div class="pagination-container">
        <div class="pagination-controls">
            <button id="prev-button" class="pagination-button" disabled>ก่อนหน้า</button>
            <div class="pagination-pages" id="pagination-pages">
                <!-- หมายเลขหน้าจะถูกสร้างโดย JavaScript -->
            </div>
            <div class="pagination-info" id="pagination-info">หน้า 1 จาก 10</div>
            <button id="next-button" class="pagination-button">ถัดไป</button>
        </div>
        <div class="page-size-selector">
            <label for="page-size">จำนวนแถวต่อหน้า:</label>
            <select id="page-size">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
        </div>
    </div>
    <!-- End Training Status Section -->

    <script>
        // ฟังก์ชันเพื่ออัปเดตวันที่และเวลาปัจจุบันในรูปแบบประเทศไทย
        function updateCurrentDateTime() {
            const currentDateElement = document.getElementById('current-date');
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            const thaiYear = now.getFullYear() + 543;
            const thaiDate = now.toLocaleDateString('th-TH', options).replace(now.getFullYear(), thaiYear);
            currentDateElement.textContent = `วันที่: ${thaiDate}`;
        }

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        updateCurrentDateTime();

        // URL for Google Sheets
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLKGmFsdD4oMcVdnf_wyrwAD3-3R7Ys9hXCg2gwBsudfJIUliRymBnVYHapN7a3Yq08Lgxf9cYYV6Y/pub?gid=377151035&single=true&output=csv";

        let chart;
        let originalData;
        let filteredData2025;
        let lineChart;

        // ตัวแปรสำหรับการแบ่งหน้า
        let currentPage = 1;
        let pageSize = 50;
        let totalPages = 1;

        // ฟังก์ชันเพื่อดึงข้อมูลและอัปเดตตาราง
        function fetchDataAndUpdateTable() {
            fetch(sheetUrl)
                .then(response => response.text())
                .then(csvText => {
                    const rows = parseCsvData(csvText);
                    originalData = rows;
                    filteredData2025 = filterDataByYear(rows, 2025);
                    
                    // แยกการอัปเดตตารางหลักออกจากการอัปเดตกราฟและ pivot table
                    updateChartAndTables(filteredData2025);
                    updateLineChart(filteredData2025);
                    
                    // อัปเดตตารางหลักเพียงครั้งเดียวเมื่อโหลดข้อมูล
                    updateMainTable(filteredData2025);
                    
                    // รีเซ็ตการแสดงผลให้แสดงข้อมูลทั้งหมด
                    const allButton = document.querySelector('.month-card[data-month="all"]');
                    if (allButton) {
                        // ไฮไลต์ปุ่ม All
                        document.querySelectorAll('.month-card').forEach(card => {
                            card.style.backgroundColor = '#f0f0f0';
                            card.style.color = 'black';
                        });
                        allButton.style.backgroundColor = '#003366';
                        allButton.style.color = 'white';
                    }
                    
                    // ลบข้อความแสดงจำนวนข้อมูลที่กรองออก
                    const existingInfo = document.getElementById('data-count-info');
                    if (existingInfo) {
                        existingInfo.remove();
                    }
                    
                    // แสดงตัวควบคุมการแบ่งหน้า
                    const paginationContainer = document.querySelector('.pagination-container');
                    if (paginationContainer) {
                        paginationContainer.style.display = 'flex';
                    }
                })
                .catch(error => {
                    console.error("เกิดข้อผิดพลาดในการดึงข้อมูล:", error);
                    const messageDiv = document.createElement('div');
                    messageDiv.style.padding = '10px';
                    messageDiv.style.margin = '10px 0';
                    messageDiv.style.backgroundColor = '#f8d7da';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    messageDiv.style.borderRadius = '4px';
                    messageDiv.style.color = '#721c24';
                    messageDiv.innerHTML = 'เกิดข้อผิดพลาดในการดึงข้อมูล กรุณาลองใหม่อีกครั้ง';
                    document.querySelector('.controls').insertAdjacentElement('afterend', messageDiv);
                });
        }
        
        // ฟังก์ชันสำหรับอัปเดตเฉพาะตารางหลัก
        function updateMainTable(rows) {
            // กรองข้อมูลเฉพาะปี 2025
            window.tableData = rows.filter(row => row.c[41]?.v === '2025').map(row => ({
                area: row.c[26]?.v || '',
                roundDate: row.c[27]?.v || '',
                trainingMonth: row.c[28]?.v || '',
                week: row.c[39]?.v || '',
                name: row.c[3]?.v || '',
                company: row.c[6]?.v || '',
                agentCode: row.c[7]?.v || '',
                province: row.c[8]?.v || '',
                workStatus: row.c[13]?.v || '',
                registerResult: row.c[33]?.v || '',
                latestStatus: row.c[34]?.v || '',
                startDate: row.c[35]?.v || '',
                endDate: row.c[36]?.v || '',
                sla: row.c[37]?.v || '',
                year: row.c[41]?.v || ''
            }));
            
            // เก็บข้อมูลต้นฉบับไว้
            window.originalTableData = [...window.tableData];

            // เริ่มต้นสร้างตารางใหม่
            const dataTable = document.getElementById('data-table');
            const thead = dataTable.getElementsByTagName('thead')[0];
            thead.innerHTML = '';

            // สร้างแถวส่วนหัว
            const headerRow = thead.insertRow();
            const columnHeaders = [
                { text: "พื้นที่", key: "area" },
                { text: "รอบวันที่", key: "roundDate" },
                { text: "เดือนอบรม", key: "trainingMonth" },
                { text: "week", key: "week" },
                { text: "ชื่อ-นามสกุล", key: "name" },
                { text: "ชื่อ บจก./หจก/ร้าน (ตัวแทน)", key: "company" },
                { text: "รหัสตัวแทน", key: "agentCode" },
                { text: "จังหวัดที่ตั้งร้านตัวแทน", key: "province" },
                { text: "สถานะกองงาน (หัวหน้าหรือลูกน้อง)", key: "workStatus" },
                { text: "ผลการขึ้นทะเบียน", key: "registerResult" },
                { text: "Status ล่าสุด", key: "latestStatus" },
                { text: "วันเริ่มต้น", key: "startDate" },
                { text: "วันสิ้นสุด", key: "endDate" },
                { text: "SLA", key: "sla" },
                { text: "ปี", key: "year" }
            ];

            // สร้างหัวคอลัมน์พร้อม event listener
            columnHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.text;
                th.dataset.key = header.key;
                th.addEventListener('click', () => handleSort(header.key));
                headerRow.appendChild(th);
            });

            // แสดงข้อมูลในตาราง
            renderTableData(window.tableData);
        }

        // ฟังก์ชันแยกข้อมูล CSV
        function parseCsvData(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    let currentChar = 0;
                    let inQuotes = false;
                    let currentValue = '';
                    const values = [];
                    
                    while (currentChar < line.length) {
                        const char = line[currentChar];
                        
                        if (char === '"' && line[currentChar - 1] !== '\\') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentValue.replace(/^"|"$/g, '').trim());
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                        
                        currentChar++;
                    }
                    
                    values.push(currentValue.replace(/^"|"$/g, '').trim());
                    rows.push({
                        c: values.map(value => ({ v: value }))
                    });
                }
            }
            
            return rows;
        }

        // ฟังก์ชันสำหรับกรองข้อมูลตามปี
        function filterDataByYear(data, year) {
            return data.filter(row => {
                const yearValue = row.c[41]?.v;
                return yearValue === year.toString();
            });
        }

        // ฟังก์ชันเพื่ออัปเดตกราฟและตาราง
        function updateChartAndTables(rows, selectedMonth = null, selectedStatus = null) {
            const monthOrder = ['Jan25', 'Feb25', 'Mar25', 'Apr25', 'May25', 'Jun25'];
            const statusList = ["ขึ้นทะเบียนเรียบร้อย", "ช่างลาออก", "ตัวแทนยังไม่ส่งขึ้นทะเบียน", "ติดประวัติอาชญากรรม", "อยู่ระหว่างอบรมปฎิบัติ", "เอกสารยังไม่ครบ", "อยู่ระหว่างอบรมทฤษฎี", "ไม่ผ่านอบรม"];
            const colors = ['#006400', '#FF6B00', '#FF1493', '#4169E1', '#90EE90', '#008080', '#4CA64C', '#FF69B4'];

            let filteredRows = rows;
            if (selectedMonth) {
                filteredRows = filteredRows.filter(row => row.c[28]?.v === selectedMonth);
            }
            if (selectedStatus) {
                filteredRows = filteredRows.filter(row => row.c[34]?.v === selectedStatus);
            }

            const chartData = {
                labels: monthOrder,
                datasets: statusList.map((status, index) => ({
                    label: status,
                    data: monthOrder.map(month => {
                        return filteredRows.filter(row => row.c[28]?.v === month && row.c[34]?.v === status).length;
                    }),
                    backgroundColor: colors[index],
                    hidden: false // เริ่มต้นไม่ซ่อน จะจัดการ legend ทีหลัง
                }))
            };

            const chartCanvas = document.getElementById('myChart').getContext('2d');
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(chartCanvas, {
                type: 'bar',
                data: chartData,
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        datalabels: {
                            color: 'white',
                            anchor: 'center',
                            align: 'center',
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            },
                            font: {
                                weight: 'bold',
                                size: 14
                            }
                        },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.y;
                                    });
                                    return 'รวม: ' + sum;
                                }
                            }
                        }
                    },
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 120,
                            ticks: {
                                stepSize: 10
                            },
                            grid: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const datasetIndex = elements[0].datasetIndex;
                            const index = elements[0].index;
                            const clickedStatus = chart.data.datasets[datasetIndex].label;
                            const clickedMonth = chart.data.labels[index];
                            updateChartAndTables(filteredData2025, clickedMonth, clickedStatus);
                        } else {
                            updateChartAndTables(filteredData2025);
                        }
                    }
                },
                plugins: [ChartDataLabels, {
                    // Plugin สำหรับแสดงยอดรวมบนแท่ง เฉพาะเมื่อไม่มี legend ไหนถูกเลือก
                    afterDatasetsDraw: function(chart) {
                        if (window.selectedLegendItems && window.selectedLegendItems.size > 0) return;
                        const ctx = chart.ctx;
                        const datasets = chart.data.datasets;
                        const labels = chart.data.labels;
                        labels.forEach((label, i) => {
                            let sum = 0;
                            datasets.forEach(ds => {
                                if (!ds.hidden) sum += ds.data[i] || 0;
                            });
                            // หาตำแหน่ง y สูงสุดของแท่ง
                            let meta = null;
                            for (let d = datasets.length - 1; d >= 0; d--) {
                                if (!datasets[d].hidden && datasets[d].data[i] > 0) {
                                    meta = chart.getDatasetMeta(d);
                                    break;
                                }
                            }
                            if (meta && meta.data[i]) {
                                const x = meta.data[i].x;
                                const y = meta.data[i].y - 10;
                                ctx.save();
                                ctx.font = 'bold 16px Arial';
                                ctx.fillStyle = '#000';
                                ctx.textAlign = 'center';
                                ctx.fillText(sum, x, y);
                                ctx.restore();
                            }
                        });
                    }
                }]
            });

            // อัพเดทเฉพาะตาราง Pivot ไม่กระทบตารางหลัก
            updatePivotTable(filteredRows);

            // เรียกใช้ฟังก์ชันจัดการ Legend
            initializeLegendHandlers();

            // อัพเดทการ์ดข้อมูล
            const totalTechnicianCount = countTotalTechnicians(filteredData2025);
            document.getElementById('total-technician-count').textContent = totalTechnicianCount + ' คน';

            const newTechnicianCount = countNewTechnicians(filteredData2025);
            const percentage = ((newTechnicianCount / totalTechnicianCount) * 100).toFixed(2);
            document.getElementById('new-technician-count').textContent = `${newTechnicianCount} คน (${percentage}%)`;

            const averageSLA = calculateAverageSLA(filteredData2025);
            document.getElementById('sla-value').textContent = averageSLA + ' วัน';

            // อัพเดทการ์ดสถานะต่างๆ
            updateStatusCards(filteredData2025);
        }

        // ฟังก์ชันคำนวณค่าเฉลี่ย SLA
        function calculateAverageSLA(rows) {
            let count = 0;
            let totalSLA = 0;
            
            // ดึงค่า SLA จากทุกแถวที่มีสถานะ "ขึ้นทะเบียนเรียบร้อย"
            rows.forEach(row => {
                if (row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย") {
                    const sla = parseFloat(row.c[37]?.v) || 0;
                    if (sla > 0) {
                        totalSLA += sla;
                        count++;
                    }
                }
            });
            
            // คำนวณค่าเฉลี่ยและคืนค่า ปัดขึ้นเป็นจำนวนเต็ม
            return count > 0 ? Math.ceil(totalSLA / count) : '-';
        }

        // ฟังก์ชันคำนวณค่าเฉลี่ย SLA สำหรับสถานะเฉพาะ
        function calculateStatusSLA(rows, status) {
            let count = 0;
            let totalSLA = 0;
            
            // ดึงค่า SLA จากทุกแถวที่มีสถานะตามที่ระบุ
            rows.forEach(row => {
                if (row.c[34]?.v === status) {
                    const sla = parseFloat(row.c[37]?.v) || 0;
                    if (sla > 0) {
                        totalSLA += sla;
                        count++;
                    }
                }
            });
            
            return {
                average: count > 0 ? Math.ceil(totalSLA / count) : '-',
                count: count
            };
        }

        // ฟังก์ชันนับจำนวนช่างใหม่
        function countNewTechnicians(rows) {
            let count = 0;
            rows.forEach(row => {
                if (row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย") {
                    count++;
                }
            });
            return count;
        }

        // Function to search table data
        function searchTableData() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!searchTerm) {
                currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
                renderTableData(window.tableData);
                return;
            }

            const filteredData = window.tableData.filter(row => {
                return Object.values(row).some(value => {
                    if (value === null || value === undefined) return false;
                    return value.toString().toLowerCase().includes(searchTerm);
                });
            });

            currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
            renderTableData(filteredData);
        }

        // ฟังก์ชันกรองข้อมูลตามเดือน
        function filterTableByMonth(monthName) {
            if (!window.originalTableData) {
                // สำรองข้อมูลต้นฉบับหากยังไม่มี
                window.originalTableData = window.tableData ? [...window.tableData] : [];
            }
            
            if (monthName === 'all') {
                // กลับไปดูข้อมูลทั้งหมดโดยใช้ฟังก์ชันรีเซ็ต
                resetTableData();
                return;
            }
            
            // กรองข้อมูลตามเดือนที่เลือก
            const filteredData = window.originalTableData.filter(row => {
                // ตรวจสอบค่าในคอลัมน์เดือนอบรม
                // เนื่องจากเดือนอบรมอยู่ในรูปแบบ 'Jan25', 'Feb25', ฯลฯ
                // เราต้องตรวจสอบเฉพาะส่วนต้นของสตริงว่าเริ่มต้นด้วยเดือนที่เลือกหรือไม่
                return row.trainingMonth && row.trainingMonth.startsWith(monthName);
            });
            
            // แสดงข้อมูลทั้งหมดของเดือนที่เลือกโดยไม่มีการแบ่งหน้า
            renderAllMonthData(filteredData);
        }
        
        // ฟังก์ชันแสดงข้อมูลทั้งหมดของเดือนที่เลือก
        function renderAllMonthData(data) {
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            
            // แสดงข้อมูลทั้งหมดโดยไม่มีการแบ่งหน้า
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // ซ่อนตัวควบคุมการแบ่งหน้า
            const paginationContainer = document.querySelector('.pagination-container');
            paginationContainer.style.display = 'none';
            
            // แสดงข้อความแสดงจำนวนข้อมูลที่กรองออก
            const dataCountInfo = document.createElement('div');
            dataCountInfo.id = 'data-count-info';
            dataCountInfo.style.textAlign = 'right';
            dataCountInfo.style.marginTop = '10px';
            dataCountInfo.style.fontSize = '14px';
            dataCountInfo.style.color = '#666';
            dataCountInfo.textContent = `แสดงข้อมูลทั้งหมด ${data.length} รายการ`;
            
            // ลบข้อความเดิมถ้ามี
            const existingInfo = document.getElementById('data-count-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // แทรกข้อความใหม่หลังตาราง
            const dataTable = document.getElementById('data-table');
            dataTable.parentNode.insertBefore(dataCountInfo, dataTable.nextSibling);
        }

        // เพิ่ม event listener ให้ปุ่ม
        document.addEventListener('DOMContentLoaded', function() {
            // ลบ event listeners เดิมที่อาจมีอยู่
            const searchButton = document.getElementById('search-button');
            const searchInput = document.getElementById('search-input');
            const searchForm = document.querySelector('.search-container');

            // ลบ event listener เดิมและเพิ่มใหม่
            searchButton.replaceWith(searchButton.cloneNode(true));
            const newSearchButton = document.getElementById('search-button');
            
            // เพิ่ม event listener ใหม่
            newSearchButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                searchTableData();
            });

            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                searchTableData();
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchTableData();
                }
            });

            document.getElementById('reset-filter-button').addEventListener('click', function() {
                resetTableData();
            });

            document.getElementById('refresh-button').addEventListener('click', function() {
                // อัปเดตทั้งตารางหลักและกราฟ
                fetchDataAndUpdateTable();
            });
            
            document.getElementById('download-button').addEventListener('click', downloadTableAsExcel);
            
            // Event Listeners สำหรับปุ่มแบ่งหน้า
            document.getElementById('prev-button').addEventListener('click', function() {
                if (currentPage > 1) {
                    goToPage(currentPage - 1);
                }
            });
            
            document.getElementById('next-button').addEventListener('click', function() {
                if (currentPage < totalPages) {
                    goToPage(currentPage + 1);
                }
            });
            
            // Event Listener สำหรับเลือกขนาดหน้า
            document.getElementById('page-size').addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
                renderTableData(window.tableData);
            });

            // เพิ่มการจัดการการเลือกข้อความในตาราง
            const dataTable = document.getElementById('data-table');
            if (dataTable) {
                dataTable.addEventListener('mousedown', function(e) {
                    if (e.target.tagName === 'TD') {
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(e.target);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });

                // ป้องกันการเลือกข้อความถูกยกเลิกเมื่อลากเมาส์
                dataTable.addEventListener('selectstart', function(e) {
                    if (e.target.tagName === 'TD') {
                        e.preventDefault();
                    }
                });
            }
            
            // เพิ่ม Event Listener สำหรับปุ่มเดือน
            const monthCards = document.querySelectorAll('.month-card');
            monthCards.forEach(card => {
                card.addEventListener('click', function() {
                    const selectedMonth = this.getAttribute('data-month');
                    filterTableByMonth(selectedMonth);
                    
                    // ไฮไลต์ปุ่มที่เลือก
                    monthCards.forEach(c => {
                        c.style.backgroundColor = '#f0f0f0';
                        c.style.color = 'black';
                    });
                    this.style.backgroundColor = '#003366';
                    this.style.color = 'white';
                });
            });
        });

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        updateCurrentDateTime();

        // ดึงข้อมูลครั้งแรกเมื่อโหลดหน้าเว็บ
        fetchDataAndUpdateTable();

        // ฟังก์ชันนับจำนวนช่างทั้งหมด
        function countTotalTechnicians(rows) {
            return rows.length;
        }

        // ฟังก์ชันตรวจสอบสถานะทั้งหมดที่มีในข้อมูล
        function getAllUniqueStatuses(rows) {
            const statuses = new Set();
            rows.forEach(row => {
                const status = row.c[34]?.v; // คอลัมน์ "Status ล่าสุด"
                if (status && status.trim()) {
                    statuses.add(status.trim());
                }
            });
            return Array.from(statuses).sort();
        }

        // ฟังก์ชันตรวจสอบว่าการ์ดครบหรือไม่
        function validateStatusCards(rows) {
            const allStatuses = getAllUniqueStatuses(rows);
            const cardStatuses = [
                'เอกสารยังไม่ครบ',
                'ไม่เข้าอบรม',
                'ไม่ผ่านอบรม',
                'ช่างลาออก',
                'ตัวแทนยังไม่ส่งขึ้นทะเบียน',
                'ติดประวัติอาชญากรรม',
                'อยู่ระหว่างอบรมทฤษฎี',
                'อยู่ระหว่างอบรมปฎิบัติ'
            ];
            
            // ตรวจสอบสถานะที่ขาดหายไป
            const missingStatuses = allStatuses.filter(status => !cardStatuses.includes(status));
            
            if (missingStatuses.length > 0) {
                console.warn('สถานะที่ขาดหายไปจากการ์ด:', missingStatuses);
            } else {
                console.log('การ์ดสถานะครบถ้วนแล้ว');
            }
            
            console.log('สถานะทั้งหมดในข้อมูล:', allStatuses);
            return { allStatuses, missingStatuses };
        }

        // ฟังก์ชันอัพเดทการ์ดสถานะต่างๆ
        function updateStatusCards(rows) {
            // ตรวจสอบสถานะก่อนอัปเดต
            validateStatusCards(rows);
            
            const statuses = [
                { id: 'sla-incomplete-docs', status: 'เอกสารยังไม่ครบ' },
                { id: 'sla-not-attend', status: 'ไม่เข้าอบรม' },
                { id: 'sla-failed-training', status: 'ไม่ผ่านอบรม' },
                { id: 'sla-resigned', status: 'ช่างลาออก' },
                { id: 'sla-not-submitted', status: 'ตัวแทนยังไม่ส่งขึ้นทะเบียน' },
                { id: 'sla-criminal-record', status: 'ติดประวัติอาชญากรรม' },
                { id: 'sla-theory-training', status: 'อยู่ระหว่างอบรมทฤษฎี' },
                { id: 'sla-practical-training', status: 'อยู่ระหว่างอบรมปฎิบัติ' }
            ];

            statuses.forEach(item => {
                const result = calculateStatusSLA(rows, item.status);
                const element = document.getElementById(item.id);
                if (element) {
                    // แสดงทั้งจำนวนคนและ SLA เฉลี่ย
                    if (result.count > 0 && result.average !== '-') {
                        element.textContent = `${result.count} คน (${result.average} วัน)`;
                    } else if (result.count > 0) {
                        element.textContent = `${result.count} คน`;
                    } else {
                        element.textContent = '0 คน';
                    }
                }
            });
            
            // อัปเดต SLA Analysis
            updateSLAAnalysis(rows);
        }

        // ฟังก์ชันใหม่สำหรับการวิเคราะห์ SLA อย่างละเอียด
        function updateSLAAnalysis(rows) {
            // คำนวณ SLA เฉลี่ยสำหรับผู้ที่ขึ้นทะเบียนสำเร็จ
            const successRows = rows.filter(row => row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย");
            let successSLATotal = 0;
            let successCount = 0;
            
            successRows.forEach(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                if (sla > 0) {
                    successSLATotal += sla;
                    successCount++;
                }
            });
            
            const avgSuccessSLA = successCount > 0 ? Math.ceil(successSLATotal / successCount) : 0;
            
            // คำนวณ SLA เฉลี่ยทั้งหมด
            let totalSLA = 0;
            let totalCount = 0;
            
            rows.forEach(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                if (sla > 0) {
                    totalSLA += sla;
                    totalCount++;
                }
            });
            
            const avgTotalSLA = totalCount > 0 ? Math.ceil(totalSLA / totalCount) : 0;
            
            // อัปเดตการ์ด SLA
            document.getElementById('sla-success-avg').textContent = avgSuccessSLA > 0 ? `${avgSuccessSLA} วัน` : '-';
            document.getElementById('sla-overall-avg').textContent = avgTotalSLA > 0 ? `${avgTotalSLA} วัน` : '-';
            
            // ประเมินสถานะ SLA
            let slaStatus = '';
            let slaStatusColor = '';
            if (avgSuccessSLA <= 30) {
                slaStatus = 'ดีเยี่ยม';
                slaStatusColor = '#28a745';
            } else if (avgSuccessSLA <= 45) {
                slaStatus = 'ปานกลาง';
                slaStatusColor = '#ffc107';
            } else {
                slaStatus = 'ต้องปรับปรุง';
                slaStatusColor = '#dc3545';
            }
            
            const slaStatusElement = document.getElementById('sla-status');
            if (slaStatusElement) {
                slaStatusElement.textContent = slaStatus;
                slaStatusElement.parentElement.parentElement.style.backgroundColor = slaStatusColor;
            }
            
            // สร้างตาราง SLA Analysis
            createSLAAnalysisTable(rows);
            
            // อัปเดตตัวชี้วัดประสิทธิภาพ
            updateSLAPerformanceIndicators(rows);
        }

        // ฟังก์ชันสร้างตาราง SLA Analysis
        function createSLAAnalysisTable(rows) {
            const statusList = [
                "ขึ้นทะเบียนเรียบร้อย",
                "ช่างลาออก", 
                "ตัวแทนยังไม่ส่งขึ้นทะเบียน",
                "ติดประวัติอาชญากรรม",
                "อยู่ระหว่างอบรมปฎิบัติ",
                "เอกสารยังไม่ครบ",
                "อยู่ระหว่างอบรมทฤษฎี",
                "ไม่ผ่านอบรม"
            ];
            
            const tbody = document.getElementById('sla-analysis-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            statusList.forEach(status => {
                const statusRows = rows.filter(row => row.c[34]?.v === status);
                const slaValues = statusRows.map(row => parseFloat(row.c[37]?.v) || 0).filter(sla => sla > 0);
                
                if (statusRows.length > 0) {
                    const avgSLA = slaValues.length > 0 ? Math.ceil(slaValues.reduce((a, b) => a + b, 0) / slaValues.length) : 0;
                    const maxSLA = slaValues.length > 0 ? Math.max(...slaValues) : 0;
                    const minSLA = slaValues.length > 0 ? Math.min(...slaValues) : 0;
                    
                    let assessment = '';
                    let assessmentColor = '';
                    
                    if (status === "ขึ้นทะเบียนเรียบร้อย") {
                        if (avgSLA <= 30) {
                            assessment = 'ดีเยี่ยม';
                            assessmentColor = '#28a745';
                        } else if (avgSLA <= 45) {
                            assessment = 'ปานกลาง';
                            assessmentColor = '#ffc107';
                        } else {
                            assessment = 'ต้องปรับปรุง';
                            assessmentColor = '#dc3545';
                        }
                    } else {
                        assessment = 'ต้องติดตาม';
                        assessmentColor = '#6c757d';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 8px; border: 1px solid #ddd;">${status}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${statusRows.length}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${avgSLA > 0 ? avgSLA : '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${maxSLA > 0 ? Math.ceil(maxSLA) : '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${minSLA > 0 ? Math.ceil(minSLA) : '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background-color: ${assessmentColor}; color: white; font-weight: bold;">${assessment}</td>
                    `;
                    
                    tbody.appendChild(row);
                }
            });
        }

        // ฟังก์ชันอัปเดตตัวชี้วัดประสิทธิภาพ SLA
        function updateSLAPerformanceIndicators(rows) {
            const successRows = rows.filter(row => row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย");
            const totalRows = rows.filter(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                return sla > 0;
            });
            
            // คำนวณเปอร์เซ็นต์ขึ้นทะเบียนตรงเวลา (SLA <= 30 วัน)
            const onTimeCount = successRows.filter(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                return sla > 0 && sla <= 30;
            }).length;
            
            const onTimePercentage = successRows.length > 0 ? ((onTimeCount / successRows.length) * 100).toFixed(1) : 0;
            
            // คำนวณเปอร์เซ็นต์เกินกำหนด SLA (SLA > 30 วัน)
            const overdueCount = totalRows.filter(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                return sla > 30;
            }).length;
            
            const overduePercentage = totalRows.length > 0 ? ((overdueCount / totalRows.length) * 100).toFixed(1) : 0;
            
            // นับกรณีที่ต้องติดตาม (สถานะที่ไม่ใช่ขึ้นทะเบียนเรียบร้อย)
            const followUpCount = rows.filter(row => {
                const status = row.c[34]?.v;
                return status && status !== "ขึ้นทะเบียนเรียบร้อย" && status !== "ช่างลาออก";
            }).length;
            
            // อัปเดตค่าในการ์ด
            document.getElementById('sla-ontime-percentage').textContent = `${onTimePercentage}%`;
            document.getElementById('sla-overdue-percentage').textContent = `${overduePercentage}%`;
            document.getElementById('sla-followup-count').textContent = `${followUpCount} คน`;
        }

        // ฟังก์ชันเพื่ออัปเดต Line Chart
        function updateLineChart(rows) {
            const monthOrder = ['Jan25', 'Feb25', 'Mar25', 'Apr25', 'May25', 'Jun25'];
            const lineChartCanvas = document.getElementById('lineChart').getContext('2d');

            const lineChartData = {
                labels: monthOrder,
                datasets: [{
                    label: 'จำนวนการขึ้นทะเบียนช่างใหม่',
                    data: monthOrder.map(month => {
                        return rows.filter(row => row.c[28]?.v === month && row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย").length;
                    }),
                    backgroundColor: '#006400',
                    borderColor: '#006400',
                    fill: true
                }]
            };

            if (lineChart) {
                lineChart.destroy();
            }

            lineChart = new Chart(lineChartCanvas, {
                type: 'bar',
                data: lineChartData,
                options: {
                    responsive: true,
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return value === 0 ? '' : Math.round(value);
                            },
                            font: {
                                weight: 'bold',
                                size: 14
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 120,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // เพิ่มฟังก์ชันสำหรับจัดการ Legend
        function initializeLegendHandlers() {
            const legendItems = document.querySelectorAll('.legend-item');
            if (!chart || !chart.data || legendItems.length === 0) {
                return; // ถ้าไม่มีกราฟหรือ legend items ให้ข้ามไป
            }
            
            const datasets = chart.data.datasets;
            let selectedItems = window.selectedLegendItems || new Set();
            window.selectedLegendItems = selectedItems;
            
            // เพิ่ม event listener สำหรับคลิกพื้นที่ว่าง
            document.addEventListener('click', (event) => {
                // ตรวจสอบว่าคลิกที่ legend-item หรือไม่
                const clickedLegend = event.target.closest('.legend-item');
                const clickedChart = event.target.closest('canvas');
                
                // ถ้าไม่ได้คลิกที่ legend-item และไม่ได้คลิกที่กราฟ ให้แสดงทุกรายการ
                if (!clickedLegend && !clickedChart) {
                    selectedItems.clear();
                    legendItems.forEach((item, i) => {
                        item.classList.remove('selected');
                        if (datasets[i]) datasets[i].hidden = false;
                    });
                    if (chart) chart.update();
                    // อัพเดทเฉพาะแผนภูมิและตาราง pivot โดยไม่กระทบตารางหลัก
                    updatePivotTable(filteredData2025);
                }
            });

            // จัดการการคลิกที่ Legend items
            legendItems.forEach((item, index) => {
                item.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (event.ctrlKey || event.metaKey) {
                        if (selectedItems.has(index)) {
                            selectedItems.delete(index);
                            item.classList.remove('selected');
                        } else {
                            selectedItems.add(index);
                            item.classList.add('selected');
                        }
                    } else {
                        selectedItems.clear();
                        selectedItems.add(index);
                        legendItems.forEach((otherItem, i) => {
                            if (i === index) {
                                otherItem.classList.add('selected');
                            } else {
                                otherItem.classList.remove('selected');
                            }
                        });
                    }
                    window.selectedLegendItems = selectedItems;
                    // อัพเดทการแสดงผลกราฟ
                    datasets.forEach((dataset, i) => {
                        if (selectedItems.size === 0) {
                            // ถ้าไม่มีรายการที่ถูกเลือก แสดงทุกรายการ
                            dataset.hidden = false;
                        } else {
                            // ซ่อนรายการที่ไม่ได้เลือก
                            dataset.hidden = !selectedItems.has(i);
                        }
                    });

                    if (chart) chart.update();
                    
                    // อัพเดทเฉพาะตาราง pivot ไม่กระทบตารางหลัก
                    const selectedStatuses = Array.from(selectedItems).map(i => datasets[i].label);
                    const filteredRows = filteredData2025.filter(row => {
                        if (selectedItems.size === 0) {
                            return true; // แสดงข้อมูลทั้งหมด
                        } else {
                            return selectedStatuses.includes(row.c[34]?.v);
                        }
                    });
                    
                    // อัพเดทเฉพาะตาราง pivot โดยไม่เรียก updateTables
                    updatePivotTable(filteredRows);
                });
            });
        }

        // ฟังก์ชันเพื่อดาวน์โหลดตารางเป็น Excel
        function downloadTableAsExcel() {
            if (!window.XLSX) {
                alert('ไม่สามารถโหลด Excel library ได้ กรุณาลองใหม่อีกครั้ง');
                return;
            }

            // สร้างตาราง HTML ชั่วคราวที่มีข้อมูลทั้งหมด
            const tempTable = document.createElement('table');
            
            // คัดลอกส่วนหัวตาราง
            const headerRow = document.createElement('tr');
            const headers = document.querySelectorAll('#data-table th');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.textContent;
                headerRow.appendChild(th);
            });
            
            const thead = document.createElement('thead');
            thead.appendChild(headerRow);
            tempTable.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            
            if (window.tableData) {
                window.tableData.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.values(row).forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            }
            
            tempTable.appendChild(tbody);
            
            try {
                const workbook = XLSX.utils.table_to_book(tempTable, { sheet: "ข้อมูลการอบรมช่าง" });
                const now = new Date();
                const datePart = now.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\//g, '-');
                
                const filename = `ข้อมูลการอบรมช่าง_${datePart}.xlsx`;
                XLSX.writeFile(workbook, filename);
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการสร้างไฟล์ Excel:', error);
                alert('เกิดข้อผิดพลาดในการดาวน์โหลดไฟล์');
            }
        }

        // ฟังก์ชันแสดงข้อมูลในตาราง
        function renderTableData(data) {
            if (!data || data.length === 0) {
                console.warn("ไม่มีข้อมูลที่จะแสดง");
                return;
            }
            
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            
            // คำนวณข้อมูลสำหรับการแสดงหน้าปัจจุบัน
            totalPages = Math.ceil(data.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, data.length);
            const currentPageData = data.slice(startIndex, endIndex);
            
            // แสดงข้อมูลในตาราง
            currentPageData.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // แสดงตัวควบคุมการแบ่งหน้า
            const paginationContainer = document.querySelector('.pagination-container');
            if (paginationContainer) {
                paginationContainer.style.display = 'flex';
            }
            
            // ลบข้อความแสดงจำนวนข้อมูลที่กรองออก
            const existingInfo = document.getElementById('data-count-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // อัปเดตข้อมูลการแบ่งหน้า
            updatePagination(data.length);
        }
        
        // ฟังก์ชันอัปเดตข้อมูลการแบ่งหน้า
        function updatePagination(totalItems) {
            if (!totalItems || totalItems === 0) {
                console.warn("ไม่มีข้อมูลสำหรับการแบ่งหน้า");
                return;
            }
            
            // คำนวณจำนวนหน้าทั้งหมด
            totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
            
            // ปรับปรุงหน้าปัจจุบันไม่ให้เกินจำนวนหน้าทั้งหมด
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            
            const paginationInfo = document.getElementById('pagination-info');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const paginationPages = document.getElementById('pagination-pages');
            
            // อัปเดตข้อมูลหน้า
            paginationInfo.textContent = `หน้า ${currentPage} จาก ${totalPages} (รายการทั้งหมด ${totalItems})`;
            
            // อัปเดตสถานะปุ่ม
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
            
            // สร้างปุ่มหมายเลขหน้า
            paginationPages.innerHTML = '';
            
            // กำหนดจำนวนปุ่มหน้าที่จะแสดง
            const maxPageButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
            
            // ปรับค่า startPage เมื่อ endPage อยู่ที่ค่าสูงสุด
            if (endPage === totalPages) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }
            
            // แสดงปุ่มหมายเลขหน้าแรกถ้าต้องการ
            if (startPage > 1) {
                const firstPageButton = createPageButton(1);
                paginationPages.appendChild(firstPageButton);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('div');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    paginationPages.appendChild(ellipsis);
                }
            }
            
            // สร้างปุ่มหมายเลขหน้า
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = createPageButton(i);
                paginationPages.appendChild(pageButton);
            }
            
            // แสดงปุ่มหน้าสุดท้ายถ้าต้องการ
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('div');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    paginationPages.appendChild(ellipsis);
                }
                
                const lastPageButton = createPageButton(totalPages);
                paginationPages.appendChild(lastPageButton);
            }
        }
        
        // ฟังก์ชันสร้างปุ่มหมายเลขหน้า
        function createPageButton(pageNumber) {
            const pageButton = document.createElement('div');
            pageButton.className = 'page-number' + (pageNumber === currentPage ? ' active' : '');
            pageButton.textContent = pageNumber;
            pageButton.addEventListener('click', () => goToPage(pageNumber));
            return pageButton;
        }
        
        // ฟังก์ชันเปลี่ยนหน้า
        function goToPage(page) {
            currentPage = page;
            renderTableData(window.tableData);
        }

        // ตัวแปรเก็บสถานะการ sort
        let currentSort = {
            key: null,
            isAsc: true
        };

        // ฟังก์ชันจัดการการ sort
        function handleSort(key) {
            const isAsc = currentSort.key === key ? !currentSort.isAsc : true;
            currentSort = { key, isAsc };

            const sortedData = sortData(window.tableData, key, isAsc);
            renderTableData(sortedData);
            updateSortIndicators(key, isAsc);
        }

        // ฟังก์ชัน sort ข้อมูล
        function sortData(data, key, isAsc) {
            return [...data].sort((a, b) => {
                let valueA = a[key];
                let valueB = b[key];

                // จัดการค่าว่าง
                if (!valueA && valueA !== 0) return isAsc ? 1 : -1;
                if (!valueB && valueB !== 0) return isAsc ? -1 : 1;

                // จัดการข้อมูลตามประเภท
                if (key === 'week') {
                    valueA = parseInt(valueA.replace(/\D/g, '')) || 0;
                    valueB = parseInt(valueB.replace(/\D/g, '')) || 0;
                } else if (key === 'trainingMonth') {
                    const months = {
                        'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4,
                        'May': 5, 'Jun': 6, 'Jul': 7, 'Aug': 8,
                        'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
                    };
                    valueA = months[valueA.substring(0, 3)] || 0;
                    valueB = months[valueB.substring(0, 3)] || 0;
                } else if (key === 'startDate' || key === 'endDate') {
                    const parseDate = (str) => {
                        const [day, month, year] = (str || '').split('/').map(Number);
                        return day ? new Date(year, month - 1, day) : new Date(0);
                    };
                    valueA = parseDate(valueA);
                    valueB = parseDate(valueB);
                } else if (key === 'sla') {
                    valueA = parseFloat(valueA) || 0;
                    valueB = parseFloat(valueB) || 0;
                }

                // เปรียบเทียบค่า
                if (valueA instanceof Date) {
                    return isAsc ? valueA - valueB : valueB - valueA;
                }
                if (typeof valueA === 'number') {
                    return isAsc ? valueA - valueB : valueB - valueA;
                }
                return isAsc ? 
                    String(valueA).localeCompare(String(valueB), 'th') : 
                    String(valueB).localeCompare(String(valueA), 'th');
            });
        }

        // ฟังก์ชันอัปเดตไอคอน sort
        function updateSortIndicators(key, isAsc) {
            const headers = document.querySelectorAll('#data-table th');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.key === key) {
                    header.classList.add(isAsc ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // ฟังก์ชันแสดงข้อมูลในตาราง Pivot
        function updatePivotTable(rows) {
            const pivotHeader = document.getElementById('pivot-header');
            const pivotBody = document.getElementById('pivot-body');
            
            // กำหนดหัวข้อคอลัมน์
            const columns = [
                "ขึ้นทะเบียนเรียบร้อย",
                "ช่างลาออก",
                "ตัวแทนยังไม่ส่งขึ้นทะเบียน",
                "ติดประวัติอาชญากรรม",
                "อยู่ระหว่างอบรมปฎิบัติ",
                "เอกสารยังไม่ครบ",
                "อยู่ระหว่างอบรมทฤษฎี",
                "ไม่ผ่านอบรม",
                "Grand Total"
            ];

            // เฉพาะเดือนปัจจุบัน (Jun25)
            const currentMonth = 'Jun25';
            
            // อัพเดทชื่อตาราง
            document.getElementById('pivot-table-title').textContent = `สถานะการอบรมช่างใหม่รายพื้นที่ June 2025`;
            
            // สร้างส่วนหัวตาราง
            pivotHeader.innerHTML = `
                <th>พื้นที่</th>
                ${columns.map(col => `<th>${col}</th>`).join('')}
            `;

            // เตรียมข้อมูลสำหรับตาราง
            const areas = [
                "RSM1_BMA-West", "RSM2_BMA-East", "RSM3_UPC-East", "RSM4_UPC-NOR",
                "RSM5_UPC-NOE1", "RSM6_UPC-NOE2", "RSM7_UPC-CEW", "RSM8_UPC-SOU"
            ];

            let tableHTML = '';
            let finalGrandTotal = new Array(columns.length).fill(0);

            // สร้างข้อมูลตาราง
            areas.forEach(area => {
                const areaData = rows.filter(row => 
                    row.c[26]?.v === area && row.c[28]?.v === currentMonth
                );

                if (areaData.length > 0) {
                    const rowData = [
                        areaData.filter(row => row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย").length,
                        areaData.filter(row => row.c[34]?.v === "ช่างลาออก").length,
                        areaData.filter(row => row.c[34]?.v === "ตัวแทนยังไม่ส่งขึ้นทะเบียน").length,
                        areaData.filter(row => row.c[34]?.v === "ติดประวัติอาชญากรรม").length,
                        areaData.filter(row => row.c[34]?.v === "อยู่ระหว่างอบรมปฎิบัติ").length,
                        areaData.filter(row => row.c[34]?.v === "เอกสารยังไม่ครบ").length,
                        areaData.filter(row => row.c[34]?.v === "อยู่ระหว่างอบรมทฤษฎี").length,
                        areaData.filter(row => row.c[34]?.v === "ไม่ผ่านอบรม").length
                    ];

                    const areaTotal = rowData.reduce((a, b) => a + b, 0);
                    rowData.push(areaTotal);

                    tableHTML += `
                        <tr>
                            <td>${area}</td>
                            ${rowData.map(val => `<td>${val || ''}</td>`).join('')}
                        </tr>
                    `;

                    rowData.forEach((val, idx) => {
                        finalGrandTotal[idx] += val;
                    });
                }
            });

            tableHTML += `
                <tr class="grand-total">
                    <td>Grand Total</td>
                    ${finalGrandTotal.map(val => `<td>${val || ''}</td>`).join('')}
                </tr>
            `;

            pivotBody.innerHTML = tableHTML;
        }

        function resetTableData() {
            if (!window.originalTableData) return;
            
            window.tableData = [...window.originalTableData];
            currentPage = 1;
            
            const paginationContainer = document.querySelector('.pagination-container');
            if (paginationContainer) {
                paginationContainer.style.display = 'flex';
            }
            
            const existingInfo = document.getElementById('data-count-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            const monthCards = document.querySelectorAll('.month-card');
            monthCards.forEach(card => {
                card.style.backgroundColor = '#f0f0f0';
                card.style.color = 'black';
            });
            
            const allButton = document.querySelector('.month-card[data-month="all"]');
            if (allButton) {
                allButton.style.backgroundColor = '#003366';
                allButton.style.color = 'white';
            }
            
            renderTableData(window.originalTableData);
        }

    </script>
</body>
</html>