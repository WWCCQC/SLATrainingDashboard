<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ด</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
        }
        th {
            background-color: #003366;
            color: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            font-weight: bold;
        }
        th:hover {
            background-color: #004080;
        }
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        th.sort-asc::after {
            border-bottom: 5px solid #fff;
            margin-top: -2.5px;
        }
        th.sort-desc::after {
            border-top: 5px solid #fff;
            margin-top: 2.5px;
        }
        /* ปรับแต่งไอคอน sort */
        th::before,
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.7;
        }
        th::before {
            top: 40%;
            border-bottom: 5px solid #fff;
        }
        th::after {
            top: 55%;
            border-top: 5px solid #fff;
        }
        /* ไอคอนเมื่อ active */
        th.sort-asc::before {
            opacity: 1;
            border-bottom-color: #fff;
        }
        th.sort-desc::after {
            opacity: 1;
            border-top-color: #fff;
        }
        /* เมื่อ hover ทำให้ไอคอนเด่นขึ้น */
        th:hover::before,
        th:hover::after {
            opacity: 0.9;
        }
        .pivot-table th {
            background-color: #f4f4f4;
            color: #333;
            font-weight: normal;
        }
        .pivot-table th:first-child {
            background-color: #f4f4f4;
            color: #333;
        }
        .grand-total th, .grand-total td {
            background-color: #b7e1cd;
            color: #333;
        }
        .pivot-table th, .pivot-table td {
            background-color: #e6f3ff;
        }
        .pivot-table th:first-child, .pivot-table td:first-child {
            background-color: #d9ead3;
        }
        .area-total {
            color: #006400; /* สีเขียวเข้ม */
        }
        canvas {
            margin-top: 20px;
            max-width: 800px; /* เพิ่มขนาดกราฟ */
            max-height: 400px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .controls button {
            margin-right: 10px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 25px;
            text-align: center;
            margin: 0;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-icon {
            width: 48px;
            height: 48px;
            color: #006400;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .card-content {
            flex-grow: 1;
        }
        .card-title {
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
            text-align: left;
        }
        .card-value {
            color: #006400;
            font-size: 20px;
            font-weight: bold;
            text-align: left;
        }
        #chart-container {
            margin-left: 0px;
            padding-left: 220px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 5px; /* ลดจาก 15px เป็น 5px */
            width: calc(100% - 220px);
            margin-bottom: 0px; /* ลบ margin-bottom */
        }
        
        /* Responsive design สำหรับกราฟ */
        @media (max-width: 1200px) {
            #chart-container {
                margin-left: 0;
                padding-left: 220px;
                width: calc(100% - 220px);
            }
        }
        
        /* ให้แน่ใจว่า body และ parent containers ไม่ซ่อน legend */
        body {
            overflow-x: visible;
        }
        
        .main-page {
            overflow: visible;
        }
        .chart-wrapper {
            flex: 1;
            min-width: 0;
            position: relative;
            overflow: visible;
        }
        .total-display {
            position: absolute;
            top: -30px;
            right: 0;
            font-size: 16px;
            font-weight: bold;
            color: #006400;
        }
        #chart-label {
            position: absolute;
            top: -20px; /* ปรับตำแหน่งตามความเหมาะสม */
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
        }
        canvas#myChart {
            height: 500px !important; /* เพิ่มความสูงของกราฟ */
            max-height: 500px !important;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 25px;
            text-align: center;
            margin: 0;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-content {
            flex: 1;
        }
        .card-icon {
            width: 48px;
            height: 48px;
            color: #006400;
        }
        .card-title {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .card-value {
            color: #006400;
            font-size: 24px;
            font-weight: bold;
        }
        /* สไตล์สำหรับตารางหลัก */
        #data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        #data-table th, #data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
            background-color: white;
            position: relative;
        }
        #data-table tbody tr td {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
        }
        #data-table th {
            background-color: #003366;
            color: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            font-weight: bold;
        }
        #data-table th:hover {
            background-color: #004080;
        }
        /* ไอคอน sort สำหรับตารางหลัก */
        #data-table th::before,
        #data-table th::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.7;
        }
        #data-table th::before {
            top: 40%;
            border-bottom: 5px solid #fff;
        }
        #data-table th::after {
            top: 55%;
            border-top: 5px solid #fff;
        }
        #data-table th.sort-asc::before {
            opacity: 1;
        }
        #data-table th.sort-desc::after {
            opacity: 1;
        }
        #data-table th:hover::before,
        #data-table th:hover::after {
            opacity: 0.9;
        }
        .table-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .table-header-container h2 {
            margin: 0;
        }
        .table-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .search-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        .search-input:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.1);
        }
        .table-buttons button {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .table-buttons button:hover {
            background-color: #f0f0f0;
        }
        .table-buttons button svg {
            width: 16px;
            height: 16px;
                }
        .legend-container {
            position: absolute;
            left: -190px;
            top: 50%;
            transform: translateY(-50%);
            display: flex !important;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 180px;
            z-index: 1000;
        }
        .legend-item {
            display: flex !important;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        /* Force legend visibility สำหรับกราฟหลัก */
        #chart-container .chart-wrapper:first-child .legend-container {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        /* Force legend visibility สำหรับกราฟ Daily - จัดแนวตั้ง */
        #chart-container .chart-wrapper:last-child .legend-container {
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* ปรับแต่งกราฟ Daily Chart ให้ Legend อยู่ข้างๆ กราฟ */
        #chart-container .chart-wrapper:last-child {
            display: flex;
            flex-direction: column;
        }
        
        #chart-container .chart-wrapper:last-child h3 {
            margin-top: 0px !important;
            margin-bottom: 10px !important;
            order: -1; /* ให้ title อยู่ด้านบน */
        }
        
        /* สร้าง container ใหม่สำหรับ legend และ chart ให้อยู่แนวนอน */
        .legend-and-chart-container {
            display: flex !important;
            flex-direction: row !important;
            align-items: flex-start !important;
            gap: 20px !important;
            width: 100% !important;
        }
        
        /* ให้ canvas ขยายเต็มพื้นที่ */
        #dailyChart {
            margin-top: 0px !important;
            padding-top: 0px !important;
        }
        
        /* ปรับแต่ง chart container ให้รองรับ layout แบบ row */
        #chart-container .chart-wrapper:last-child .legend-and-chart-container > div:last-child {
            min-width: 0; /* ป้องกันการ overflow */
        }
        
        /* ปรับแต่ง legend items สำหรับ daily chart ให้เหมาะสมกับการจัดแนวตั้ง */
        #chart-container .chart-wrapper:last-child .legend-item {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .legend-item:hover {
            background-color: #f5f5f5;
        }
        .legend-item.hidden .legend-color {
            opacity: 0.5;
        }
        .legend-item.hidden span {
            color: #999;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .header-container {
            background-color: #003366;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            width: 100%;
        }
        h1 {
            color: white;
            margin: 0;
            font-size: 24px;
        }
        #current-date {
            color: white;
            font-size: 16px;
        }
        /* สไตล์สำหรับการแบ่งหน้า */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 10px 0;
        }
        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .pagination-button {
            padding: 8px 12px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .pagination-button:hover {
            background-color: #004080;
        }
        .pagination-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .pagination-info {
            font-size: 14px;
            color: #333;
            margin: 0 10px;
        }
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page-size-selector select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .page-size-selector label {
            font-size: 14px;
            color: #333;
        }
        .pagination-pages {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .page-number {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .page-number.active {
            background-color: #003366;
            color: white;
            border-color: #003366;
        }
        .page-number:hover:not(.active) {
            background-color: #f5f5f5;
        }
        .page-ellipsis {
            padding: 6px 5px;
            font-size: 14px;
            color: #333;
        }



        /* Group Code Chart Container */
        #group-code-chart-container {
            margin-left: 320px;
            position: relative;
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        #group-code-legend {
            position: absolute;
            left: -200px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 180px;
        }

        canvas#groupCodeChart, canvas#groupCodeLineChart {
            height: 500px !important;
            max-height: 500px !important;
        }

        /* Animation สำหรับ loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- เพิ่ม CSS สำหรับ Simple Navbar -->
    <style>
        .navbar {
            background: linear-gradient(135deg, #003366, #004080);
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }
        
        .navbar-brand {
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .navbar-menu {
            display: flex;
            align-items: center;
            margin-left: 15px;
            gap: 10px;
        }
        
        .nav-item {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .nav-item.active {
            background: rgba(255,255,255,0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .navbar-status {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            margin-left: auto;
        }
        
        /* Responsive navbar */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .navbar-menu {
                justify-content: center;
                margin-left: 0;
                flex-wrap: wrap;
            }
            
            .navbar-status {
                order: -1;
            }
        }
        
        /* CSS แก้ไข Daily Chart Layout - FORCE LAYOUT */
        
        /* Responsive design สำหรับกราฟ Daily */
        @media (max-width: 1000px) {
            .chart-wrapper div[style*="display: flex"] {
                flex-direction: column !important;
                align-items: center !important;
                gap: 15px !important;
            }
            
            .legend-container#daily-legend-container {
                width: auto !important;
                min-width: 300px !important;
                max-width: 100% !important;
            }
            
            #dailyChart {
                max-width: 100% !important;
                height: auto !important;
            }
        }
        
        /* สำหรับซูมมากกว่า 80% หรือหน้าจอแคบ */
        @media (max-width: 800px) {
            .chart-wrapper div[style*="display: flex"] {
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 15px !important;
                max-width: 100% !important;
                overflow-x: visible !important;
            }
            
            .legend-container#daily-legend-container {
                width: 100% !important;
                max-width: 500px !important;
                margin: 0 auto !important;
            }
            
            #dailyChart {
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
            }
        }
        .legend-and-chart-container {
            display: flex !important;
            flex-direction: row !important;
            align-items: flex-start !important;
            gap: 20px !important;
            width: 100% !important;
        }
        
        .legend-and-chart-container .legend-container {
            display: flex !important;
            flex-direction: column !important;
            width: 200px !important;
            flex-shrink: 0 !important;
            margin-right: 20px !important;
            margin-bottom: 0px !important;
        }
        
        .legend-and-chart-container > div:last-child {
            flex: 1 !important;
            min-width: 0 !important;
        }
        
        /* Force Daily Legend items เป็นแนวตั้ง */
        #daily-legend-container {
            display: flex !important;
            flex-direction: column !important;
        }
        
        #daily-legend-container .legend-item {
            display: flex !important;
            align-items: center !important;
            margin-bottom: 8px !important;
            padding: 8px 12px !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <div class="header-container">
        <h1>ข้อมูลแดชบอร์ดสถานะการอบรมช่างใหม่(2025)</h1>
        <p id="current-date"></p>
    </div>

    <!-- Simple Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-brand">📊 SLA Training Dashboard</div>
        <div class="navbar-menu">
            <a href="#" class="nav-item active" onclick="showHomePage()">
                🏠 หน้าหลัก
            </a>
            <a href="#" class="nav-item" onclick="showDailyReport()">
                📋 รายงานประจำวัน-Mockup
            </a>
        </div>
        <div class="navbar-status">
            <span id="navbar-status">🔄 กำลังโหลดข้อมูล...</span>
        </div>
    </nav>

    <!-- Training Status Section -->
    <div id="main-page">
    <div id="training-status">
        <div class="controls">
            <div style="display: flex; gap: 20px; justify-content: flex-end;">
                <div class="card">
                    <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14V16C8.69 16 6 18.69 6 22H4C4 17.58 7.58 14 12 14ZM12 13C9.33 13 7 10.67 7 8C7 5.33 9.33 3 12 3C14.67 3 17 5.33 17 8C17 10.67 14.67 13 12 13ZM12 5C10.44 5 9 6.44 9 8C9 9.56 10.44 11 12 11C13.56 11 15 9.56 15 8C15 6.44 13.56 5 12 5Z"/>
                    </svg>
                    <div class="card-content">
                        <div class="card-title">จำนวนช่างลงทะเบียนอบรม</div>
                        <div class="card-value" id="total-technician-count">-</div>
                    </div>
                </div>
                <div class="card">
                    <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                    <div class="card-content">
                        <div class="card-title">จำนวนช่างใหม่ที่ขึ้นทะเบียน</div>
                        <div class="card-value" id="new-technician-count">-</div>
                    </div>
                </div>
                <div class="card">
                    <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14V16C8.69 16 6 18.69 6 22H4C4 17.58 7.58 14 12 14ZM12 13C9.33 13 7 10.67 7 8C7 5.33 9.33 3 12 3C14.67 3 17 5.33 17 8C17 10.67 14.67 13 12 13ZM12 5C10.44 5 9 6.44 9 8C9 9.56 10.44 11 12 11C13.56 11 15 9.56 15 8C15 6.44 13.56 5 12 5ZM20.75 16C21.44 16 22 16.56 22 17.25C22 17.94 21.44 18.5 20.75 18.5H19.5V19.75C19.5 20.44 18.94 21 18.25 21C17.56 21 17 20.44 17 19.75V18.5H15.75C15.06 18.5 14.5 17.94 14.5 17.25C14.5 16.56 15.06 16 15.75 16H17V14.75C17 14.06 17.56 13.5 18.25 13.5C18.94 13.5 19.5 14.06 19.5 14.75V16H20.75Z"/>
                    </svg>
                    <div class="card-content">
                        <div class="card-title">SLA: การอบรม-การขึ้นทะเบียน</div>
                        <div class="card-value" id="sla-value">-</div>
                    </div>
                </div>
            </div>
        </div>

    <!-- เพิ่มการ์ดสถานะอื่นๆ -->
    <div style="display: flex; flex-wrap: nowrap; gap: 8px; margin-bottom: 20px; justify-content: center; overflow-x: auto;">
        <div class="card" style="background-color: #008080; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">เอกสารยังไม่ครบ</div>
                <div class="card-value" id="sla-incomplete-docs" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #DC143C; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ไม่เข้าอบรม</div>
                <div class="card-value" id="sla-not-attend" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #FF69B4; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ไม่ผ่านอบรม</div>
                <div class="card-value" id="sla-failed-training" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #FF6B00; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ช่างลาออก</div>
                <div class="card-value" id="sla-resigned" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #FF1493; color: white; width: 12.5%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ตัวแทนยังไม่ส่งขึ้นทะเบียน</div>
                <div class="card-value" id="sla-not-submitted" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #4169E1; color: white; width: 12%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">ติดประวัติอาชญากรรม</div>
                <div class="card-value" id="sla-criminal-record" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #4CA64C; color: white; width: 12%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">อยู่ระหว่างอบรมทฤษฎี</div>
                <div class="card-value" id="sla-theory-training" style="font-size: 16px;">-</div>
            </div>
        </div>
        <div class="card" style="background-color: #90EE90; color: white; width: 12%; min-width: 120px; padding: 8px 12px;">
            <div class="card-content">
                <div class="card-title" style="font-size: 13px;">อยู่ระหว่างอบรมปฎิบัติ</div>
                <div class="card-value" id="sla-practical-training" style="font-size: 16px;">-</div>
            </div>
        </div>
    </div>



    <div id="chart-container" style="display: flex; gap: 20px; margin: 20px 0;">
        <div class="chart-wrapper">
            <div class="legend-container">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #006400;"></div>
                    <span>ขึ้นทะเบียนเรียบร้อย</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF6B00;"></div>
                    <span>ช่างลาออก</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF1493;"></div>
                    <span>ตัวแทนยังไม่ส่งขึ้นทะเบียน</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4169E1;"></div>
                    <span>ติดประวัติอาชญากรรม</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #90EE90;"></div>
                    <span>อยู่ระหว่างอบรมปฎิบัติ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #008080;"></div>
                    <span>เอกสารยังไม่ครบ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4CA64C;"></div>
                    <span>อยู่ระหว่างอบรมทฤษฎี</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF69B4;"></div>
                    <span>ไม่ผ่านอบรม</span>
                </div>
            </div>
            <h3 style="color: #003366; margin-bottom: 20px; text-align: center;">📊 สถานะช่างอบรม by Month</h3>
            <div id="chart-label"></div>
            <canvas id="myChart" width="400" height="400"></canvas>
        </div>
        
        <!-- Daily Chart Section -->
        <div class="chart-wrapper">
            <h3 style="color: #003366; margin-bottom: 20px; text-align: center;">📊 สถานะช่างอบรม by Daily</h3>
            <div style="display: flex; align-items: flex-start; gap: 20px; justify-content: center; flex-wrap: wrap; max-width: 100%; overflow-x: auto;">
                <!-- Custom Legend -->
                <div class="legend-container" id="daily-legend-container" style="display: flex; flex-direction: column; gap: 4px; padding: 12px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 180px; flex-shrink: 0;">
                    <div class="legend-item" data-dataset="0" style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 3px; border-radius: 4px; transition: background-color 0.2s;">
                        <div class="legend-color" style="width: 20px !important; height: 20px !important; background-color: #006400; border-radius: 4px !important;"></div>
                        <span>ขึ้นทะเบียนเรียบร้อย</span>
                    </div>
                    <div class="legend-item" data-dataset="1" style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 3px; border-radius: 4px; transition: background-color 0.2s;">
                        <div class="legend-color" style="width: 20px !important; height: 20px !important; background-color: #FF6B00; border-radius: 4px !important;"></div>
                        <span>ช่างลาออก</span>
                    </div>
                    <div class="legend-item" data-dataset="2" style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 3px; border-radius: 4px; transition: background-color 0.2s;">
                        <div class="legend-color" style="width: 20px !important; height: 20px !important; background-color: #FF1493; border-radius: 4px !important;"></div>
                        <span>ตัวแทนยังไม่ส่งขึ้นทะเบียน</span>
                    </div>
                    <div class="legend-item" data-dataset="3" style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 3px; border-radius: 4px; transition: background-color 0.2s;">
                        <div class="legend-color" style="width: 20px !important; height: 20px !important; background-color: #4169E1; border-radius: 4px !important;"></div>
                        <span>ติดประวัติอาชญากรรม</span>
                    </div>
                    <div class="legend-item" data-dataset="4" style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 3px; border-radius: 4px; transition: background-color 0.2s;">
                        <div class="legend-color" style="width: 20px !important; height: 20px !important; background-color: #90EE90; border-radius: 4px !important;"></div>
                        <span>อยู่ระหว่างอบรมปฎิบัติ</span>
                    </div>
                    <div class="legend-item" data-dataset="5" style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 3px; border-radius: 4px; transition: background-color 0.2s;">
                        <div class="legend-color" style="width: 20px !important; height: 20px !important; background-color: #008080; border-radius: 4px !important;"></div>
                        <span>เอกสารยังไม่ครบ</span>
                    </div>
                    <div class="legend-item" data-dataset="6" style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 3px; border-radius: 4px; transition: background-color 0.2s;">
                        <div class="legend-color" style="width: 20px !important; height: 20px !important; background-color: #4CA64C; border-radius: 4px !important;"></div>
                        <span>อยู่ระหว่างอบรมทฤษฎี</span>
                    </div>
                    <div class="legend-item" data-dataset="7" style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 3px; border-radius: 4px; transition: background-color 0.2s;">
                        <div class="legend-color" style="width: 20px !important; height: 20px !important; background-color: #DC143C; border-radius: 4px !important;"></div>
                        <span>ไม่เข้าอบรม</span>
                    </div>
                    <div class="legend-item" data-dataset="8" style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 3px; border-radius: 4px; transition: background-color 0.2s;">
                        <div class="legend-color" style="width: 20px !important; height: 20px !important; background-color: #FF69B4; border-radius: 4px !important;"></div>
                        <span>ไม่ผ่านอบรม</span>
                    </div>
                </div>
                
                <!-- Chart Container -->
                <div style="flex: 1; min-width: 400px; max-width: 100%;">
                    <canvas id="dailyChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- SLA Analysis Section -->
    <div style="background-color: #f8f9fa; border: 2px solid #003366; border-radius: 8px; margin: -10px 0 20px 0; padding: 20px;">
        <h3 style="color: #003366; text-align: center; margin-bottom: 20px;">การวิเคราะห์ SLA (Service Level Agreement)</h3>
        
        <!-- SLA Summary Cards -->
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; justify-content: center;">
            <div class="card" style="background-color: #28a745; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">SLA เฉลี่ย (ขึ้นทะเบียนสำเร็จ)</div>
                    <div class="card-value" id="sla-success-avg" style="font-size: 22px; color: white;">-</div>
                </div>
            </div>
            
            <div class="card" style="background-color: #17a2b8; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">SLA เฉลี่ย (ทั้งหมด)</div>
                    <div class="card-value" id="sla-overall-avg" style="font-size: 22px; color: white;">-</div>
                </div>
            </div>
            
            <div class="card" style="background-color: #6f42c1; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">เป้าหมาย SLA</div>
                    <div class="card-value" style="font-size: 22px; color: white;">≤ 30 วัน</div>
                </div>
            </div>
            
            <div class="card" style="background-color: #fd7e14; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">สถานะ SLA</div>
                    <div class="card-value" id="sla-status" style="font-size: 22px; color: white;">-</div>
                </div>
            </div>
        </div>

        <!-- SLA by Status Table -->
        <div style="margin: 20px 0;">
            <h4 style="color: #003366; margin-bottom: 15px;">การวิเคราะห์ SLA รายสถานะ</h4>
            <table id="sla-analysis-table" style="width: 100%; border-collapse: collapse; background-color: white;">
                <thead>
                    <tr style="background-color: #003366; color: white;">
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">สถานะ</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">จำนวน (คน)</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">SLA เฉลี่ย (วัน)</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">SLA สูงสุด (วัน)</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">SLA ต่ำสุด (วัน)</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">ประเมินผล</th>
                    </tr>
                </thead>
                <tbody id="sla-analysis-body">
                    <!-- จะถูกเติมด้วย JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- SLA Performance Indicators -->
        <div style="margin: 20px 0;">
            <h4 style="color: #003366; margin-bottom: 15px;">ตัวชี้วัดประสิทธิภาพ SLA</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                <div class="card" style="background-color: #20c997; color: white; min-width: 180px; padding: 12px 15px;">
                    <div class="card-content">
                        <div class="card-title" style="font-size: 14px; color: white;">% ขึ้นทะเบียนตรงเวลา</div>
                        <div class="card-value" id="sla-ontime-percentage" style="font-size: 18px; color: white;">-</div>
                    </div>
                </div>
                
                <div class="card" style="background-color: #e83e8c; color: white; min-width: 180px; padding: 12px 15px;">
                    <div class="card-content">
                        <div class="card-title" style="font-size: 14px; color: white;">% เกินกำหนด SLA</div>
                        <div class="card-value" id="sla-overdue-percentage" style="font-size: 18px; color: white;">-</div>
                    </div>
                </div>
                
                <div class="card" style="background-color: #ffc107; color: #212529; min-width: 180px; padding: 12px 15px;">
                    <div class="card-content">
                        <div class="card-title" style="font-size: 14px;">กรณีที่ต้องติดตาม</div>
                        <div class="card-value" id="sla-followup-count" style="font-size: 18px;">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Report Section -->
    <div id="daily-report" style="margin-top: 40px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
        <h2 style="color: #003366; text-align: center; margin-bottom: 30px;">📊 รายงานแสดงผลอบรมช่างประจำวัน</h2>
        
        <!-- Daily Summary Cards -->
        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; justify-content: center;">
            <div class="card" style="background-color: #007bff; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">สถานะช่าง ณ.เดือนปัจจุบัน</div>
                    <div class="card-value" id="daily-total-registered" style="font-size: 24px; color: white;">-</div>
                </div>
            </div>
            
            <div class="card" style="background-color: #28a745; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">ขึ้นทะเบียนสำเร็จ</div>
                    <div class="card-value" id="daily-success-count" style="font-size: 24px; color: white;">-</div>
                </div>
            </div>
            
            <div class="card" style="background-color: #dc3545; color: white; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px; color: white;">มีปัญหา/ไม่สำเร็จ</div>
                    <div class="card-value" id="daily-issues-count" style="font-size: 24px; color: white;">-</div>
                </div>
            </div>
            
            <div class="card" style="background-color: #ffc107; color: #212529; min-width: 200px; padding: 15px 20px;">
                <div class="card-content">
                    <div class="card-title" style="font-size: 16px;">อัตราความสำเร็จ</div>
                    <div class="card-value" id="daily-success-rate" style="font-size: 24px;">-</div>
                </div>
            </div>
        </div>


    </div>
    <!-- End Daily Report Section -->

    <h2 id="pivot-table-title">สถานะการอบรมช่างใหม่รายพื้นที่</h2>
    <table id="pivot-table" class="pivot-table">
        <thead>
            <tr id="pivot-header"></tr>
        </thead>
        <tbody id="pivot-body"></tbody>
    </table>

    <div class="table-header-container">
        <h2>รายละเอียดข้อมูลช่างลงทะเบียนอบรมช่างใหม่</h2>
    </div>
    <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
        <div class="card month-card" data-month="all" style="background-color: #003366; color: white; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">All</div>
        <div class="card month-card" data-month="Jan" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Jan</div>
        <div class="card month-card" data-month="Feb" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Feb</div>
        <div class="card month-card" data-month="Mar" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Mar</div>
        <div class="card month-card" data-month="Apr" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Apr</div>
        <div class="card month-card" data-month="May" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">May</div>
        <div class="card month-card" data-month="Jun" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Jun</div>
        <div class="card month-card" data-month="Jul" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Jul</div>
        <div class="card month-card" data-month="Aug" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Aug</div>
        <div class="card month-card" data-month="Sep" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Sep</div>
        <div class="card month-card" data-month="Oct" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Oct</div>
        <div class="card month-card" data-month="Nov" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Nov</div>
        <div class="card month-card" data-month="Dec" style="background-color: #f0f0f0; color: black; padding: 5px 10px; font-size: 14px; min-width: auto; cursor: pointer;">Dec</div>
    </div>
    <div class="table-buttons" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: -40px; margin-bottom: 10px;">
        <form class="search-container" onsubmit="event.preventDefault(); searchTableData();">
            <input type="text" id="search-input" class="search-input" placeholder="พิมพ์คำค้นหา...">
            <button type="button" id="search-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                ค้นหา
            </button>
        </form>
        <button id="reset-filter-button" title="ล้างการกรอง">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 3h18v18H3z"></path>
                <path d="M21 3l-9 9M3 21l9-9"></path>
            </svg>
            ล้างตัวกรอง
        </button>
        <button id="refresh-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
            </svg>
            รีเฟรชข้อมูล
        </button>
        <button id="download-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            ดาวน์โหลด
        </button>
    </div>
    <table id="data-table">
        <thead>
            <tr>
                <th>พื้นที่</th>
                <th>รอบวันที่</th>
                <th>เดือนอบรม</th>
                <th>week</th>
                <th>ชื่อ-นามสกุล</th>
                <th>ชื่อ บจก./หจก/ร้าน (ตัวแทน)</th>
                <th>รหัสตัวแทน</th>
                <th>จังหวัดที่ตั้งร้านตัวแทน</th>
                <th>สถานะกองงาน (หัวหน้าหรือลูกน้อง)</th>
                <th>ผลการขึ้นทะเบียน</th>
                <th>Status ล่าสุด</th>
                <th>วันเริ่มต้น</th>
                <th>วันสิ้นสุด</th>
                <th>SLA</th>
                <th>ปี</th>
            </tr>
        </thead>
        <tbody id="data-body"></tbody>
    </table>

    <div class="pagination-container">
        <div class="pagination-controls">
            <button id="prev-button" class="pagination-button" disabled>ก่อนหน้า</button>
            <div class="pagination-pages" id="pagination-pages">
                <!-- หมายเลขหน้าจะถูกสร้างโดย JavaScript -->
            </div>
            <div class="pagination-info" id="pagination-info">หน้า 1 จาก 10</div>
            <button id="next-button" class="pagination-button">ถัดไป</button>
        </div>
        <div class="page-size-selector">
            <label for="page-size">จำนวนแถวต่อหน้า:</label>
            <select id="page-size">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
        </div>
    </div>

    <!-- Problem Details Table -->
    <div style="background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px 0; border-left: 4px solid #dc3545;">
        <div class="table-header-container">
            <h3 style="color: #003366; margin: 0;">📋 รายชื่อช่างที่มีปัญหา</h3>
            <div class="table-buttons" style="display: flex; gap: 10px; justify-content: flex-end;">
                <form class="search-container" onsubmit="event.preventDefault(); searchProblemsTable();">
                    <input type="text" id="problems-search-input" class="search-input" placeholder="ค้นหาช่างที่มีปัญหา...">
                    <button type="button" id="problems-search-button">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        ค้นหา
                    </button>
                </form>
                <button id="problems-reset-filter-button" title="ล้างการกรอง">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 3h18v18H3z"></path>
                        <path d="M21 3l-9 9M3 21l9-9"></path>
                    </svg>
                    ล้างตัวกรอง
                </button>
                <button id="problems-refresh-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
                    </svg>
                    รีเฟรชข้อมูล
                </button>
                <button id="problems-download-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    ดาวน์โหลด
                </button>
            </div>
        </div>
        <div style="overflow-x: auto; margin-top: 20px;">
            <table id="daily-problems-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #003366; color: white;">
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">ชื่อ-นามสกุล</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">ตัวแทน</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">พื้นที่</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">สถานะปัญหา</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">เอกสารที่ขาด</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">SLA (วัน)</th>
                    </tr>
                </thead>
                <tbody id="daily-problems-body">
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: #666;">กำลังโหลดข้อมูล...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- End Training Status Section -->
    </div>
    </div> <!-- End main-page -->

    <!-- Daily Report Page Section -->
    <div id="daily-report-page" style="display: none;">
        <div style="background-color: #f8f9fa; border: 2px solid #003366; border-radius: 8px; margin: 20px 0; padding: 30px;">
            <h2 style="color: #003366; text-align: center; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 15px;">
                📋 รายงานประจำวัน-Mockup
            </h2>
            <p style="color: #6c757d; text-align: center; margin-bottom: 20px; font-size: 1.1rem;">
                หน้าตัวอย่างสำหรับรายงานประจำวัน (ข้อมูลจำลอง)
            </p>
            <div style="text-align: center; margin-bottom: 30px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                <p style="color: #856404; margin: 0; font-weight: 600;">
                    ⚠️ หน้านี้เป็นตัวอย่าง (Mockup) ข้อมูลที่แสดงเป็นข้อมูลจำลองเท่านั้น
                </p>
            </div>

            <!-- Daily Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: linear-gradient(135deg, #003366, #004080); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,51,102,0.3); text-align: center;">
                                     <div style="font-size: 2.5rem; margin-bottom: 15px;">👥</div>
                 <div style="font-size: 2rem; font-weight: bold; margin-bottom: 8px; color: #00ff88;" id="daily-total-registered-new">-</div>
                 <div style="font-size: 1rem; opacity: 0.9;">ลงทะเบียนวันนี้ (จำลอง)</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #003366, #004080); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,51,102,0.3); text-align: center;">
                                     <div style="font-size: 2.5rem; margin-bottom: 15px;">✅</div>
                 <div style="font-size: 2rem; font-weight: bold; margin-bottom: 8px; color: #00ff88;" id="daily-success-new">-</div>
                 <div style="font-size: 1rem; opacity: 0.9;">สำเร็จวันนี้ (จำลอง)</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #003366, #004080); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,51,102,0.3); text-align: center;">
                                     <div style="font-size: 2.5rem; margin-bottom: 15px;">📈</div>
                 <div style="font-size: 2rem; font-weight: bold; margin-bottom: 8px; color: #00ff88;" id="daily-success-rate-new">-</div>
                 <div style="font-size: 1rem; opacity: 0.9;">อัตราความสำเร็จ (จำลอง)</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #003366, #004080); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,51,102,0.3); text-align: center;">
                                     <div style="font-size: 2.5rem; margin-bottom: 15px;">⚠️</div>
                 <div style="font-size: 2rem; font-weight: bold; margin-bottom: 8px; color: #00ff88;" id="daily-issues-new">-</div>
                 <div style="font-size: 1rem; opacity: 0.9;">ปัญหาที่ต้องติดตาม (จำลอง)</div>
                </div>
            </div>

            <!-- Daily Report Charts Section -->
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #003366; margin-bottom: 20px; text-align: center;">📊 กราฟข้อมูลรายงานประจำวัน (Mockup)</h3>
                <div style="text-align: center; padding: 50px; color: #6c757d;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">📈</div>
                    <p>กราฟข้อมูลรายงานประจำวันจะแสดงที่นี่</p>
                    <p style="font-size: 14px; color: #999;">นี่เป็นหน้าตัวอย่าง (Mockup) ข้อมูลจริงจะเพิ่มเติมในอนาคต</p>
                </div>
            </div>

            <!-- Daily Report Table Section -->
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #003366; margin-bottom: 20px;">📋 ตารางข้อมูลรายละเอียดประจำวัน (Mockup)</h3>
                <div style="text-align: center; padding: 50px; color: #6c757d;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">📊</div>
                    <p>ตารางข้อมูลรายละเอียดจะแสดงที่นี่</p>
                    <p style="font-size: 14px; color: #999;">นี่เป็นหน้าตัวอย่าง (Mockup) พร้อมสำหรับการพัฒนาข้อมูลจริง</p>
                </div>
            </div>

            <!-- Back to Home Button -->
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="showHomePage()" style="
                    background: linear-gradient(135deg, #003366, #004080);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    display: inline-flex;
                    align-items: center;
                    gap: 10px;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 20px rgba(0,51,102,0.3)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    🏠 กลับไปหน้าหลัก
                </button>
            </div>
        </div>
    </div>

    <script>
        // ฟังก์ชันเพื่ออัปเดตวันที่และเวลาปัจจุบันในรูปแบบประเทศไทย
        function updateCurrentDateTime() {
            const currentDateElement = document.getElementById('current-date');
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            const thaiYear = now.getFullYear() + 543;
            const thaiDate = now.toLocaleDateString('th-TH', options).replace(now.getFullYear(), thaiYear);
            currentDateElement.textContent = `วันที่: ${thaiDate}`;
        }

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        updateCurrentDateTime();
        setInterval(updateCurrentDateTime, 1000);

        // ฟังก์ชันอัปเดตสถานะใน navbar
        function updateNavbarStatus(message, isSuccess = true) {
            const statusElement = document.getElementById('navbar-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = isSuccess ? '#00ff88' : '#ff6b6b';
            }
        }
        
        // อัปเดตสถานะ navbar เมื่อโหลดข้อมูลสำเร็จ
        function updateNavbarOnDataLoad() {
            updateNavbarStatus('✅ ข้อมูลอัปเดตล่าสุด', true);
        }
        
        // อัปเดตสถานะ navbar เมื่อเกิดข้อผิดพลาด
        function updateNavbarOnError() {
            updateNavbarStatus('❌ เกิดข้อผิดพลาดในการโหลดข้อมูล', false);
        }



        // ฟังก์ชันสำหรับแสดงหน้าหลัก
        function showHomePage() {
            document.getElementById('main-page').style.display = 'block';
            document.getElementById('daily-report-page').style.display = 'none';
            
            // อัปเดต active state ของเมนู
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            document.querySelector('.nav-item[onclick*="showHomePage"]').classList.add('active');
            
            // เลื่อนไปด้านบน
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // ฟังก์ชันสำหรับแสดงหน้ารายงานประจำวัน
        function showDailyReport() {
            document.getElementById('main-page').style.display = 'none';
            document.getElementById('daily-report-page').style.display = 'block';
            
            // อัปเดต active state ของเมนู
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            document.querySelector('.nav-item[onclick*="showDailyReport"]').classList.add('active');
            
            // เลื่อนไปด้านบน
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            
            // โหลดข้อมูลรายงานประจำวัน
            loadDailyReportData();
        }

        // ฟังก์ชันโหลดข้อมูล Mockup รายงานประจำวัน
        function loadDailyReportData() {
            // อัปเดตสถานะ navbar
            updateNavbarStatus('🔄 กำลังโหลดข้อมูล Mockup...', true);
            
            // Mock data - ข้อมูลจำลองสำหรับตัวอย่าง
            setTimeout(() => {
                document.getElementById('daily-total-registered-new').textContent = '45 คน';
                document.getElementById('daily-success-new').textContent = '32 คน';
                document.getElementById('daily-success-rate-new').textContent = '71.1%';
                document.getElementById('daily-issues-new').textContent = '13 คน';
                
                updateNavbarStatus('✅ ข้อมูล Mockup โหลดเสร็จแล้ว', true);
            }, 1500);
        }

        // URL for Google Sheets
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLKGmFsdD4oMcVdnf_wyrwAD3-3R7Ys9hXCg2gwBsudfJIUliRymBnVYHapN7a3Yq08Lgxf9cYYV6Y/pub?gid=377151035&single=true&output=csv";

        let chart;
        let originalData;
        let filteredData2025;

        // ตัวแปรสำหรับการแบ่งหน้า
        let currentPage = 1;
        let pageSize = 50;
        let totalPages = 1;

        // ฟังก์ชันเพื่อดึงข้อมูลและอัปเดตตาราง
        function fetchDataAndUpdateTable() {
            console.log('=== เริ่มดึงข้อมูลจาก Google Sheets ===');
            
            // อัปเดตสถานะ navbar เมื่อเริ่มโหลด
            updateNavbarStatus('🔄 กำลังโหลดข้อมูล...', true);
            
            return fetch(sheetUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    console.log('✅ ดึงข้อมูล CSV สำเร็จ');
                    
                    const rows = parseCsvData(csvText);
                    originalData = rows;
                    filteredData2025 = filterDataByYear(rows, 2025);
                    
                    console.log('📊 ข้อมูลทั้งหมด:', rows.length, 'แถว');
                    console.log('📊 ข้อมูลปี 2025:', filteredData2025.length, 'แถว');
                    
                    // แยกการอัปเดตตารางหลักออกจากการอัปเดตกราฟและ pivot table
                    updateChartAndTables(filteredData2025);
                    
                    // อัปเดตตารางหลักเพียงครั้งเดียวเมื่อโหลดข้อมูล
                    updateMainTable(filteredData2025);
                    
                    // รีเซ็ตการแสดงผลให้แสดงข้อมูลทั้งหมด
                    const allButton = document.querySelector('.month-card[data-month="all"]');
                    if (allButton) {
                        // ไฮไลต์ปุ่ม All
                        document.querySelectorAll('.month-card').forEach(card => {
                            card.style.backgroundColor = '#f0f0f0';
                            card.style.color = 'black';
                        });
                        allButton.style.backgroundColor = '#003366';
                        allButton.style.color = 'white';
                    }
                    
                    // ลบข้อความแสดงจำนวนข้อมูลที่กรองออก
                    const existingInfo = document.getElementById('data-count-info');
                    if (existingInfo) {
                        existingInfo.remove();
                    }
                    
                    // แสดงตัวควบคุมการแบ่งหน้า
                    const paginationContainer = document.querySelector('.pagination-container');
                    if (paginationContainer) {
                        paginationContainer.style.display = 'flex';
                    }
                    
                    console.log('✅ อัปเดตหน้าหลักสำเร็จ');
                    
                    // โหลดรายงานประจำวัน
                    loadDailyReport();
                    
                    // ลบข้อความ error ที่อาจมีอยู่
                    const existingError = document.querySelector('.error-message');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    // อัปเดตสถานะ navbar เมื่อโหลดสำเร็จ
                    updateNavbarOnDataLoad();
                    
                    return filteredData2025; // return ข้อมูลเพื่อให้ caller สามารถใช้ได้
                })
                .catch(error => {
                    console.error("❌ เกิดข้อผิดพลาดในการดึงข้อมูล:", error);
                    
                    // ลบข้อความ error เดิม
                    const existingError = document.querySelector('.error-message');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    // แสดงข้อความ error ใหม่
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'error-message';
                    messageDiv.style.cssText = `
                        padding: 15px; 
                        margin: 20px 0; 
                        background-color: #f8d7da; 
                        border: 2px solid #f5c6cb; 
                        border-radius: 8px; 
                        color: #721c24;
                        text-align: center;
                        font-weight: bold;
                    `;
                    messageDiv.innerHTML = `
                        ⚠️ เกิดข้อผิดพลาดในการดึงข้อมูล<br>
                        <small style="font-weight: normal;">
                            ${error.message}<br>
                            กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและลองใหม่อีกครั้ง
                        </small><br>
                        <button onclick="fetchDataAndUpdateTable()" style="
                            margin-top: 10px; 
                            padding: 8px 15px; 
                            background-color: #721c24; 
                            color: white; 
                            border: none; 
                            border-radius: 4px; 
                            cursor: pointer;
                        ">ลองใหม่</button>
                    `;
                    
                    // หาตำแหน่งที่จะแทรก error message
                    const headerContainer = document.querySelector('.header-container');
                    if (headerContainer) {
                        headerContainer.insertAdjacentElement('afterend', messageDiv);
                    }
                    
                    // อัปเดตสถานะ navbar เมื่อเกิดข้อผิดพลาด
                    updateNavbarOnError();
                    
                    throw error; // re-throw เพื่อให้ caller สามารถจัดการได้
                });
        }
        
        // ตัวแปรเก็บข้อมูลตารางปัญหา
        let originalProblemsData = [];
        let filteredProblemsData = [];

        // ฟังก์ชันค้นหาในตารางปัญหา
        function searchProblemsTable() {
            const searchTerm = document.getElementById('problems-search-input').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderProblemsTable(originalProblemsData);
                return;
            }

            const filteredData = originalProblemsData.filter(item => {
                return item.name.toLowerCase().includes(searchTerm) ||
                       item.agent.toLowerCase().includes(searchTerm) ||
                       item.area.toLowerCase().includes(searchTerm) ||
                       item.status.toLowerCase().includes(searchTerm) ||
                       item.missingDocs.some(doc => doc.toLowerCase().includes(searchTerm));
            });

            renderProblemsTable(filteredData);
        }

        // ฟังก์ชันรีเซ็ตตารางปัญหา
        function resetProblemsTable() {
            document.getElementById('problems-search-input').value = '';
            renderProblemsTable(originalProblemsData);
        }

        // ฟังก์ชันรีเฟรชตารางปัญหา
        function refreshProblemsTable() {
            loadDailyReport();
        }

        // ฟังก์ชันดาวน์โหลดตารางปัญหา
        function downloadProblemsTable() {
            if (!window.XLSX) {
                alert('ไม่สามารถโหลด Excel library ได้ กรุณาลองใหม่อีกครั้ง');
                return;
            }

            if (originalProblemsData.length === 0) {
                alert('ไม่มีข้อมูลปัญหาที่จะดาวน์โหลด');
                return;
            }

            // สร้างข้อมูลสำหรับ Excel
            const excelData = originalProblemsData.map(item => ({
                'ชื่อ-นามสกุล': item.name,
                'ตัวแทน': item.agent,
                'พื้นที่': item.area,
                'สถานะปัญหา': item.status,
                'เอกสารที่ขาด': item.missingDocs.join(', ') || 'ครบถ้วน',
                'SLA (วัน)': item.sla !== '-' ? item.sla : '-'
            }));

            try {
                const worksheet = XLSX.utils.json_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "ช่างที่มีปัญหา");
                
                const now = new Date();
                const datePart = now.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\//g, '-');
                
                const filename = `รายชื่อช่างที่มีปัญหา_${datePart}.xlsx`;
                XLSX.writeFile(workbook, filename);
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการสร้างไฟล์ Excel:', error);
                alert('เกิดข้อผิดพลาดในการดาวน์โหลดไฟล์');
            }
        }

        // ฟังก์ชันแสดงผลตารางปัญหา
        function renderProblemsTable(data) {
            const tbody = document.getElementById('daily-problems-body');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #28a745;">🎉 ไม่มีช่างที่มีปัญหาในเดือนนี้</td></tr>';
                return;
            }

            data.forEach(item => {
                // กำหนดสีตามประเภทปัญหา
                let statusColor = '#dc3545';
                if (item.status === 'ช่างลาออก') statusColor = '#fd7e14';
                else if (item.status === 'ติดประวัติอาชญากรรม') statusColor = '#6f42c1';
                else if (item.status === 'เอกสารยังไม่ครบ') statusColor = '#20c997';
                else if (item.status === 'ตัวแทนยังไม่ส่งขึ้นทะเบียน') statusColor = '#17a2b8';

                // สร้างรายการเอกสารที่ขาด
                let missingDocsHtml = '';
                if (item.missingDocs.length > 0) {
                    missingDocsHtml = item.missingDocs.map(doc => 
                        `<span style="background-color: #ffc107; color: #212529; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px; display: inline-block;">${doc}</span>`
                    ).join(' ');
                } else {
                    missingDocsHtml = '<span style="color: #28a745;">ครบถ้วน</span>';
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${item.agent}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.area}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <span style="background-color: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${item.status}
                        </span>
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        ${missingDocsHtml}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">
                        ${item.sla !== '-' ? item.sla + ' วัน' : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ฟังก์ชันสำหรับอัปเดตเฉพาะตารางหลัก
        function updateMainTable(rows) {
            // กรองข้อมูลเฉพาะปี 2025
            window.tableData = rows.filter(row => row.c[41]?.v === '2025').map(row => ({
                area: row.c[26]?.v || '',
                roundDate: row.c[27]?.v || '',
                trainingMonth: row.c[28]?.v || '',
                week: row.c[39]?.v || '',
                name: row.c[3]?.v || '',
                company: row.c[6]?.v || '',
                agentCode: row.c[7]?.v || '',
                province: row.c[8]?.v || '',
                workStatus: row.c[13]?.v || '',
                registerResult: row.c[33]?.v || '',
                latestStatus: row.c[34]?.v || '',
                startDate: row.c[35]?.v || '',
                endDate: row.c[36]?.v || '',
                sla: row.c[37]?.v || '',
                year: row.c[41]?.v || ''
            }));
            
            // เก็บข้อมูลต้นฉบับไว้
            window.originalTableData = [...window.tableData];

            // เริ่มต้นสร้างตารางใหม่
            const dataTable = document.getElementById('data-table');
            const thead = dataTable.getElementsByTagName('thead')[0];
            thead.innerHTML = '';

            // สร้างแถวส่วนหัว
            const headerRow = thead.insertRow();
            const columnHeaders = [
                { text: "พื้นที่", key: "area" },
                { text: "รอบวันที่", key: "roundDate" },
                { text: "เดือนอบรม", key: "trainingMonth" },
                { text: "week", key: "week" },
                { text: "ชื่อ-นามสกุล", key: "name" },
                { text: "ชื่อ บจก./หจก/ร้าน (ตัวแทน)", key: "company" },
                { text: "รหัสตัวแทน", key: "agentCode" },
                { text: "จังหวัดที่ตั้งร้านตัวแทน", key: "province" },
                { text: "สถานะกองงาน (หัวหน้าหรือลูกน้อง)", key: "workStatus" },
                { text: "ผลการขึ้นทะเบียน", key: "registerResult" },
                { text: "Status ล่าสุด", key: "latestStatus" },
                { text: "วันเริ่มต้น", key: "startDate" },
                { text: "วันสิ้นสุด", key: "endDate" },
                { text: "SLA", key: "sla" },
                { text: "ปี", key: "year" }
            ];

            // สร้างหัวคอลัมน์พร้อม event listener
            columnHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.text;
                th.dataset.key = header.key;
                th.addEventListener('click', () => handleSort(header.key));
                headerRow.appendChild(th);
            });

            // แสดงข้อมูลในตาราง
            renderTableData(window.tableData);
        }

        // ฟังก์ชันแยกข้อมูล CSV
        function parseCsvData(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    let currentChar = 0;
                    let inQuotes = false;
                    let currentValue = '';
                    const values = [];
                    
                    while (currentChar < line.length) {
                        const char = line[currentChar];
                        
                        if (char === '"' && line[currentChar - 1] !== '\\') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentValue.replace(/^"|"$/g, '').trim());
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                        
                        currentChar++;
                    }
                    
                    values.push(currentValue.replace(/^"|"$/g, '').trim());
                    rows.push({
                        c: values.map(value => ({ v: value }))
                    });
                }
            }
            
            return rows;
        }

        // ฟังก์ชันสำหรับกรองข้อมูลตามปี
        function filterDataByYear(data, year) {
            return data.filter(row => {
                const yearValue = row.c[41]?.v;
                return yearValue === year.toString();
            });
        }

        // ฟังก์ชันแปลงวันที่เป็นรูปแบบเดือน
        function getMonthFromEndDate(dateString) {
            if (!dateString || dateString === '-') return null;
            
            // รองรับรูปแบบ dd/mm/yyyy หรือ dd/m/yyyy
            const dateMatch = dateString.match(/\d{1,2}\/(\d{1,2})\/(\d{4})/);
            if (!dateMatch) return null;
            
            const month = parseInt(dateMatch[1]);
            const year = parseInt(dateMatch[2]);
            
            // แปลงเป็นรูปแบบ MonthYY ตามที่ใช้ในกราฟ
            const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const yearShort = year.toString().slice(-2);
            
            if (month >= 1 && month <= 12) {
                return monthNames[month] + yearShort;
            }
            
            return null;
        }

        // ฟังก์ชันแปลงวันที่สำหรับกราฟรายวัน
        function formatDateForChart(dateString) {
            if (!dateString || dateString === '-') return null;
            
            // รองรับรูปแบบ dd/mm/yyyy หรือ dd/m/yyyy
            const dateMatch = dateString.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (!dateMatch) return null;
            
            const day = parseInt(dateMatch[1]);
            const month = parseInt(dateMatch[2]);
            const year = parseInt(dateMatch[3]);
            
            // ตรวจสอบความถูกต้องของวันที่
            if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2020) {
                // แปลงเป็นรูปแบบ dd/mm/yyyy
                const dayFormatted = day.toString().padStart(2, '0');
                const monthFormatted = month.toString().padStart(2, '0');
                return `${dayFormatted}/${monthFormatted}/${year}`;
            }
            
            return null;
        }

        // ฟังก์ชันเพื่ออัปเดตกราฟและตาราง
        function updateChartAndTables(rows, selectedMonth = null, selectedStatus = null) {
            const allMonthOrder = ['Jan25', 'Feb25', 'Mar25', 'Apr25', 'May25', 'Jun25', 'Jul25', 'Aug25', 'Sep25', 'Oct25', 'Nov25', 'Dec25'];
            const allMonthLabels = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const statusList = ["ขึ้นทะเบียนเรียบร้อย", "ช่างลาออก", "ตัวแทนยังไม่ส่งขึ้นทะเบียน", "ติดประวัติอาชญากรรม", "อยู่ระหว่างอบรมปฎิบัติ", "เอกสารยังไม่ครบ", "อยู่ระหว่างอบรมทฤษฎี", "ไม่เข้าอบรม", "ไม่ผ่านอบรม"];
            const colors = ['#006400', '#FF6B00', '#FF1493', '#4169E1', '#90EE90', '#008080', '#4CA64C', '#DC143C', '#FF69B4'];

            let filteredRows = rows;
            if (selectedMonth) {
                // เปลี่ยนจากการกรองด้วยคอลัมน์ 28 เป็นคอลัมน์ 36 (วันสิ้นสุด)
                filteredRows = filteredRows.filter(row => {
                    const endDateMonth = getMonthFromEndDate(row.c[36]?.v);
                    return endDateMonth === selectedMonth;
                });
            }
            if (selectedStatus) {
                filteredRows = filteredRows.filter(row => row.c[34]?.v === selectedStatus);
            }

            // หาเดือนที่มีข้อมูลจริง
            const monthLabels = [];
            const monthOrder = [];

            allMonthOrder.forEach((month, index) => {
                const monthData = filteredRows.filter(row => {
                    const endDateMonth = getMonthFromEndDate(row.c[36]?.v);
                    return endDateMonth === month;
                });
                
                if (monthData.length > 0) {
                    monthOrder.push(month);
                    monthLabels.push(allMonthLabels[index]);
                }
            });
            


            // ถ้าไม่มีข้อมูลเลย ให้ใช้เดือนเดียว
            if (monthOrder.length === 0) {
                monthOrder.push('Jan25');
                monthLabels.push('January');
            }

            const chartData = {
                labels: monthLabels,
                datasets: statusList.map((status, index) => ({
                    label: status,
                    data: monthOrder.map(month => {
                        // เปลี่ยนจากการใช้คอลัมน์ 28 เป็นคอลัมน์ 36 (วันสิ้นสุด)
                        return filteredRows.filter(row => {
                            const endDateMonth = getMonthFromEndDate(row.c[36]?.v);
                            return endDateMonth === month && row.c[34]?.v === status;
                        }).length;
                    }),
                    backgroundColor: colors[index],
                    hidden: false // เริ่มต้นไม่ซ่อน จะจัดการ legend ทีหลัง
                }))
            };

            // คำนวณค่า max แบบ dynamic ตามข้อมูลจริง
            const maxDataValue = Math.max(...monthOrder.map(month => {
                return chartData.datasets.reduce((sum, dataset) => {
                    const monthIndex = monthOrder.indexOf(month);
                    return sum + (dataset.data[monthIndex] || 0);
                }, 0);
            }), 1); // ป้องกันกรณีไม่มีข้อมูล
            
            // กำหนด max ของแกน Y ให้สูงกว่าค่าสูงสุดประมาณ 15-20% และปัดขึ้นเป็นจำนวนที่หารด้วย 20 ลงตัว
            const dynamicMax = Math.max(100, Math.ceil(maxDataValue * 1.2 / 20) * 20);

            const chartCanvas = document.getElementById('myChart').getContext('2d');
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(chartCanvas, {
                type: 'bar',
                data: chartData,
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        datalabels: {
                            color: 'white',
                            anchor: 'center',
                            align: 'center',
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            },
                            font: {
                                weight: 'bold',
                                size: 14
                            }
                        },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.y;
                                    });
                                    return 'รวม: ' + sum;
                                }
                            }
                        }
                    },
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: dynamicMax,
                            ticks: {
                                stepSize: Math.max(10, Math.ceil(dynamicMax / 20))
                            },
                            grid: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const datasetIndex = elements[0].datasetIndex;
                            const index = elements[0].index;
                            const clickedStatus = chart.data.datasets[datasetIndex].label;
                            const clickedMonthCode = monthOrder[index]; // ใช้ monthOrder แทน labels
                            updateChartAndTables(filteredData2025, clickedMonthCode, clickedStatus);
                        } else {
                            updateChartAndTables(filteredData2025);
                        }
                    }
                },
                plugins: [ChartDataLabels, {
                    // Plugin สำหรับแสดงยอดรวมบนแท่ง เฉพาะเมื่อไม่มี legend ไหนถูกเลือก
                    afterDatasetsDraw: function(chart) {
                        if (window.selectedLegendItems && window.selectedLegendItems.size > 0) return;
                        const ctx = chart.ctx;
                        const datasets = chart.data.datasets;
                        const labels = chart.data.labels;
                        labels.forEach((label, i) => {
                            let sum = 0;
                            datasets.forEach(ds => {
                                if (!ds.hidden) sum += ds.data[i] || 0;
                            });
                            // หาตำแหน่ง y สูงสุดของแท่ง
                            let meta = null;
                            for (let d = datasets.length - 1; d >= 0; d--) {
                                if (!datasets[d].hidden && datasets[d].data[i] > 0) {
                                    meta = chart.getDatasetMeta(d);
                                    break;
                                }
                            }
                            if (meta && meta.data[i]) {
                                const x = meta.data[i].x;
                                const y = meta.data[i].y - 10;
                                ctx.save();
                                ctx.font = 'bold 16px Arial';
                                ctx.fillStyle = '#000';
                                ctx.textAlign = 'center';
                                ctx.fillText(sum, x, y);
                                ctx.restore();
                            }
                        });
                    }
                }]
            });

            // อัพเดทเฉพาะตาราง Pivot ไม่กระทบตารางหลัก
                        updatePivotTable(filteredRows);

            // เรียกใช้ฟังก์ชันจัดการ Legend
            initializeLegendHandlers();

            // อัพเดทการ์ดข้อมูล
            const totalTechnicianCount = countTotalTechnicians(filteredData2025);
            document.getElementById('total-technician-count').textContent = totalTechnicianCount + ' คน';

            const newTechnicianCount = countNewTechnicians(filteredData2025);
            const percentage = ((newTechnicianCount / totalTechnicianCount) * 100).toFixed(2);
            document.getElementById('new-technician-count').textContent = `${newTechnicianCount} คน (${percentage}%)`;

            const averageSLA = calculateAverageSLA(filteredData2025);
            document.getElementById('sla-value').textContent = averageSLA + ' วัน';

            // อัพเดทการ์ดสถานะต่างๆ
            updateStatusCards(filteredData2025);
        }

        // ฟังก์ชันคำนวณค่าเฉลี่ย SLA
        function calculateAverageSLA(rows) {
            let count = 0;
            let totalSLA = 0;
            
            // ดึงค่า SLA จากทุกแถวที่มีสถานะ "ขึ้นทะเบียนเรียบร้อย"
            rows.forEach(row => {
                if (row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย") {
                    const sla = parseFloat(row.c[37]?.v) || 0;
                    if (sla > 0) {
                        totalSLA += sla;
                        count++;
                    }
                }
            });
            
            // คำนวณค่าเฉลี่ยและคืนค่า ปัดขึ้นเป็นจำนวนเต็ม
            return count > 0 ? Math.ceil(totalSLA / count) : '-';
        }

        // ฟังก์ชันคำนวณค่าเฉลี่ย SLA สำหรับสถานะเฉพาะ
        function calculateStatusSLA(rows, status) {
            let count = 0;
            let totalSLA = 0;
            
            // ดึงค่า SLA จากทุกแถวที่มีสถานะตามที่ระบุ
            rows.forEach(row => {
                if (row.c[34]?.v === status) {
                    const sla = parseFloat(row.c[37]?.v) || 0;
                    count++; // นับทุกแถวที่มีสถานะตรงกัน ไม่ว่าจะมี SLA หรือไม่
                    if (sla > 0) {
                        totalSLA += sla;
                    }
                }
            });
            
            return {
                average: count > 0 && totalSLA > 0 ? Math.ceil(totalSLA / count) : '-',
                count: count
            };
        }

        // ฟังก์ชันนับจำนวนช่างใหม่
        function countNewTechnicians(rows) {
            let count = 0;
            rows.forEach(row => {
                if (row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย") {
                    count++;
                }
            });
            return count;
        }

        // Function to search table data
        function searchTableData() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!searchTerm) {
                currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
                renderTableData(window.tableData);
                return;
            }

            const filteredData = window.tableData.filter(row => {
                return Object.values(row).some(value => {
                    if (value === null || value === undefined) return false;
                    return value.toString().toLowerCase().includes(searchTerm);
                });
            });

            currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
            renderTableData(filteredData);
        }

        // ฟังก์ชันกรองข้อมูลตามเดือน
        function filterTableByMonth(monthName) {
            if (!window.originalTableData) {
                // สำรองข้อมูลต้นฉบับหากยังไม่มี
                window.originalTableData = window.tableData ? [...window.tableData] : [];
            }
            
            if (monthName === 'all') {
                // กลับไปดูข้อมูลทั้งหมดโดยใช้ฟังก์ชันรีเซ็ต
                resetTableData();
                return;
            }
            
            // กรองข้อมูลตามเดือนที่เลือก
            const filteredData = window.originalTableData.filter(row => {
                // ตรวจสอบค่าในคอลัมน์เดือนอบรม
                // เนื่องจากเดือนอบรมอยู่ในรูปแบบ 'Jan25', 'Feb25', ฯลฯ
                // เราต้องตรวจสอบเฉพาะส่วนต้นของสตริงว่าเริ่มต้นด้วยเดือนที่เลือกหรือไม่
                return row.trainingMonth && row.trainingMonth.startsWith(monthName);
            });
            
            // แสดงข้อมูลทั้งหมดของเดือนที่เลือกโดยไม่มีการแบ่งหน้า
            renderAllMonthData(filteredData);
        }
        
        // ฟังก์ชันแสดงข้อมูลทั้งหมดของเดือนที่เลือก
        function renderAllMonthData(data) {
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            
            // แสดงข้อมูลทั้งหมดโดยไม่มีการแบ่งหน้า
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // ซ่อนตัวควบคุมการแบ่งหน้า
            const paginationContainer = document.querySelector('.pagination-container');
            paginationContainer.style.display = 'none';
            
            // แสดงข้อความแสดงจำนวนข้อมูลที่กรองออก
            const dataCountInfo = document.createElement('div');
            dataCountInfo.id = 'data-count-info';
            dataCountInfo.style.textAlign = 'right';
            dataCountInfo.style.marginTop = '10px';
            dataCountInfo.style.fontSize = '14px';
            dataCountInfo.style.color = '#666';
            dataCountInfo.textContent = `แสดงข้อมูลทั้งหมด ${data.length} รายการ`;
            
            // ลบข้อความเดิมถ้ามี
            const existingInfo = document.getElementById('data-count-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // แทรกข้อความใหม่หลังตาราง
            const dataTable = document.getElementById('data-table');
            dataTable.parentNode.insertBefore(dataCountInfo, dataTable.nextSibling);
        }

        // เพิ่ม event listener ให้ปุ่ม
        document.addEventListener('DOMContentLoaded', function() {
            // ลบ event listeners เดิมที่อาจมีอยู่
            const searchButton = document.getElementById('search-button');
            const searchInput = document.getElementById('search-input');
            const searchForm = document.querySelector('.search-container');

            // ลบ event listener เดิมและเพิ่มใหม่
            if (searchButton) {
                searchButton.replaceWith(searchButton.cloneNode(true));
                const newSearchButton = document.getElementById('search-button');
                
                // เพิ่ม event listener ใหม่
                newSearchButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    searchTableData();
                });
            }

            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    searchTableData();
                });
            }
            
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchTableData();
                    }
                });
            }

            const resetButton = document.getElementById('reset-filter-button');
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    resetTableData();
                });
            }

            const refreshButton = document.getElementById('refresh-button');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    // อัปเดตทั้งตารางหลักและกราฟ
                    fetchDataAndUpdateTable();
                });
            }
            
            const downloadButton = document.getElementById('download-button');
            if (downloadButton) {
                downloadButton.addEventListener('click', downloadTableAsExcel);
            }
            
            // Event Listeners สำหรับปุ่มแบ่งหน้า
            const prevButton = document.getElementById('prev-button');
            if (prevButton) {
                prevButton.addEventListener('click', function() {
                    if (currentPage > 1) {
                        goToPage(currentPage - 1);
                    }
                });
            }
            
            const nextButton = document.getElementById('next-button');
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    if (currentPage < totalPages) {
                        goToPage(currentPage + 1);
                    }
                });
            }
            
            // Event Listener สำหรับเลือกขนาดหน้า
            const pageSizeSelect = document.getElementById('page-size');
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', function() {
                    pageSize = parseInt(this.value);
                    currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
                    renderTableData(window.tableData);
                });
            }
            
            // เพิ่ม Event Listener สำหรับปุ่มเดือน
            const monthCards = document.querySelectorAll('.month-card');
            monthCards.forEach(card => {
                card.addEventListener('click', function() {
                    const selectedMonth = this.getAttribute('data-month');
                    filterTableByMonth(selectedMonth);
                    
                    // ไฮไลต์ปุ่มที่เลือก
                    monthCards.forEach(c => {
                        c.style.backgroundColor = '#f0f0f0';
                        c.style.color = 'black';
                    });
                    this.style.backgroundColor = '#003366';
                    this.style.color = 'white';
                });
            });

            // Event Listeners สำหรับตารางปัญหา
            const problemsSearchButton = document.getElementById('problems-search-button');
            const problemsSearchInput = document.getElementById('problems-search-input');
            const problemsResetButton = document.getElementById('problems-reset-filter-button');
            const problemsRefreshButton = document.getElementById('problems-refresh-button');
            const problemsDownloadButton = document.getElementById('problems-download-button');

            if (problemsSearchButton) {
                problemsSearchButton.addEventListener('click', searchProblemsTable);
            }

            if (problemsSearchInput) {
                problemsSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchProblemsTable();
                    }
                });
            }

            if (problemsResetButton) {
                problemsResetButton.addEventListener('click', resetProblemsTable);
            }

            if (problemsRefreshButton) {
                problemsRefreshButton.addEventListener('click', refreshProblemsTable);
            }

            if (problemsDownloadButton) {
                problemsDownloadButton.addEventListener('click', downloadProblemsTable);
            }




            
            fetchDataAndUpdateTable();
        });

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        updateCurrentDateTime();
        setInterval(updateCurrentDateTime, 1000);

        // ฟังก์ชันนับจำนวนช่างทั้งหมด
        function countTotalTechnicians(rows) {
            return rows.length;
        }

        // ฟังก์ชันตรวจสอบสถานะทั้งหมดที่มีในข้อมูล
        function getAllUniqueStatuses(rows) {
            const statuses = new Set();
            rows.forEach(row => {
                const status = row.c[34]?.v; // คอลัมน์ "Status ล่าสุด"
                if (status && status.trim()) {
                    statuses.add(status.trim());
                }
            });
            return Array.from(statuses).sort();
        }

        // ฟังก์ชันตรวจสอบว่าการ์ดครบหรือไม่
        function validateStatusCards(rows) {
            const allStatuses = getAllUniqueStatuses(rows);
            const cardStatuses = [
                'เอกสารยังไม่ครบ',
                'ไม่เข้าอบรม',
                'ไม่ผ่านอบรม',
                'ช่างลาออก',
                'ตัวแทนยังไม่ส่งขึ้นทะเบียน',
                'ติดประวัติอาชญากรรม',
                'อยู่ระหว่างอบรมทฤษฎี',
                'อยู่ระหว่างอบรมปฎิบัติ'
            ];
            
            // ตรวจสอบสถานะที่ขาดหายไป
            const missingStatuses = allStatuses.filter(status => !cardStatuses.includes(status));
            
            if (missingStatuses.length > 0) {
                console.warn('สถานะที่ขาดหายไปจากการ์ด:', missingStatuses);
            } else {
                console.log('การ์ดสถานะครบถ้วนแล้ว');
            }
            
            console.log('สถานะทั้งหมดในข้อมูล:', allStatuses);
            return { allStatuses, missingStatuses };
        }

        // ฟังก์ชันอัพเดทการ์ดสถานะต่างๆ
        function updateStatusCards(rows) {
            // ตรวจสอบสถานะก่อนอัปเดต
            validateStatusCards(rows);
            
            // Debug การนับ "ช่างลาออก"
            const resignedCount = debugStatusCount(rows, 'ช่างลาออก');
            console.log('จำนวน "ช่างลาออก" ที่นับได้:', resignedCount);
            
            const statuses = [
                { id: 'sla-incomplete-docs', status: 'เอกสารยังไม่ครบ' },
                { id: 'sla-not-attend', status: 'ไม่เข้าอบรม' },
                { id: 'sla-failed-training', status: 'ไม่ผ่านอบรม' },
                { id: 'sla-resigned', status: 'ช่างลาออก' },
                { id: 'sla-not-submitted', status: 'ตัวแทนยังไม่ส่งขึ้นทะเบียน' },
                { id: 'sla-criminal-record', status: 'ติดประวัติอาชญากรรม' },
                { id: 'sla-theory-training', status: 'อยู่ระหว่างอบรมทฤษฎี' },
                { id: 'sla-practical-training', status: 'อยู่ระหว่างอบรมปฎิบัติ' }
            ];

            statuses.forEach(item => {
                const result = calculateStatusSLA(rows, item.status);
                const element = document.getElementById(item.id);
                if (element) {
                    // Debug การ์ด "ช่างลาออก"
                    if (item.status === 'ช่างลาออก') {
                        console.log('ผลลัพธ์การคำนวณ "ช่างลาออก":', result);
                    }
                    
                    // แสดงทั้งจำนวนคนและ SLA เฉลี่ย
                    if (result.count > 0 && result.average !== '-') {
                        element.textContent = `${result.count} คน (${result.average} วัน)`;
                    } else if (result.count > 0) {
                        element.textContent = `${result.count} คน`;
                    } else {
                        element.textContent = '0 คน';
                    }
                }
            });
            
            // อัปเดต SLA Analysis
            updateSLAAnalysis(rows);
        }

        // ฟังก์ชันใหม่สำหรับการวิเคราะห์ SLA อย่างละเอียด
        function updateSLAAnalysis(rows) {
            // คำนวณ SLA เฉลี่ยสำหรับผู้ที่ขึ้นทะเบียนสำเร็จ
            const successRows = rows.filter(row => row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย");
            let successSLATotal = 0;
            let successCount = 0;
            
            successRows.forEach(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                if (sla > 0) {
                    successSLATotal += sla;
                    successCount++;
                }
            });
            
            const avgSuccessSLA = successCount > 0 ? Math.ceil(successSLATotal / successCount) : 0;
            
            // คำนวณ SLA เฉลี่ยทั้งหมด
            let totalSLA = 0;
            let totalCount = 0;
            
            rows.forEach(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                if (sla > 0) {
                    totalSLA += sla;
                    totalCount++;
                }
            });
            
            const avgTotalSLA = totalCount > 0 ? Math.ceil(totalSLA / totalCount) : 0;
            
            // อัปเดตการ์ด SLA
            document.getElementById('sla-success-avg').textContent = avgSuccessSLA > 0 ? `${avgSuccessSLA} วัน` : '-';
            document.getElementById('sla-overall-avg').textContent = avgTotalSLA > 0 ? `${avgTotalSLA} วัน` : '-';
            
            // ประเมินสถานะ SLA
            let slaStatus = '';
            let slaStatusColor = '';
            if (avgSuccessSLA <= 30) {
                slaStatus = 'ดีเยี่ยม';
                slaStatusColor = '#28a745';
            } else if (avgSuccessSLA <= 45) {
                slaStatus = 'ปานกลาง';
                slaStatusColor = '#ffc107';
            } else {
                slaStatus = 'ต้องปรับปรุง';
                slaStatusColor = '#dc3545';
            }
            
            const slaStatusElement = document.getElementById('sla-status');
            if (slaStatusElement) {
                slaStatusElement.textContent = slaStatus;
                slaStatusElement.parentElement.parentElement.style.backgroundColor = slaStatusColor;
            }
            
            // สร้างตาราง SLA Analysis
            createSLAAnalysisTable(rows);
            
            // อัปเดตตัวชี้วัดประสิทธิภาพ
            updateSLAPerformanceIndicators(rows);
        }

        // ฟังก์ชันสร้างตาราง SLA Analysis
        function createSLAAnalysisTable(rows) {
            const statusList = [
                "ขึ้นทะเบียนเรียบร้อย",
                "ช่างลาออก", 
                "ตัวแทนยังไม่ส่งขึ้นทะเบียน",
                "ติดประวัติอาชญากรรม",
                "อยู่ระหว่างอบรมปฎิบัติ",
                "เอกสารยังไม่ครบ",
                "อยู่ระหว่างอบรมทฤษฎี",
                "ไม่เข้าอบรม",
                "ไม่ผ่านอบรม"
            ];
            
            const tbody = document.getElementById('sla-analysis-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            statusList.forEach(status => {
                const statusRows = rows.filter(row => row.c[34]?.v === status);
                
                if (statusRows.length > 0) {
                    // ใช้ฟังก์ชัน calculateStatusSLA เพื่อให้ผลลัพธ์ตรงกับการ์ด
                    const result = calculateStatusSLA(rows, status);
                    const slaValues = statusRows.map(row => parseFloat(row.c[37]?.v) || 0).filter(sla => sla > 0);
                    
                    const maxSLA = slaValues.length > 0 ? Math.max(...slaValues) : 0;
                    const minSLA = slaValues.length > 0 ? Math.min(...slaValues) : 0;
                    
                    let assessment = '';
                    let assessmentColor = '';
                    
                    if (status === "ขึ้นทะเบียนเรียบร้อย") {
                        const avgSLANum = result.average !== '-' ? parseInt(result.average) : 0;
                        if (avgSLANum > 0 && avgSLANum <= 30) {
                            assessment = 'ดีเยี่ยม';
                            assessmentColor = '#28a745';
                        } else if (avgSLANum > 30 && avgSLANum <= 45) {
                            assessment = 'ปานกลาง';
                            assessmentColor = '#ffc107';
                        } else if (avgSLANum > 45) {
                            assessment = 'ต้องปรับปรุง';
                            assessmentColor = '#dc3545';
                        } else {
                            assessment = 'ต้องติดตาม';
                            assessmentColor = '#6c757d';
                        }
                    } else if (status === "ช่างลาออก" || status === "ติดประวัติอาชญากรรม" || status === "ไม่เข้าอบรม") {
                        assessment = 'ไม่ต้องติดตาม';
                        assessmentColor = '#28a745';
                    } else {
                        assessment = 'ต้องติดตาม';
                        assessmentColor = '#dc3545';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 8px; border: 1px solid #ddd;">${status}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${result.count}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${result.average}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${maxSLA > 0 ? Math.ceil(maxSLA) : '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${minSLA > 0 ? Math.ceil(minSLA) : '-'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background-color: ${assessmentColor}; color: white; font-weight: bold;">${assessment}</td>
                    `;
                    
                    tbody.appendChild(row);
                }
            });
        }

        // ฟังก์ชันอัปเดตตัวชี้วัดประสิทธิภาพ SLA
        function updateSLAPerformanceIndicators(rows) {
            const successRows = rows.filter(row => row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย");
            const totalRows = rows.filter(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                return sla > 0;
            });
            
            // คำนวณเปอร์เซ็นต์ขึ้นทะเบียนตรงเวลา (SLA <= 30 วัน)
            const onTimeCount = successRows.filter(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                return sla > 0 && sla <= 30;
            }).length;
            
            const onTimePercentage = successRows.length > 0 ? ((onTimeCount / successRows.length) * 100).toFixed(1) : 0;
            
            // คำนวณเปอร์เซ็นต์เกินกำหนด SLA (SLA > 30 วัน)
            const overdueCount = totalRows.filter(row => {
                const sla = parseFloat(row.c[37]?.v) || 0;
                return sla > 30;
            }).length;
            
            const overduePercentage = totalRows.length > 0 ? ((overdueCount / totalRows.length) * 100).toFixed(1) : 0;
            
            // นับกรณีที่ต้องติดตาม - คำนวณจากทุกสถานะยกเว้นสถานะที่ "ไม่ต้องติดตาม"
            const followUpCount = rows.filter(row => {
                const status = row.c[34]?.v;
                return status && status !== "ขึ้นทะเบียนเรียบร้อย" && 
                       status !== "ช่างลาออก" && 
                       status !== "ติดประวัติอาชญากรรม" && 
                       status !== "ไม่เข้าอบรม";
            }).length;
            
            // อัปเดตค่าในการ์ด
            document.getElementById('sla-ontime-percentage').textContent = `${onTimePercentage}%`;
            document.getElementById('sla-overdue-percentage').textContent = `${overduePercentage}%`;
            document.getElementById('sla-followup-count').textContent = `${followUpCount} คน`;
        }



        // เพิ่มฟังก์ชันสำหรับจัดการ Legend สำหรับกราฟ Month เท่านั้น
        function initializeLegendHandlers() {
            // เลือกเฉพาะ legend items ของกราฟ Month เท่านั้น (ไม่รวม Daily)
            const legendItems = document.querySelectorAll('#chart-container .chart-wrapper:first-child .legend-item');
            if (!chart || !chart.data || legendItems.length === 0) {
                return; // ถ้าไม่มีกราฟหรือ legend items ให้ข้ามไป
            }
            
            const datasets = chart.data.datasets;
            // ใช้ namespace แยกสำหรับกราฟ Month เท่านั้น
            let selectedItems = window.monthChartSelectedItems || new Set();
            window.monthChartSelectedItems = selectedItems;
            
            // เพิ่ม event listener สำหรับคลิกพื้นที่ว่าง - เฉพาะกราฟ Month
            document.addEventListener('click', (event) => {
                // ตรวจสอบว่าคลิกที่ legend-item ของกราฟ Month หรือไม่
                const clickedLegend = event.target.closest('#chart-container .chart-wrapper:first-child .legend-item');
                const clickedChart = event.target.closest('#myChart');
                const clickedDailyArea = event.target.closest('#chart-container .chart-wrapper:last-child');
                
                // ถ้าคลิกในพื้นที่ของกราฟ Daily ให้ข้ามการประมวลผล
                if (clickedDailyArea) {
                    return;
                }
                
                // ถ้าไม่ได้คลิกที่ legend-item และไม่ได้คลิกที่กราฟ Month ให้แสดงทุกรายการ
                if (!clickedLegend && !clickedChart) {
                    selectedItems.clear();
                    legendItems.forEach((item, i) => {
                        item.classList.remove('selected');
                        if (datasets[i]) datasets[i].hidden = false;
                    });
                    // อัปเดตเฉพาะกราฟ Month (chart) ไม่ส่งผลต่อกราฟ Daily
                    if (chart && chart !== window.dailyChart) {
                        chart.update('none');
                    }
                    // อัพเดทเฉพาะแผนภูมิและตาราง pivot โดยไม่กระทบตารางหลัก
                    updatePivotTable(filteredData2025);
                }
            });

            // จัดการการคลิกที่ Legend items ของกราฟ Month เท่านั้น
            legendItems.forEach((item, index) => {
                item.addEventListener('click', (event) => {
                    event.stopPropagation();
                    event.preventDefault();
                    
                    // ตรวจสอบว่าเป็น legend ของกราฟ Month จริงๆ
                    if (!event.target.closest('#chart-container .chart-wrapper:first-child')) {
                        return; // ถ้าไม่ใช่ ให้ข้ามการประมวลผล
                    }
                    if (event.ctrlKey || event.metaKey) {
                        if (selectedItems.has(index)) {
                            selectedItems.delete(index);
                            item.classList.remove('selected');
                        } else {
                            selectedItems.add(index);
                            item.classList.add('selected');
                        }
                    } else {
                        selectedItems.clear();
                        selectedItems.add(index);
                        legendItems.forEach((otherItem, i) => {
                            if (i === index) {
                                otherItem.classList.add('selected');
                            } else {
                                otherItem.classList.remove('selected');
                            }
                        });
                    }
                    window.monthChartSelectedItems = selectedItems;
                    // อัพเดทการแสดงผลกราฟ
                    datasets.forEach((dataset, i) => {
                        if (selectedItems.size === 0) {
                            // ถ้าไม่มีรายการที่ถูกเลือก แสดงทุกรายการ
                            dataset.hidden = false;
                        } else {
                            // ซ่อนรายการที่ไม่ได้เลือก
                            dataset.hidden = !selectedItems.has(i);
                        }
                    });

                    // อัปเดตเฉพาะกราฟ Month (chart) ไม่ส่งผลต่อกราฟ Daily
                    if (chart && chart !== window.dailyChart) {
                        chart.update('none');
                    }
                    
                    // อัพเดทเฉพาะตาราง pivot ไม่กระทบตารางหลัก
                    const selectedStatuses = Array.from(selectedItems).map(i => datasets[i].label);
                    const filteredRows = filteredData2025.filter(row => {
                        if (selectedItems.size === 0) {
                            return true; // แสดงข้อมูลทั้งหมด
                        } else {
                            return selectedStatuses.includes(row.c[34]?.v);
                        }
                    });
                    
                    // อัพเดทเฉพาะตาราง pivot โดยไม่เรียก updateTables
                    updatePivotTable(filteredRows);
                });
            });
        }

        // ฟังก์ชันเพื่อดาวน์โหลดตารางเป็น Excel
        function downloadTableAsExcel() {
            if (!window.XLSX) {
                alert('ไม่สามารถโหลด Excel library ได้ กรุณาลองใหม่อีกครั้ง');
                return;
            }

            // สร้างตาราง HTML ชั่วคราวที่มีข้อมูลทั้งหมด
            const tempTable = document.createElement('table');
            
            // คัดลอกส่วนหัวตาราง
            const headerRow = document.createElement('tr');
            const headers = document.querySelectorAll('#data-table th');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.textContent;
                headerRow.appendChild(th);
            });
            
            const thead = document.createElement('thead');
            thead.appendChild(headerRow);
            tempTable.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            
            if (window.tableData) {
                window.tableData.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.values(row).forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            }
            
            tempTable.appendChild(tbody);
            
            try {
                const workbook = XLSX.utils.table_to_book(tempTable, { sheet: "ข้อมูลการอบรมช่าง" });
                const now = new Date();
                const datePart = now.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\//g, '-');
                
                const filename = `ข้อมูลการอบรมช่าง_${datePart}.xlsx`;
                XLSX.writeFile(workbook, filename);
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการสร้างไฟล์ Excel:', error);
                alert('เกิดข้อผิดพลาดในการดาวน์โหลดไฟล์');
            }
        }

        // ฟังก์ชันแสดงข้อมูลในตาราง
        function renderTableData(data) {
            if (!data || data.length === 0) {
                console.warn("ไม่มีข้อมูลที่จะแสดง");
                return;
            }
            
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            
            // คำนวณข้อมูลสำหรับการแสดงหน้าปัจจุบัน
            totalPages = Math.ceil(data.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, data.length);
            const currentPageData = data.slice(startIndex, endIndex);
            
            // แสดงข้อมูลในตาราง
            currentPageData.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // แสดงตัวควบคุมการแบ่งหน้า
            const paginationContainer = document.querySelector('.pagination-container');
            if (paginationContainer) {
                paginationContainer.style.display = 'flex';
            }
            
            // ลบข้อความแสดงจำนวนข้อมูลที่กรองออก
            const existingInfo = document.getElementById('data-count-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // อัปเดตข้อมูลการแบ่งหน้า
            updatePagination(data.length);
        }
        
        // ฟังก์ชันอัปเดตข้อมูลการแบ่งหน้า
        function updatePagination(totalItems) {
            if (!totalItems || totalItems === 0) {
                console.warn("ไม่มีข้อมูลสำหรับการแบ่งหน้า");
                return;
            }
            
            // คำนวณจำนวนหน้าทั้งหมด
            totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
            
            // ปรับปรุงหน้าปัจจุบันไม่ให้เกินจำนวนหน้าทั้งหมด
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            
            const paginationInfo = document.getElementById('pagination-info');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const paginationPages = document.getElementById('pagination-pages');
            
            // อัปเดตข้อมูลหน้า
            paginationInfo.textContent = `หน้า ${currentPage} จาก ${totalPages} (รายการทั้งหมด ${totalItems})`;
            
            // อัปเดตสถานะปุ่ม
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
            
            // สร้างปุ่มหมายเลขหน้า
            paginationPages.innerHTML = '';
            
            // กำหนดจำนวนปุ่มหน้าที่จะแสดง
            const maxPageButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
            
            // ปรับค่า startPage เมื่อ endPage อยู่ที่ค่าสูงสุด
            if (endPage === totalPages) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }
            
            // แสดงปุ่มหมายเลขหน้าแรกถ้าต้องการ
            if (startPage > 1) {
                const firstPageButton = createPageButton(1);
                paginationPages.appendChild(firstPageButton);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('div');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    paginationPages.appendChild(ellipsis);
                }
            }
            
            // สร้างปุ่มหมายเลขหน้า
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = createPageButton(i);
                paginationPages.appendChild(pageButton);
            }
            
            // แสดงปุ่มหน้าสุดท้ายถ้าต้องการ
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('div');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    paginationPages.appendChild(ellipsis);
                }
                
                const lastPageButton = createPageButton(totalPages);
                paginationPages.appendChild(lastPageButton);
            }
        }
        
        // ฟังก์ชันสร้างปุ่มหมายเลขหน้า
        function createPageButton(pageNumber) {
            const pageButton = document.createElement('div');
            pageButton.className = 'page-number' + (pageNumber === currentPage ? ' active' : '');
            pageButton.textContent = pageNumber;
            pageButton.addEventListener('click', () => goToPage(pageNumber));
            return pageButton;
        }
        
        // ฟังก์ชันเปลี่ยนหน้า
        function goToPage(page) {
            currentPage = page;
            renderTableData(window.tableData);
        }

        // ตัวแปรเก็บสถานะการ sort
        let currentSort = {
            key: null,
            isAsc: true
        };

        // ฟังก์ชันจัดการการ sort
        function handleSort(key) {
            const isAsc = currentSort.key === key ? !currentSort.isAsc : true;
            currentSort = { key, isAsc };

            const sortedData = sortData(window.tableData, key, isAsc);
            renderTableData(sortedData);
            updateSortIndicators(key, isAsc);
        }

        // ฟังก์ชัน sort ข้อมูล
        function sortData(data, key, isAsc) {
            return [...data].sort((a, b) => {
                let valueA = a[key];
                let valueB = b[key];

                // จัดการค่าว่าง
                if (!valueA && valueA !== 0) return isAsc ? 1 : -1;
                if (!valueB && valueB !== 0) return isAsc ? -1 : 1;

                // จัดการข้อมูลตามประเภท
                if (key === 'week') {
                    valueA = parseInt(valueA.replace(/\D/g, '')) || 0;
                    valueB = parseInt(valueB.replace(/\D/g, '')) || 0;
                } else if (key === 'trainingMonth') {
                    const months = {
                        'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4,
                        'May': 5, 'Jun': 6, 'Jul': 7, 'Aug': 8,
                        'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
                    };
                    valueA = months[valueA.substring(0, 3)] || 0;
                    valueB = months[valueB.substring(0, 3)] || 0;
                } else if (key === 'startDate' || key === 'endDate') {
                    const parseDate = (str) => {
                        const [day, month, year] = (str || '').split('/').map(Number);
                        return day ? new Date(year, month - 1, day) : new Date(0);
                    };
                    valueA = parseDate(valueA);
                    valueB = parseDate(valueB);
                } else if (key === 'sla') {
                    valueA = parseFloat(valueA) || 0;
                    valueB = parseFloat(valueB) || 0;
                }

                // เปรียบเทียบค่า
                if (valueA instanceof Date) {
                    return isAsc ? valueA - valueB : valueB - valueA;
                }
                if (typeof valueA === 'number') {
                    return isAsc ? valueA - valueB : valueB - valueA;
                }
                return isAsc ? 
                    String(valueA).localeCompare(String(valueB), 'th') : 
                    String(valueB).localeCompare(String(valueA), 'th');
            });
        }

        // ฟังก์ชันอัปเดตไอคอน sort
        function updateSortIndicators(key, isAsc) {
            const headers = document.querySelectorAll('#data-table th');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.key === key) {
                    header.classList.add(isAsc ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // ฟังก์ชันแสดงข้อมูลในตาราง Pivot
        function updatePivotTable(rows) {
            const pivotHeader = document.getElementById('pivot-header');
            const pivotBody = document.getElementById('pivot-body');
            
            // กำหนดหัวข้อคอลัมน์
            const columns = [
                "ขึ้นทะเบียนเรียบร้อย",
                "ช่างลาออก",
                "ตัวแทนยังไม่ส่งขึ้นทะเบียน",
                "ติดประวัติอาชญากรรม",
                "อยู่ระหว่างอบรมปฎิบัติ",
                "เอกสารยังไม่ครบ",
                "อยู่ระหว่างอบรมทฤษฎี",
                "ไม่ผ่านอบรม",
                "Grand Total"
            ];

            // เฉพาะเดือนปัจจุบัน (Jun25)
            const currentMonth = 'Jun25';
            
            // อัพเดทชื่อตาราง
            document.getElementById('pivot-table-title').textContent = `สถานะการอบรมช่างใหม่รายพื้นที่ June 2025`;
            
            // สร้างส่วนหัวตาราง
            pivotHeader.innerHTML = `
                <th>พื้นที่</th>
                ${columns.map(col => `<th>${col}</th>`).join('')}
            `;

            // เตรียมข้อมูลสำหรับตาราง
            const areas = [
                "RSM1_BMA-West", "RSM2_BMA-East", "RSM3_UPC-East", "RSM4_UPC-NOR",
                "RSM5_UPC-NOE1", "RSM6_UPC-NOE2", "RSM7_UPC-CEW", "RSM8_UPC-SOU"
            ];

            let tableHTML = '';
            let finalGrandTotal = new Array(columns.length).fill(0);

            // สร้างข้อมูลตาราง
            areas.forEach(area => {
                const areaData = rows.filter(row => {
                    const endDateMonth = getMonthFromEndDate(row.c[36]?.v);
                    return row.c[26]?.v === area && endDateMonth === currentMonth;
                });

                if (areaData.length > 0) {
                    const rowData = [
                        areaData.filter(row => row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย").length,
                        areaData.filter(row => row.c[34]?.v === "ช่างลาออก").length,
                        areaData.filter(row => row.c[34]?.v === "ตัวแทนยังไม่ส่งขึ้นทะเบียน").length,
                        areaData.filter(row => row.c[34]?.v === "ติดประวัติอาชญากรรม").length,
                        areaData.filter(row => row.c[34]?.v === "อยู่ระหว่างอบรมปฎิบัติ").length,
                        areaData.filter(row => row.c[34]?.v === "เอกสารยังไม่ครบ").length,
                        areaData.filter(row => row.c[34]?.v === "อยู่ระหว่างอบรมทฤษฎี").length,
                        areaData.filter(row => row.c[34]?.v === "ไม่ผ่านอบรม").length
                    ];

                    const areaTotal = rowData.reduce((a, b) => a + b, 0);
                    rowData.push(areaTotal);

                    tableHTML += `
                        <tr>
                            <td>${area}</td>
                            ${rowData.map(val => `<td>${val || ''}</td>`).join('')}
                        </tr>
                    `;

                    rowData.forEach((val, idx) => {
                        finalGrandTotal[idx] += val;
                    });
                }
            });

            tableHTML += `
                <tr class="grand-total">
                    <td>Grand Total</td>
                    ${finalGrandTotal.map(val => `<td>${val || ''}</td>`).join('')}
                </tr>
            `;

            pivotBody.innerHTML = tableHTML;
        }

        function resetTableData() {
            if (!window.originalTableData) return;
            
            window.tableData = [...window.originalTableData];
            currentPage = 1;
            
            const paginationContainer = document.querySelector('.pagination-container');
            if (paginationContainer) {
                paginationContainer.style.display = 'flex';
            }
            
            const existingInfo = document.getElementById('data-count-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            const monthCards = document.querySelectorAll('.month-card');
            monthCards.forEach(card => {
                card.style.backgroundColor = '#f0f0f0';
                card.style.color = 'black';
            });
            
            const allButton = document.querySelector('.month-card[data-month="all"]');
            if (allButton) {
                allButton.style.backgroundColor = '#003366';
                allButton.style.color = 'white';
            }
            
            renderTableData(window.originalTableData);
        }

        // เพิ่มฟังก์ชัน debug เพื่อตรวจสอบข้อมูล
        function debugStatusCount(rows, targetStatus) {
            console.log(`=== Debug สถานะ: ${targetStatus} ===`);
            console.log('ข้อมูลทั้งหมด:', rows.length, 'แถว');
            
            const matchedRows = rows.filter(row => row.c[34]?.v === targetStatus);
            console.log(`แถวที่ตรงกับสถานะ "${targetStatus}":`, matchedRows.length);
            
            // แสดงตัวอย่าง 5 แถวแรก
            matchedRows.slice(0, 5).forEach((row, index) => {
                console.log(`แถวที่ ${index + 1}:`, {
                    name: row.c[3]?.v,
                    status: row.c[34]?.v,
                    sla: row.c[37]?.v,
                    month: row.c[28]?.v
                });
            });
            
            return matchedRows.length;
        }

        // ฟังก์ชันตรวจสอบความถูกต้องของการนับ
        function validateAllStatusCounts(rows) {
            console.log('\n=== ตรวจสอบความถูกต้องของการนับทั้งหมด ===');
            
            const statuses = [
                'เอกสารยังไม่ครบ',
                'ไม่เข้าอบรม',
                'ไม่ผ่านอบรม',
                'ช่างลาออก',
                'ตัวแทนยังไม่ส่งขึ้นทะเบียน',
                'ติดประวัติอาชญากรรม',
                'อยู่ระหว่างอบรมทฤษฎี',
                'อยู่ระหว่างอบรมปฎิบัติ',
                'ขึ้นทะเบียนเรียบร้อย'
            ];

            const validationResults = {};
            
            statuses.forEach(status => {
                // นับจากข้อมูลจริง
                const actualCount = rows.filter(row => row.c[34]?.v === status).length;
                
                // คำนวณจาก calculateStatusSLA
                const calculatedResult = calculateStatusSLA(rows, status);
                
                validationResults[status] = {
                    actualCount: actualCount,
                    calculatedCount: calculatedResult.count,
                    match: actualCount === calculatedResult.count,
                    slaAverage: calculatedResult.average
                };
                
                console.log(`${status}:`);
                console.log(`  - นับจริง: ${actualCount} คน`);
                console.log(`  - นับจากฟังก์ชัน: ${calculatedResult.count} คน`);
                console.log(`  - SLA เฉลี่ย: ${calculatedResult.average}`);
                console.log(`  - ตรงกัน: ${actualCount === calculatedResult.count ? '✓' : '✗'}`);
                console.log('');
            });

            // แสดงผลสรุป
            const mismatches = Object.entries(validationResults)
                .filter(([_, result]) => !result.match);
            
            if (mismatches.length === 0) {
                console.log('✅ การนับทั้งหมดถูกต้อง!');
            } else {
                console.warn('❌ พบความไม่ตรงกัน:');
                mismatches.forEach(([status, result]) => {
                    console.warn(`  - ${status}: จริง ${result.actualCount} vs คำนวณ ${result.calculatedCount}`);
                });
            }

            return validationResults;
        }

        // ฟังก์ชันแสดงสรุปข้อมูลการ์ดทั้งหมด
        function showStatusCardsSummary() {
            if (!filteredData2025) {
                alert('ยังไม่มีข้อมูล กรุณารอสักครู่แล้วลองใหม่');
                return;
            }

            const validation = validateAllStatusCounts(filteredData2025);
            
            let summaryText = 'สรุปการ์ดสถานะทั้งหมด:\n\n';
            
            const cardElements = [
                { id: 'sla-incomplete-docs', name: 'เอกสารยังไม่ครบ' },
                { id: 'sla-not-attend', name: 'ไม่เข้าอบรม' },
                { id: 'sla-failed-training', name: 'ไม่ผ่านอบรม' },
                { id: 'sla-resigned', name: 'ช่างลาออก' },
                { id: 'sla-not-submitted', name: 'ตัวแทนยังไม่ส่งขึ้นทะเบียน' },
                { id: 'sla-criminal-record', name: 'ติดประวัติอาชญากรรม' },
                { id: 'sla-theory-training', name: 'อยู่ระหว่างอบรมทฤษฎี' },
                { id: 'sla-practical-training', name: 'อยู่ระหว่างอบรมปฎิบัติ' }
            ];

            cardElements.forEach(card => {
                const element = document.getElementById(card.id);
                const displayValue = element ? element.textContent : 'ไม่พบ';
                const validationData = validation[card.name];
                
                summaryText += `${card.name}:\n`;
                summaryText += `  การ์ดแสดง: ${displayValue}\n`;
                summaryText += `  ข้อมูลจริง: ${validationData.actualCount} คน\n`;
                summaryText += `  สถานะ: ${validationData.match ? '✓ ถูกต้อง' : '✗ ไม่ตรงกัน'}\n\n`;
            });

            // เพิ่มข้อมูลรวม
            const totalCount = filteredData2025.length;
            const registeredCount = filteredData2025.filter(row => row.c[34]?.v === 'ขึ้นทะเบียนเรียบร้อย').length;
            
            summaryText += `ข้อมูลรวม:\n`;
            summaryText += `จำนวนช่างทั้งหมด: ${totalCount} คน\n`;
            summaryText += `ขึ้นทะเบียนเรียบร้อย: ${registeredCount} คน\n`;

            alert(summaryText);
        }

        // ฟังก์ชันโหลดข้อมูลรายงานประจำวัน
        function loadDailyReport() {
            if (!filteredData2025 || filteredData2025.length === 0) {
                console.warn('ยังไม่มีข้อมูลสำหรับรายงานประจำวัน');
                return;
            }

            // ใช้ข้อมูลทั้งหมดของปี 2025 (ไม่กรองตาม trainingMonth)
            console.log(`ข้อมูลทั้งหมดปี 2025:`, filteredData2025.length, 'รายการ');

            // กรองข้อมูลที่มีวันที่เดือน 6 สำหรับการคำนวณสถิติ
            const juneRelatedData = filteredData2025.filter(row => {
                const endDate = row.c[36]?.v || '';
                const startDate = row.c[35]?.v || '';
                const trainingMonth = row.c[28]?.v || '';
                
                return (endDate.includes('/6/2025') || endDate.includes('/06/2025')) ||
                       (startDate.includes('/6/2025') || startDate.includes('/06/2025')) ||
                       trainingMonth === 'Jun25';
            });

            console.log(`ข้อมูลที่เกี่ยวข้องกับเดือน 6:`, juneRelatedData.length, 'รายการ');

            // คำนวณสถิติรายงานประจำวัน
            const totalRegistered = juneRelatedData.length;
            const successCount = juneRelatedData.filter(row => row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย").length;
            
            // นับปัญหาต่างๆ
            const problemStatuses = [
                'ไม่เข้าอบรม', 'ไม่ผ่านอบรม', 'ช่างลาออก', 
                'ติดประวัติอาชญากรรม', 'เอกสารยังไม่ครบ', 'ตัวแทนยังไม่ส่งขึ้นทะเบียน'
            ];
            
            const issuesCount = juneRelatedData.filter(row => 
                problemStatuses.includes(row.c[34]?.v)
            ).length;
            
            const successRate = totalRegistered > 0 ? ((successCount / totalRegistered) * 100).toFixed(1) : 0;

            // อัปเดตการ์ดสรุม
            document.getElementById('daily-total-registered').textContent = totalRegistered + ' คน';
            document.getElementById('daily-success-count').textContent = successCount + ' คน';
            document.getElementById('daily-issues-count').textContent = issuesCount + ' คน';
            document.getElementById('daily-success-rate').textContent = successRate + '%';



            // สร้างตารางรายชื่อช่างที่มีปัญหา (ใช้ข้อมูลที่เกี่ยวข้องกับเดือน 6)
            createProblemsTable(juneRelatedData, problemStatuses);

            // สร้างกราฟรายวัน (ใช้ข้อมูลทั้งหมดปี 2025)
            createDailyChart(filteredData2025);

            console.log('✅ โหลดรายงานประจำวันเสร็จสิ้น');
        }

                 // ฟังก์ชันสร้างตารางรายชื่อช่างที่มีปัญหา
         function createProblemsTable(data, problemStatuses) {
             // กรองสถานะที่ไม่ต้องการแสดงในตารางปัญหา
             const filteredProblemStatuses = problemStatuses.filter(status => 
                 status !== 'ช่างลาออก' && status !== 'ติดประวัติอาชญากรรม'
             );
             
             // กำหนดชื่อเอกสารตามคอลัมน์
             const documentTypes = {
                 'R': 'บัตรประชาชน',
                 'S': 'วุฒิการศึกษา', 
                 'U': 'ใบรับรองแพทย์',
                 'W': 'ใบขับขี่',
                 'X': 'เอกสารประวัติอาชญากรรม'
             };

             // รวมข้อมูลช่างที่มีปัญหาและเอกสารที่ขาด
             const allProblemsData = [];
             
             data.forEach(row => {
                 const status = row.c[34]?.v || '';
                 const name = row.c[3]?.v || '-';
                 const area = row.c[26]?.v || '-';
                 const sla = row.c[37]?.v || '-';
                 const agent = row.c[6]?.v || '-'; // เปลี่ยนจาก index 4 เป็น 6 (คอลัมน์ G)
                 
                 // ตรวจสอบเอกสารที่ขาด
                 const missingDocuments = [];
                 const documentColumns = {
                     'R': row.c[17]?.v || '',
                     'S': row.c[18]?.v || '',
                     'U': row.c[20]?.v || '',
                     'W': row.c[22]?.v || '',
                     'X': row.c[23]?.v || ''
                 };
                 
                 Object.keys(documentColumns).forEach(colKey => {
                     const docValue = documentColumns[colKey];
                     const docType = documentTypes[colKey];
                     
                     // ตรวจสอบเอกสารที่ขาด
                     let isMissing = false;
                     
                     if (colKey === 'S') {
                         // คอลัมน์วุฒิการศึกษา (คอลัมน์ 18) - มีคำอะไรก็ได้ถือว่าครบ ยกเว้น "ยังไม่ส่งเอกสาร" และค่าว่าง
                         isMissing = !docValue || docValue.trim() === '' || docValue.includes('ยังไม่ส่งเอกสาร');
                     } else {
                         // คอลัมน์อื่นๆ - ตรวจสอบค่าว่างหรือมีคำว่า "ยังไม่ส่งเอกสาร"
                         isMissing = !docValue || docValue.trim() === '' || docValue.includes('ยังไม่ส่งเอกสาร');
                     }
                     
                     if (isMissing) {
                         missingDocuments.push(docType);
                     }
                 });
                 
                 // เพิ่มข้อมูลถ้ามีปัญหาหรือมีเอกสารขาด (ใช้ filteredProblemStatuses แทน)
                 if ((filteredProblemStatuses.includes(status) || missingDocuments.length > 0) && status !== 'ขึ้นทะเบียนเรียบร้อย' && status !== 'ช่างลาออก' && status !== 'ไม่เข้าอบรม') {
                     allProblemsData.push({
                         name: name,
                         area: area,
                         status: status,
                         missingDocs: missingDocuments,
                         sla: sla,
                         agent: agent,
                         slaNumber: parseFloat(sla) || 0
                     });
                 }
             });
             
             // เรียงลำดับตาม SLA จากมากไปน้อย
             allProblemsData.sort((a, b) => b.slaNumber - a.slaNumber);

             // เก็บข้อมูลไว้ในตัวแปร global
             originalProblemsData = allProblemsData;
             
             // แสดงผลตาราง
             renderProblemsTable(allProblemsData);
         }

         // ฟังก์ชันสร้างกราฟรายเดือน
         function createDailyChart(data) {
             try {
                 const canvas = document.getElementById('dailyChart');
                 if (!canvas) {
                     console.error('❌ ไม่พบ canvas element สำหรับกราฟรายเดือน');
                     return;
                 }

                 // ตรวจสอบว่า Chart.js โหลดแล้วหรือยัง
                 if (typeof Chart === 'undefined') {
                     setTimeout(() => createDailyChart(data), 1000);
                     return;
                 }

                 // ทำลายกราฟเดิมถ้ามี
                 if (window.dailyChart && typeof window.dailyChart.destroy === 'function') {
                     window.dailyChart.destroy();
                 }

             // จัดกลุ่มข้อมูลตามวันและสถานะ
             const dailyStatusData = {}; // เก็บข้อมูลสถานะแยกตามวัน
             const allDates = new Set();
             
             // กำหนดสถานะต่างๆ และสี
             const statusList = [
                 "ขึ้นทะเบียนเรียบร้อย",
                 "ช่างลาออก", 
                 "ตัวแทนยังไม่ส่งขึ้นทะเบียน",
                 "ติดประวัติอาชญากรรม",
                 "อยู่ระหว่างอบรมปฎิบัติ",
                 "เอกสารยังไม่ครบ",
                 "อยู่ระหว่างอบรมทฤษฎี",
                 "ไม่เข้าอบรม",
                 "ไม่ผ่านอบรม"
             ];
             
                          console.log('🔍 เริ่มประมวลผลข้อมูลกราฟรายวัน:', data.length, 'แถว');
             
             // ตรวจสอบข้อมูลที่มีวันสิ้นสุดทั้งหมดก่อน
             let totalDataCount = 0;
             let validDateCount = 0;
             
             data.forEach((row, index) => {
                 if (!row || !row.c) return;
                 
                 // ใช้เฉพาะคอลัมน์ AK (วันสิ้นสุด) เป็นหลักในการกรองข้อมูล
                 const endDate = row.c[36]?.v; // คอลัมน์ AK - วันสิ้นสุด
                 const status = row.c[34]?.v; // คอลัมน์ AI - สถานะ
                 
                 // ตรวจสอบว่ามีวันสิ้นสุดและสถานะที่ถูกต้อง
                 const hasValidEndDate = endDate && typeof endDate === 'string' && endDate.trim() !== '';
                 
                 if (hasValidEndDate) {
                     totalDataCount++;
                 }
                 
                 // ประมวลผลข้อมูลที่มีวันสิ้นสุดและสถานะที่ถูกต้อง
                 if (hasValidEndDate && status && statusList.includes(status)) {
                     // ใช้วันที่โดยตรง แทนการแปลงเป็นเดือน/ปี
                     const dateString = formatDateForChart(endDate);
                     
                     if (dateString) {
                         // กรองเฉพาะเดือน June (6) และ July (7)
                         const dateMatch = dateString.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                         if (dateMatch) {
                             const month = parseInt(dateMatch[2]);
                             
                             // แสดงเฉพาะเดือน June (6) และ July (7)
                             if (month === 6 || month === 7) {
                                 validDateCount++;
                                 allDates.add(dateString);
                                 
                                 // เริ่มต้นข้อมูลวัน
                                 if (!dailyStatusData[dateString]) {
                                     dailyStatusData[dateString] = {};
                                     statusList.forEach(statusType => {
                                         dailyStatusData[dateString][statusType] = 0;
                                     });
                                 }
                                 
                                 // นับจำนวนสถานะในแต่ละวัน
                                 dailyStatusData[dateString][status]++;
                             }
                         }
                     }
                 }
             });
             
             console.log(`📊 สรุปการประมวลผล: พบข้อมูลที่มีวันสิ้นสุด ${totalDataCount} แถว, ประมวลผลได้ ${validDateCount} แถว, วันทั้งหมด ${allDates.size} วัน`);
             
             // Debug: แสดงวันทั้งหมดที่ถูกประมวลผล
             const sortedAllDates = Array.from(allDates).sort();
             console.log('📅 วันทั้งหมดที่ประมวลผล:', sortedAllDates);
             
             // Debug: แสดงจำนวนข้อมูลแต่ละวัน
             const dateCount = {};
             sortedAllDates.forEach(date => {
                 const totalCount = Object.values(dailyStatusData[date] || {}).reduce((sum, count) => sum + count, 0);
                 dateCount[date] = totalCount;
             });
             console.log('📊 จำนวนคนในแต่ละวัน:', dateCount);
             
             // Debug: แสดงข้อมูลตัวอย่างจาก dailyStatusData
             console.log('🗓️ ตัวอย่างข้อมูล dailyStatusData:');
             let dateIndex = 0;
             for (const [date, statusData] of Object.entries(dailyStatusData)) {
                 if (dateIndex < 5) {
                     const total = Object.values(statusData).reduce((sum, count) => sum + count, 0);
                     console.log(`  ${date}: รวม ${total} คน`, statusData);
                     dateIndex++;
                 }
             }

             // เรียงลำดับวันตามเวลาจริง
             const sortedDates = Array.from(allDates).sort((a, b) => {
                 // แปลงจาก dd/mm/yyyy เป็น Date object เพื่อเปรียบเทียบ
                 const [dayA, monthA, yearA] = a.split('/').map(Number);
                 const [dayB, monthB, yearB] = b.split('/').map(Number);
                 
                 const dateA = new Date(yearA, monthA - 1, dayA);
                 const dateB = new Date(yearB, monthB - 1, dayB);
                 
                 return dateA - dateB;
             });

             // ตรวจสอบว่ามีข้อมูลหรือไม่
             if (sortedDates.length === 0) {
                 console.warn('ไม่มีข้อมูลสำหรับสร้างกราฟ');
                 const ctx = canvas.getContext('2d');
                 ctx.fillStyle = '#6c757d';
                 ctx.font = '16px Arial';
                 ctx.textAlign = 'center';
                 ctx.fillText('ไม่มีข้อมูลสำหรับแสดงกราฟ', canvas.width / 2, canvas.height / 2);
                 return;
             }
             
             // Debug: ตรวจสอบจำนวนข้อมูล
             console.log('📊 จำนวนวันที่จะแสดงในกราฟ:', sortedDates.length);
             console.log('📊 วันที่เรียงลำดับแล้ว:', sortedDates);

             // กำหนดสีสำหรับสถานะแต่ละประเภท (ใช้สีเดียวกับกราฟหลัก)
             const statusColors = [
                 '#006400', // ขึ้นทะเบียนเรียบร้อย
                 '#FF6B00', // ช่างลาออก
                 '#FF1493', // ตัวแทนยังไม่ส่งขึ้นทะเบียน
                 '#4169E1', // ติดประวัติอาชญากรรม
                 '#90EE90', // อยู่ระหว่างอบรมปฎิบัติ
                 '#008080', // เอกสารยังไม่ครบ
                 '#4CA64C', // อยู่ระหว่างอบรมทฤษฎี
                 '#DC143C', // ไม่เข้าอบรม
                 '#FF69B4'  // ไม่ผ่านอบรม
             ];

             // สร้าง datasets สำหรับสถานะแต่ละประเภท (stacked by status)
             const datasets = statusList.map((status, index) => ({
                 label: status,
                 data: sortedDates.map(date => {
                     return dailyStatusData[date] && dailyStatusData[date][status] 
                         ? dailyStatusData[date][status] 
                         : 0;
                 }),
                 backgroundColor: statusColors[index] || '#6c757d',
                 borderColor: statusColors[index] || '#6c757d',
                 borderWidth: 1
             }));

             // เตรียมข้อมูลสำหรับกราฟ
             const chartData = {
                 labels: sortedDates,
                 datasets: datasets
             };

            // คำนวณค่า max สำหรับ Daily Chart
            const maxDailyValue = Math.max(...sortedDates.map(date => {
                return datasets.reduce((sum, dataset) => {
                    const dateIndex = sortedDates.indexOf(date);
                    return sum + (dataset.data[dateIndex] || 0);
                }, 0);
            }));
            
            // กำหนด max ของแกน Y ให้เหมาะสมกับข้อมูล
            const dynamicDailyMax = Math.max(50, Math.ceil(maxDailyValue * 1.2 / 10) * 10);

                                      // Debug: แสดงข้อมูลกราฟ
             console.log('📊 ข้อมูลสำหรับกราฟรายวัน:', sortedDates.length, 'วัน');

                const ctx = canvas.getContext('2d');
                
                // ใช้ขนาดที่เหมาะสมและ responsive
                canvas.width = 800;
                canvas.height = 400;
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '400px';
                canvas.style.width = '100%';
                canvas.style.height = 'auto';
                

                
                window.dailyChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        layout: {
                            padding: {
                                left: 20,
                                right: 20,
                                top: 30,
                                bottom: 30
                            }
                        },

                        plugins: {
                            legend: {
                                display: false
                            },
                            datalabels: {
                                color: 'white',
                                anchor: 'center',
                                align: 'center',
                                formatter: function(value, context) {
                                    return value > 0 ? value : '';
                                },
                                font: {
                                    weight: 'bold',
                                    size: 11
                                }
                            },
                            tooltip: {
                                titleFont: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 11
                                },
                                footerFont: {
                                    size: 10
                                },
                                filter: function(tooltipItem) {
                                    // แสดงเฉพาะ tooltipItem ที่มีค่าไม่เท่ากับ 0
                                    return tooltipItem.raw !== 0;
                                },
                                callbacks: {
                                    footer: function(tooltipItems) {
                                        const dateKey = tooltipItems[0].label;
                                        const dateData = dailyStatusData[dateKey] || {};
                                        
                                        // คำนวณยอดรวมสถานะ
                                        const totalStatuses = Object.values(dateData).reduce((sum, count) => sum + count, 0);
                                        
                                        let footer = `วันที่: ${dateKey}\nรวมทั้งหมด: ${totalStatuses} คน`;
                                        
                                        // แสดงรายละเอียดสถานะแต่ละประเภท (เฉพาะที่ไม่เท่ากับ 0)
                                        const statusSummary = [];
                                        Object.keys(dateData).forEach(statusType => {
                                            if (dateData[statusType] > 0) {
                                                statusSummary.push(`${statusType}: ${dateData[statusType]} คน`);
                                            }
                                        });
                                        
                                        if (statusSummary.length > 0) {
                                            footer += `\n\nรายละเอียด:\n${statusSummary.join('\n')}`;
                                        }
                                        
                                        return footer;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'วันที่',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                max: dynamicDailyMax,
                                title: {
                                    display: true,
                                    text: 'จำนวนช่าง (คน)',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    stepSize: Math.max(5, Math.ceil(dynamicDailyMax / 20)),
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels, {
                        // Plugin สำหรับแสดงยอดรวมบนแท่งกราห
                        afterDatasetsDraw: function(chart) {
                            const ctx = chart.ctx;
                            const datasets = chart.data.datasets;
                            const labels = chart.data.labels;
                            
                            labels.forEach((label, i) => {
                                let sum = 0;
                                datasets.forEach(ds => {
                                    if (!ds.hidden) sum += ds.data[i] || 0;
                                });
                                
                                if (sum > 0) {
                                    // หาตำแหน่ง y สูงสุดของแท่ง
                                    let topY = null;
                                    for (let d = datasets.length - 1; d >= 0; d--) {
                                        if (!datasets[d].hidden && datasets[d].data[i] > 0) {
                                            const meta = chart.getDatasetMeta(d);
                                            if (meta && meta.data[i]) {
                                                topY = meta.data[i].y;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (topY !== null) {
                                        const meta = chart.getDatasetMeta(0);
                                        const x = meta.data[i].x;
                                        const y = topY - 15;
                                        
                                        ctx.save();
                                        ctx.font = 'bold 11px Arial';
                                        ctx.fillStyle = '#000';
                                        ctx.textAlign = 'center';
                                        ctx.fillText(sum + ' คน', x, y);
                                        ctx.restore();
                                    }
                                }
                            });
                        }
                    }]
                });
                
                console.log('✅ สร้างกราฟรายวันสำเร็จ');
                
                // เพิ่ม dailyChartController สำหรับ custom legend
                window.dailyChartController = {
                    selectedDataset: null,
                    
                    initLegendEvents: function() {
                        const dailyLegendItems = document.querySelectorAll('#daily-legend-container .legend-item');
                        
                        dailyLegendItems.forEach((legendItem) => {
                            legendItem.addEventListener('click', function(event) {
                                event.stopPropagation();
                                event.preventDefault();
                                
                                const datasetIndex = parseInt(this.getAttribute('data-dataset'));
                                
                                if (window.dailyChart && window.dailyChart.data && window.dailyChart.data.datasets[datasetIndex]) {
                                    // ถ้าคลิกที่ dataset เดิมให้แสดงทั้งหมด
                                    if (window.dailyChartController.selectedDataset === datasetIndex) {
                                        window.dailyChartController.showAllDatasets();
                                    } else {
                                        window.dailyChartController.showOnlyDataset(datasetIndex);
                                    }
                                }
                            });
                        });
                    },
                    
                    showAllDatasets: function() {
                        this.selectedDataset = null;
                        
                        // แสดงทั้งหมดในกราฟ Daily
                        if (window.dailyChart && window.dailyChart.data) {
                            window.dailyChart.data.datasets.forEach((dataset, i) => {
                                const meta = window.dailyChart.getDatasetMeta(i);
                                if (meta) meta.hidden = false;
                            });
                        }
                        
                        // รีเซ็ต legend styles
                        const dailyLegendItems = document.querySelectorAll('#daily-legend-container .legend-item');
                        dailyLegendItems.forEach(item => {
                            item.style.opacity = '1';
                            item.style.backgroundColor = '';
                            item.classList.remove('selected');
                        });
                        
                        // อัปเดตกราฟ
                        if (window.dailyChart) {
                            window.dailyChart.update('none');
                        }
                    },
                    
                    showOnlyDataset: function(datasetIndex) {
                        this.selectedDataset = datasetIndex;
                        
                        // ซ่อนทั้งหมดยกเว้นที่เลือก
                        if (window.dailyChart && window.dailyChart.data) {
                            window.dailyChart.data.datasets.forEach((dataset, i) => {
                                const meta = window.dailyChart.getDatasetMeta(i);
                                if (meta) meta.hidden = (i !== datasetIndex);
                            });
                        }
                        
                        // อัปเดต legend styles
                        const dailyLegendItems = document.querySelectorAll('#daily-legend-container .legend-item');
                        dailyLegendItems.forEach((item) => {
                            const itemDatasetIndex = parseInt(item.getAttribute('data-dataset'));
                            if (itemDatasetIndex === datasetIndex) {
                                item.style.opacity = '1';
                                item.style.backgroundColor = '#e3f2fd';
                                item.classList.add('selected');
                            } else {
                                item.style.opacity = '0.5';
                                item.style.backgroundColor = '';
                                item.classList.remove('selected');
                            }
                        });
                        
                        // อัปเดตกราฟ
                        if (window.dailyChart) {
                            window.dailyChart.update('none');
                        }
                    }
                };
                
                // เริ่มต้น legend events
                window.dailyChartController.initLegendEvents();
                
                // Event listener สำหรับคลิกพื้นที่ว่าง
                document.addEventListener('click', function(event) {
                    const clickedDailyLegend = event.target.closest('#daily-legend-container .legend-item');
                    const clickedDailyChart = event.target.closest('#dailyChart');
                    
                    // ถ้าไม่ได้คลิกที่ legend หรือกราฟ ให้แสดงทุกสถานะ
                    if (!clickedDailyLegend && !clickedDailyChart && window.dailyChartController.selectedDataset !== null) {
                        window.dailyChartController.showAllDatasets();
                    }
                });
                
             } catch (error) {
                 console.error('❌ เกิดข้อผิดพลาดในการสร้างกราฟรายวัน:', error);
                 
                 // แสดงข้อความ error ในกราฟ
                 const canvas = document.getElementById('dailyChart');
                 if (canvas) {
                     const ctx = canvas.getContext('2d');
                     ctx.fillStyle = '#dc3545';
                     ctx.font = '16px Arial';
                     ctx.textAlign = 'center';
                     ctx.fillText('ไม่สามารถโหลดกราฟได้', canvas.width / 2, canvas.height / 2);
                 }
             }
         }

         // ฟังก์ชันแปลงวันที่เป็นเดือน/ปี
         function extractMonthYear(dateString) {
             if (!dateString) return '';
             
             // ลบช่องว่างและแปลงเป็น string
             const cleanDateString = dateString.toString().trim();
             
             // ถ้าเป็นรูปแบบ DD/MM/YYYY, D/M/YYYY, DD/M/YYYY, D/MM/YYYY
             if (cleanDateString.includes('/')) {
                 const parts = cleanDateString.split('/');
                 if (parts.length === 3) {
                     const month = parseInt(parts[1]);
                     const year = parseInt(parts[2]);
                     
                     // ตรวจสอบว่าเป็นเดือน/ปีที่ถูกต้อง
                     if (month >= 1 && month <= 12 && year >= 2020) {
                         const monthNames = {
                             1: 'มกราคม', 2: 'กุมภาพันธ์', 3: 'มีนาคม', 4: 'เมษายน',
                             5: 'พฤษภาคม', 6: 'มิถุนายน', 7: 'กรกฎาคม', 8: 'สิงหาคม',
                             9: 'กันยายน', 10: 'ตุลาคม', 11: 'พฤศจิกายน', 12: 'ธันวาคม'
                         };
                         return `${monthNames[month]} ${year}`;
                     }
                 }
             }
             
             // ลองแปลงรูปแบบอื่นๆ ที่อาจเป็นไปได้ (DD-MM-YYYY)
             if (cleanDateString.includes('-')) {
                 const parts = cleanDateString.split('-');
                 if (parts.length === 3) {
                     const month = parseInt(parts[1]);
                     const year = parseInt(parts[2]);
                     
                     if (month >= 1 && month <= 12 && year >= 2020) {
                         const monthNames = {
                             1: 'มกราคม', 2: 'กุมภาพันธ์', 3: 'มีนาคม', 4: 'เมษายน',
                             5: 'พฤษภาคม', 6: 'มิถุนายน', 7: 'กรกฎาคม', 8: 'สิงหาคม',
                             9: 'กันยายน', 10: 'ตุลาคม', 11: 'พฤศจิกายน', 12: 'ธันวาคม'
                         };
                         return `${monthNames[month]} ${year}`;
                     }
                 }
             }
             
             return '';
         }

         // ฟังก์ชันแปลงเดือนสำหรับการเรียงลำดับ
         function convertMonthForSort(monthString) {
             if (!monthString) return 0;
             
             const monthNames = {
                 'มกราคม': 1, 'กุมภาพันธ์': 2, 'มีนาคม': 3, 'เมษายน': 4,
                 'พฤษภาคม': 5, 'มิถุนายน': 6, 'กรกฎาคม': 7, 'สิงหาคม': 8,
                 'กันยายน': 9, 'ตุลาคม': 10, 'พฤศจิกายน': 11, 'ธันวาคม': 12
             };
             
             // แยกเดือนและปี เช่น "มิถุนายน 2025" -> ["มิถุนายน", "2025"]
             const parts = monthString.split(' ');
             if (parts.length === 2) {
                 const monthName = parts[0];
                 const year = parseInt(parts[1]);
                 const month = monthNames[monthName] || 1;
                 
                 // สร้างตัวเลขสำหรับเรียงลำดับ: ปี*100 + เดือน
                 return year * 100 + month;
             }
             
             return 0;
         }


    </script>
</body>
</html>