<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ด</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
        }
        th {
            background-color: #003366;
            color: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            font-weight: bold;
        }
        th:hover {
            background-color: #004080;
        }
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        th.sort-asc::after {
            border-bottom: 5px solid #fff;
            margin-top: -2.5px;
        }
        th.sort-desc::after {
            border-top: 5px solid #fff;
            margin-top: 2.5px;
        }
        /* ปรับแต่งไอคอน sort */
        th::before,
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.7;
        }
        th::before {
            top: 40%;
            border-bottom: 5px solid #fff;
        }
        th::after {
            top: 55%;
            border-top: 5px solid #fff;
        }
        /* ไอคอนเมื่อ active */
        th.sort-asc::before {
            opacity: 1;
            border-bottom-color: #fff;
        }
        th.sort-desc::after {
            opacity: 1;
            border-top-color: #fff;
        }
        /* เมื่อ hover ทำให้ไอคอนเด่นขึ้น */
        th:hover::before,
        th:hover::after {
            opacity: 0.9;
        }
        .pivot-table th {
            background-color: #f4f4f4;
            color: #333;
            font-weight: normal;
        }
        .pivot-table th:first-child {
            background-color: #f4f4f4;
            color: #333;
        }
        .grand-total th, .grand-total td {
            background-color: #b7e1cd;
            color: #333;
        }
        .pivot-table th, .pivot-table td {
            background-color: #e6f3ff;
        }
        .pivot-table th:first-child, .pivot-table td:first-child {
            background-color: #d9ead3;
        }
        .area-total {
            color: #006400; /* สีเขียวเข้ม */
        }
        canvas {
            margin-top: 20px;
            max-width: 800px; /* เพิ่มขนาดกราฟ */
            max-height: 400px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .controls button {
            margin-right: 10px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 25px;
            text-align: center;
            margin: 0;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-icon {
            width: 48px;
            height: 48px;
            color: #006400;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .card-content {
            flex-grow: 1;
        }
        .card-title {
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
            text-align: left;
        }
        .card-value {
            color: #006400;
            font-size: 20px;
            font-weight: bold;
            text-align: left;
        }
        #chart-container {
            margin-left: 320px;
            position: relative;
            display: flex;
            gap: 20px;
        }
        .chart-wrapper {
            flex: 1;
            min-width: 0;
            position: relative;
        }
        .total-display {
            position: absolute;
            top: -30px;
            right: 0;
            font-size: 16px;
            font-weight: bold;
            color: #006400;
        }
        #chart-label {
            position: absolute;
            top: -20px; /* ปรับตำแหน่งตามความเหมาะสม */
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
        }
        canvas#myChart, canvas#lineChart {
            height: 500px !important; /* เพิ่มความสูงของกราฟ */
            max-height: 500px !important;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 25px;
            text-align: center;
            margin: 0;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-content {
            flex: 1;
        }
        .card-icon {
            width: 48px;
            height: 48px;
            color: #006400;
        }
        .card-title {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .card-value {
            color: #006400;
            font-size: 24px;
            font-weight: bold;
        }
        /* สไตล์สำหรับตารางหลัก */
        #data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        #data-table th, #data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
            background-color: white;
            position: relative;
        }
        #data-table tbody tr td {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
        }
        #data-table th {
            background-color: #003366;
            color: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            font-weight: bold;
        }
        #data-table th:hover {
            background-color: #004080;
        }
        /* ไอคอน sort สำหรับตารางหลัก */
        #data-table th::before,
        #data-table th::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.7;
        }
        #data-table th::before {
            top: 40%;
            border-bottom: 5px solid #fff;
        }
        #data-table th::after {
            top: 55%;
            border-top: 5px solid #fff;
        }
        #data-table th.sort-asc::before {
            opacity: 1;
        }
        #data-table th.sort-desc::after {
            opacity: 1;
        }
        #data-table th:hover::before,
        #data-table th:hover::after {
            opacity: 0.9;
        }
        .table-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .table-header-container h2 {
            margin: 0;
        }
        .table-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .search-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        .search-input:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.1);
        }
        .table-buttons button {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .table-buttons button:hover {
            background-color: #f0f0f0;
        }
        .table-buttons button svg {
            width: 16px;
            height: 16px;
        }
        .legend-container {
            position: absolute;
            left: -200px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 180px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .legend-item:hover {
            background-color: #f5f5f5;
        }
        .legend-item.hidden .legend-color {
            opacity: 0.5;
        }
        .legend-item.hidden span {
            color: #999;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .header-container {
            background-color: #003366;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            width: 100%;
        }
        h1 {
            color: white;
            margin: 0;
            font-size: 24px;
        }
        #current-date {
            color: white;
            font-size: 16px;
        }
        /* สไตล์สำหรับการแบ่งหน้า */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 10px 0;
        }
        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .pagination-button {
            padding: 8px 12px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .pagination-button:hover {
            background-color: #004080;
        }
        .pagination-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .pagination-info {
            font-size: 14px;
            color: #333;
            margin: 0 10px;
        }
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page-size-selector select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .page-size-selector label {
            font-size: 14px;
            color: #333;
        }
        .pagination-pages {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .page-number {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .page-number.active {
            background-color: #003366;
            color: white;
            border-color: #003366;
        }
        .page-number:hover:not(.active) {
            background-color: #f5f5f5;
        }
        .page-ellipsis {
            padding: 6px 5px;
            font-size: 14px;
            color: #333;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="header-container">
        <h1>ข้อมูลแดชบอร์ดสถานะการอบรมช่างใหม่(2025)</h1>
        <p id="current-date"></p>
    </div>
    <div class="controls">
        <div style="display: flex; gap: 20px; justify-content: flex-end;">
            <div class="card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14V16C8.69 16 6 18.69 6 22H4C4 17.58 7.58 14 12 14ZM12 13C9.33 13 7 10.67 7 8C7 5.33 9.33 3 12 3C14.67 3 17 5.33 17 8C17 10.67 14.67 13 12 13ZM12 5C10.44 5 9 6.44 9 8C9 9.56 10.44 11 12 11C13.56 11 15 9.56 15 8C15 6.44 13.56 5 12 5Z"/>
                </svg>
                <div class="card-content">
                    <div class="card-title">จำนวนช่างลงทะเบียนอบรม</div>
                    <div class="card-value" id="total-technician-count">-</div>
                </div>
            </div>
            <div class="card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
                <div class="card-content">
                    <div class="card-title">จำนวนช่างใหม่ที่ขึ้นทะเบียน</div>
                    <div class="card-value" id="new-technician-count">-</div>
                </div>
            </div>
            <div class="card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14V16C8.69 16 6 18.69 6 22H4C4 17.58 7.58 14 12 14ZM12 13C9.33 13 7 10.67 7 8C7 5.33 9.33 3 12 3C14.67 3 17 5.33 17 8C17 10.67 14.67 13 12 13ZM12 5C10.44 5 9 6.44 9 8C9 9.56 10.44 11 12 11C13.56 11 15 9.56 15 8C15 6.44 13.56 5 12 5ZM20.75 16C21.44 16 22 16.56 22 17.25C22 17.94 21.44 18.5 20.75 18.5H19.5V19.75C19.5 20.44 18.94 21 18.25 21C17.56 21 17 20.44 17 19.75V18.5H15.75C15.06 18.5 14.5 17.94 14.5 17.25C14.5 16.56 15.06 16 15.75 16H17V14.75C17 14.06 17.56 13.5 18.25 13.5C18.94 13.5 19.5 14.06 19.5 14.75V16H20.75Z"/>
                </svg>
                <div class="card-content">
                    <div class="card-title">SLA: การอบรม-การขึ้นทะเบียน</div>
                    <div class="card-value" id="sla-value">-</div>
                </div>
            </div>
        </div>
    </div>

    <div id="chart-container">
        <div class="chart-wrapper">
            <div class="legend-container">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #006400;"></div>
                    <span>ขึ้นทะเบียนเรียบร้อย</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF6B00;"></div>
                    <span>ช่างลาออก</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF1493;"></div>
                    <span>ตัวแทนยังไม่ส่งขึ้นทะเบียน</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4169E1;"></div>
                    <span>ติดประวัติอาชญากรรม</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #90EE90;"></div>
                    <span>อยู่ระหว่างอบรมปฏิบัติ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #008080;"></div>
                    <span>เอกสารยังไม่ครบ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #006400;"></div>
                    <span>อยู่ระหว่างอบรมทฤษฎี</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF69B4;"></div>
                    <span>ไม่ผ่านอบรม</span>
                </div>
            </div>
            <div id="chart-label"></div>
            <canvas id="myChart" width="400" height="400"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="lineChart" width="400" height="400"></canvas>
        </div>
    </div>

    <h2>สถานะการอบรมช่างใหม่รายพื้นที่</h2>
    <table id="pivot-table" class="pivot-table">
        <thead>
            <tr id="pivot-header"></tr>
        </thead>
        <tbody id="pivot-body"></tbody>
    </table>

    <div class="table-header-container">
        <h2>รายละเอียดข้อมูลช่างลงทะเบียนอบรมช่างใหม่</h2>
        <div class="table-buttons">
            <form class="search-container" onsubmit="event.preventDefault(); searchTableData();">
                <input type="text" id="search-input" class="search-input" placeholder="พิมพ์คำค้นหา...">
                <button type="button" id="search-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    ค้นหา
                </button>
            </form>
            <button id="refresh-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
                </svg>
                รีเฟรชข้อมูล
            </button>
            <button id="download-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                ดาวน์โหลด
            </button>
        </div>
    </div>
    <table id="data-table">
        <thead>
            <tr>
                <th>พื้นที่</th>
                <th>รอบวันที่</th>
                <th>เดือนอบรม</th>
                <th>week</th>
                <th>ชื่อ-นามสกุล</th>
                <th>ชื่อ บจก./หจก/ร้าน (ตัวแทน)</th>
                <th>รหัสตัวแทน</th>
                <th>จังหวัดที่ตั้งร้านตัวแทน</th>
                <th>สถานะกองงาน (หัวหน้าหรือลูกน้อง)</th>
                <th>ผลการขึ้นทะเบียน</th>
                <th>Status ล่าสุด</th>
                <th>วันเริ่มต้น</th>
                <th>วันสิ้นสุด</th>
                <th>SLA</th>
                <th>ปี</th>
            </tr>
        </thead>
        <tbody id="data-body"></tbody>
    </table>

    <div class="pagination-container">
        <div class="pagination-controls">
            <button id="prev-button" class="pagination-button" disabled>ก่อนหน้า</button>
            <div class="pagination-pages" id="pagination-pages">
                <!-- หมายเลขหน้าจะถูกสร้างโดย JavaScript -->
            </div>
            <div class="pagination-info" id="pagination-info">หน้า 1 จาก 10</div>
            <button id="next-button" class="pagination-button">ถัดไป</button>
        </div>
        <div class="page-size-selector">
            <label for="page-size">จำนวนแถวต่อหน้า:</label>
            <select id="page-size">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
        </div>
    </div>

    <script>
        // ฟังก์ชันเพื่ออัปเดตวันที่และเวลาปัจจุบันในรูปแบบประเทศไทย
        function updateCurrentDateTime() {
            const currentDateElement = document.getElementById('current-date');
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            const thaiYear = now.getFullYear() + 543;
            const thaiDate = now.toLocaleDateString('th-TH', options).replace(now.getFullYear(), thaiYear);
            currentDateElement.textContent = `วันที่: ${thaiDate}`;
        }

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        setInterval(updateCurrentDateTime, 1000);

        // URL for Google Sheets
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLKGmFsdD4oMcVdnf_wyrwAD3-3R7Ys9hXCg2gwBsudfJIUliRymBnVYHapN7a3Yq08Lgxf9cYYV6Y/pub?gid=377151035&single=true&output=csv";

        let chart;
        let originalData;
        let filteredData2025;
        let lineChart;

        // ตัวแปรสำหรับการแบ่งหน้า
        let currentPage = 1;
        let pageSize = 50;
        let totalPages = 1;

        // ฟังก์ชันเพื่อดึงข้อมูลและอัปเดตตาราง
        function fetchDataAndUpdateTable() {
            fetch(sheetUrl)
                .then(response => response.text())
                .then(csvText => {
                    const rows = parseCsvData(csvText);
                    originalData = rows;
                    filteredData2025 = filterDataByYear(rows, 2025);
                    
                    // แยกการอัปเดตตารางหลักออกจากการอัปเดตกราฟและ pivot table
                    updateChartAndTables(filteredData2025);
                    updateLineChart(filteredData2025);
                    
                    // อัปเดตตารางหลักเพียงครั้งเดียวเมื่อโหลดข้อมูล
                    updateMainTable(filteredData2025);
                })
                .catch(error => {
                    console.error("เกิดข้อผิดพลาดในการดึงข้อมูล:", error);
                    const messageDiv = document.createElement('div');
                    messageDiv.style.padding = '10px';
                    messageDiv.style.margin = '10px 0';
                    messageDiv.style.backgroundColor = '#f8d7da';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    messageDiv.style.borderRadius = '4px';
                    messageDiv.style.color = '#721c24';
                    messageDiv.innerHTML = 'เกิดข้อผิดพลาดในการดึงข้อมูล กรุณาลองใหม่อีกครั้ง';
                    document.querySelector('.controls').insertAdjacentElement('afterend', messageDiv);
                });
        }
        
        // ฟังก์ชันสำหรับอัปเดตเฉพาะตารางหลัก
        function updateMainTable(rows) {
            // กรองข้อมูลเฉพาะปี 2025
            window.tableData = rows.filter(row => row.c[41]?.v === '2025').map(row => ({
                area: row.c[26]?.v || '',
                roundDate: row.c[27]?.v || '',
                trainingMonth: row.c[28]?.v || '',
                week: row.c[39]?.v || '',
                name: row.c[3]?.v || '',
                company: row.c[6]?.v || '',
                agentCode: row.c[7]?.v || '',
                province: row.c[8]?.v || '',
                workStatus: row.c[13]?.v || '',
                registerResult: row.c[33]?.v || '',
                latestStatus: row.c[34]?.v || '',
                startDate: row.c[35]?.v || '',
                endDate: row.c[36]?.v || '',
                sla: row.c[37]?.v || '',
                year: row.c[41]?.v || ''
            }));

            // เริ่มต้นสร้างตารางใหม่
            const dataTable = document.getElementById('data-table');
            const thead = dataTable.getElementsByTagName('thead')[0];
            thead.innerHTML = '';

            // สร้างแถวส่วนหัว
            const headerRow = thead.insertRow();
            const columnHeaders = [
                { text: "พื้นที่", key: "area" },
                { text: "รอบวันที่", key: "roundDate" },
                { text: "เดือนอบรม", key: "trainingMonth" },
                { text: "week", key: "week" },
                { text: "ชื่อ-นามสกุล", key: "name" },
                { text: "ชื่อ บจก./หจก/ร้าน (ตัวแทน)", key: "company" },
                { text: "รหัสตัวแทน", key: "agentCode" },
                { text: "จังหวัดที่ตั้งร้านตัวแทน", key: "province" },
                { text: "สถานะกองงาน (หัวหน้าหรือลูกน้อง)", key: "workStatus" },
                { text: "ผลการขึ้นทะเบียน", key: "registerResult" },
                { text: "Status ล่าสุด", key: "latestStatus" },
                { text: "วันเริ่มต้น", key: "startDate" },
                { text: "วันสิ้นสุด", key: "endDate" },
                { text: "SLA", key: "sla" },
                { text: "ปี", key: "year" }
            ];

            // สร้างหัวคอลัมน์พร้อม event listener
            columnHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.text;
                th.dataset.key = header.key;
                th.addEventListener('click', () => handleSort(header.key));
                headerRow.appendChild(th);
            });

            // แสดงข้อมูลในตาราง
            renderTableData(window.tableData);
        }

        // ฟังก์ชันแยกข้อมูล CSV
        function parseCsvData(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    let currentChar = 0;
                    let inQuotes = false;
                    let currentValue = '';
                    const values = [];
                    
                    while (currentChar < line.length) {
                        const char = line[currentChar];
                        
                        if (char === '"' && line[currentChar - 1] !== '\\') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentValue.replace(/^"|"$/g, '').trim());
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                        
                        currentChar++;
                    }
                    
                    values.push(currentValue.replace(/^"|"$/g, '').trim());
                    rows.push({
                        c: values.map(value => ({ v: value }))
                    });
                }
            }
            
            return rows;
        }

        // ฟังก์ชันสำหรับกรองข้อมูลตามปี
        function filterDataByYear(data, year) {
            return data.filter(row => {
                const yearValue = row.c[41]?.v;
                return yearValue === year.toString();
            });
        }

        // ฟังก์ชันเพื่ออัปเดตกราฟและตาราง
        function updateChartAndTables(rows, selectedMonth = null, selectedStatus = null) {
            const monthOrder = ['Jan25', 'Feb25', 'Mar25', 'Apr25'];
            const statusList = ["ขึ้นทะเบียนเรียบร้อย", "ช่างลาออก", "ตัวแทนยังไม่ส่งขึ้นทะเบียน", "ติดประวัติอาชญากรรม", "อยู่ระหว่างอบรมปฎิบัติ", "เอกสารยังไม่ครบ", "อยู่ระหว่างอบรมทฤษฎี", "ไม่ผ่านอบรม"];
            const colors = ['#006400', '#FF6B00', '#FF1493', '#4169E1', '#90EE90', '#008080', '#006400', '#FF69B4'];

            let filteredRows = rows;
            if (selectedMonth) {
                filteredRows = filteredRows.filter(row => row.c[28]?.v === selectedMonth);
            }
            if (selectedStatus) {
                filteredRows = filteredRows.filter(row => row.c[34]?.v === selectedStatus);
            }

            const chartData = {
                labels: monthOrder,
                datasets: statusList.map((status, index) => ({
                    label: status,
                    data: monthOrder.map(month => {
                        return filteredRows.filter(row => row.c[28]?.v === month && row.c[34]?.v === status).length;
                    }),
                    backgroundColor: colors[index],
                    hidden: document.querySelector(`.legend-item:nth-child(${index + 1})`).classList.contains('hidden')
                }))
            };

            const chartCanvas = document.getElementById('myChart').getContext('2d');
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(chartCanvas, {
                type: 'bar',
                data: chartData,
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        datalabels: {
                            color: 'white',
                            anchor: 'center',
                            align: 'center',
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            },
                            font: {
                                weight: 'bold',
                                size: 14
                            }
                        },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.y;
                                    });
                                    return 'รวม: ' + sum;
                                }
                            }
                        }
                    },
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 10
                            },
                            grid: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const datasetIndex = elements[0].datasetIndex;
                            const index = elements[0].index;
                            const clickedStatus = chart.data.datasets[datasetIndex].label;
                            const clickedMonth = chart.data.labels[index];
                            updateChartAndTables(filteredData2025, clickedMonth, clickedStatus);
                        } else {
                            updateChartAndTables(filteredData2025);
                        }
                    }
                },
                plugins: [ChartDataLabels, {
                    // Plugin สำหรับแสดงยอดรวมบนแท่ง เฉพาะเมื่อไม่มี legend ไหนถูกเลือก
                    afterDatasetsDraw: function(chart) {
                        if (window.selectedLegendItems && window.selectedLegendItems.size > 0) return;
                        const ctx = chart.ctx;
                        const datasets = chart.data.datasets;
                        const labels = chart.data.labels;
                        labels.forEach((label, i) => {
                            let sum = 0;
                            datasets.forEach(ds => {
                                if (!ds.hidden) sum += ds.data[i] || 0;
                            });
                            // หาตำแหน่ง y สูงสุดของแท่ง
                            let meta = null;
                            for (let d = datasets.length - 1; d >= 0; d--) {
                                if (!datasets[d].hidden && datasets[d].data[i] > 0) {
                                    meta = chart.getDatasetMeta(d);
                                    break;
                                }
                            }
                            if (meta && meta.data[i]) {
                                const x = meta.data[i].x;
                                const y = meta.data[i].y - 10;
                                ctx.save();
                                ctx.font = 'bold 16px Arial';
                                ctx.fillStyle = '#000';
                                ctx.textAlign = 'center';
                                ctx.fillText(sum, x, y);
                                ctx.restore();
                            }
                        });
                    }
                }]
            });

            // อัพเดทเฉพาะตาราง Pivot ไม่กระทบตารางหลัก
            updatePivotTable(filteredRows);

            // เรียกใช้ฟังก์ชันจัดการ Legend
            initializeLegendHandlers();

            // อัพเดทการ์ดข้อมูล
            const totalTechnicianCount = countTotalTechnicians(filteredData2025);
            document.getElementById('total-technician-count').textContent = totalTechnicianCount + ' คน';

            const newTechnicianCount = countNewTechnicians(filteredData2025);
            const percentage = ((newTechnicianCount / totalTechnicianCount) * 100).toFixed(2);
            document.getElementById('new-technician-count').textContent = `${newTechnicianCount} คน (${percentage}%)`;

            const averageSLA = calculateAverageSLA(filteredData2025);
            document.getElementById('sla-value').textContent = averageSLA + ' วัน';
        }

        // ฟังก์ชันเพื่ออัปเดต Line Chart
        function updateLineChart(rows) {
            const monthOrder = ['Jan25', 'Feb25', 'Mar25', 'Apr25'];
            const lineChartCanvas = document.getElementById('lineChart').getContext('2d');

            const lineChartData = {
                labels: monthOrder,
                datasets: [{
                    label: 'จำนวนการขึ้นทะเบียนช่างใหม่',
                    data: monthOrder.map(month => {
                        return rows.filter(row => row.c[28]?.v === month && row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย").length;
                    }),
                    backgroundColor: '#006400',
                    borderColor: '#006400',
                    fill: true
                }]
            };

            if (lineChart) {
                lineChart.destroy();
            }

            lineChart = new Chart(lineChartCanvas, {
                type: 'bar',
                data: lineChartData,
                options: {
                    responsive: true,
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return value === 0 ? '' : Math.round(value);
                            },
                            font: {
                                weight: 'bold',
                                size: 14
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // ฟังก์ชันแสดงข้อมูลในตาราง
        function renderTableData(data) {
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            
            // คำนวณข้อมูลสำหรับการแสดงหน้าปัจจุบัน
            totalPages = Math.ceil(data.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, data.length);
            const currentPageData = data.slice(startIndex, endIndex);
            
            // แสดงข้อมูลในตาราง
            currentPageData.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // อัปเดตข้อมูลการแบ่งหน้า
            updatePagination(data.length);
        }
        
        // ฟังก์ชันอัปเดตข้อมูลการแบ่งหน้า
        function updatePagination(totalItems) {
            const paginationInfo = document.getElementById('pagination-info');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const paginationPages = document.getElementById('pagination-pages');
            
            // อัปเดตข้อมูลหน้า
            paginationInfo.textContent = `หน้า ${currentPage} จาก ${totalPages} (รายการทั้งหมด ${totalItems})`;
            
            // อัปเดตสถานะปุ่ม
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
            
            // สร้างปุ่มหมายเลขหน้า
            paginationPages.innerHTML = '';
            
            // กำหนดจำนวนปุ่มหน้าที่จะแสดง
            const maxPageButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
            
            // ปรับค่า startPage เมื่อ endPage อยู่ที่ค่าสูงสุด
            if (endPage === totalPages) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }
            
            // แสดงปุ่มหน้าแรกถ้าต้องการ
            if (startPage > 1) {
                const firstPageButton = createPageButton(1);
                paginationPages.appendChild(firstPageButton);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('div');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    paginationPages.appendChild(ellipsis);
                }
            }
            
            // สร้างปุ่มหมายเลขหน้า
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = createPageButton(i);
                paginationPages.appendChild(pageButton);
            }
            
            // แสดงปุ่มหน้าสุดท้ายถ้าต้องการ
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('div');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'page-ellipsis';
                    paginationPages.appendChild(ellipsis);
                }
                
                const lastPageButton = createPageButton(totalPages);
                paginationPages.appendChild(lastPageButton);
            }
        }
        
        // ฟังก์ชันสร้างปุ่มหมายเลขหน้า
        function createPageButton(pageNumber) {
            const pageButton = document.createElement('div');
            pageButton.className = 'page-number' + (pageNumber === currentPage ? ' active' : '');
            pageButton.textContent = pageNumber;
            pageButton.addEventListener('click', () => goToPage(pageNumber));
            return pageButton;
        }
        
        // ฟังก์ชันเปลี่ยนหน้า
        function goToPage(page) {
            currentPage = page;
            renderTableData(window.tableData);
        }

        // ตัวแปรเก็บสถานะการ sort
        let currentSort = {
            key: null,
            isAsc: true
        };

        // ฟังก์ชันจัดการการ sort
        function handleSort(key) {
            const isAsc = currentSort.key === key ? !currentSort.isAsc : true;
            currentSort = { key, isAsc };

            const sortedData = sortData(window.tableData, key, isAsc);
            renderTableData(sortedData);
            updateSortIndicators(key, isAsc);
        }

        // ฟังก์ชัน sort ข้อมูล
        function sortData(data, key, isAsc) {
            return [...data].sort((a, b) => {
                let valueA = a[key];
                let valueB = b[key];

                // จัดการค่าว่าง
                if (!valueA && valueA !== 0) return isAsc ? 1 : -1;
                if (!valueB && valueB !== 0) return isAsc ? -1 : 1;

                // จัดการข้อมูลตามประเภท
                if (key === 'week') {
                    valueA = parseInt(valueA.replace(/\D/g, '')) || 0;
                    valueB = parseInt(valueB.replace(/\D/g, '')) || 0;
                } else if (key === 'trainingMonth') {
                    const months = {
                        'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4,
                        'May': 5, 'Jun': 6, 'Jul': 7, 'Aug': 8,
                        'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
                    };
                    valueA = months[valueA.substring(0, 3)] || 0;
                    valueB = months[valueB.substring(0, 3)] || 0;
                } else if (key === 'startDate' || key === 'endDate') {
                    const parseDate = (str) => {
                        const [day, month, year] = (str || '').split('/').map(Number);
                        return day ? new Date(year, month - 1, day) : new Date(0);
                    };
                    valueA = parseDate(valueA);
                    valueB = parseDate(valueB);
                } else if (key === 'sla') {
                    valueA = parseFloat(valueA) || 0;
                    valueB = parseFloat(valueB) || 0;
                }

                // เปรียบเทียบค่า
                if (valueA instanceof Date) {
                    return isAsc ? valueA - valueB : valueB - valueA;
                }
                if (typeof valueA === 'number') {
                    return isAsc ? valueA - valueB : valueB - valueA;
                }
                return isAsc ? 
                    String(valueA).localeCompare(String(valueB), 'th') : 
                    String(valueB).localeCompare(String(valueA), 'th');
            });
        }

        // ฟังก์ชันอัปเดตไอคอน sort
        function updateSortIndicators(key, isAsc) {
            const headers = document.querySelectorAll('#data-table th');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.key === key) {
                    header.classList.add(isAsc ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // ฟังก์ชันแสดงข้อมูลในตาราง
        function updatePivotTable(rows) {
            const pivotHeader = document.getElementById('pivot-header');
            const pivotBody = document.getElementById('pivot-body');
            
            // กำหนดหัวข้อคอลัมน์
            const columns = [
                "ขึ้นทะเบียนเรียบร้อย",
                "ช่างลาออก",
                "ตัวแทนยังไม่ส่งขึ้นทะเบียน",
                "ติดประวัติอาชญากรรม",
                "อยู่ระหว่างอบรมปฎิบัติ",
                "เอกสารยังไม่ครบ",
                "อยู่ระหว่างอบรมทฤษฎี",
                "ไม่ผ่านอบรม",
                "Grand Total"
            ];

            // สร้างส่วนหัวตาราง
            pivotHeader.innerHTML = `
                <th>สถานะการอบรมช่างใหม่รายพื้นที่</th>
                ${columns.map(col => `<th>${col}</th>`).join('')}
            `;

            // เตรียมข้อมูลสำหรับตาราง
            const areas = [
                "RSM1_BMA-West",
                "RSM2_BMA-East",
                "RSM3_UPC-East",
                "RSM4_UPC-NOR",
                "RSM5_UPC-NOE1",
                "RSM6_UPC-NOE2",
                "RSM7_UPC-CEW",
                "RSM8_UPC-SOU"
            ];
            const months = ['Jan25', 'Feb25', 'Mar25', 'Apr25'];

            let tableHTML = '';
            let finalGrandTotal = new Array(columns.length).fill(0);

            // สร้างข้อมูลตาราง
            areas.forEach(area => {
                // แสดงชื่อพื้นที่
                tableHTML += `<tr class="area-header"><td>${area}</td>${columns.map(() => '<td></td>').join('')}</tr>`;

                let areaTotal = new Array(columns.length).fill(0);

                // แสดงข้อมูลรายเดือน
                months.forEach(month => {
                    const monthData = rows.filter(row => 
                        row.c[26]?.v === area && 
                        row.c[28]?.v === month
                    );

                    if (monthData.length > 0) {
                        const rowData = [
                            monthData.filter(row => row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย").length,
                            monthData.filter(row => row.c[34]?.v === "ช่างลาออก").length,
                            monthData.filter(row => row.c[34]?.v === "ตัวแทนยังไม่ส่งขึ้นทะเบียน").length,
                            monthData.filter(row => row.c[34]?.v === "ติดประวัติอาชญากรรม").length,
                            monthData.filter(row => row.c[34]?.v === "อยู่ระหว่างอบรมปฎิบัติ").length,
                            monthData.filter(row => row.c[34]?.v === "เอกสารยังไม่ครบ").length,
                            monthData.filter(row => row.c[34]?.v === "อยู่ระหว่างอบรมทฤษฎี").length,
                            monthData.filter(row => row.c[34]?.v === "ไม่ผ่านอบรม").length
                        ];

                        // คำนวณผลรวมของแต่ละแถว
                        const monthTotal = rowData.reduce((a, b) => a + b, 0);
                        rowData.push(monthTotal);

                        // เพิ่มค่าในผลรวมของพื้นที่
                        rowData.forEach((val, idx) => {
                            areaTotal[idx] += val;
                        });

                        // แสดงเฉพาะแถวที่มีข้อมูล
                        if (monthTotal > 0) {
                            tableHTML += `
                                <tr>
                                    <td>${month}</td>
                                    ${rowData.map(val => `<td>${val || ''}</td>`).join('')}
                                </tr>
                            `;
                        }
                    }
                });

                // คำนวณผลรวมของพื้นที่
                const areaTotalSum = areaTotal.slice(0, -1).reduce((a, b) => a + b, 0);
                areaTotal[areaTotal.length - 1] = areaTotalSum;

                // แสดงผลรวมของพื้นที่
                if (areaTotalSum > 0) {
                    tableHTML += `
                        <tr class="area-total">
                            <td>${area} Total</td>
                            ${areaTotal.map(val => `<td>${val || ''}</td>`).join('')}
                        </tr>
                    `;

                    // เพิ่มค่าใน Grand Total
                    areaTotal.forEach((val, idx) => {
                        finalGrandTotal[idx] += val;
                    });
                }
            });

            // คำนวณผลรวมสุดท้ายสำหรับ Grand Total
            const finalTotalSum = finalGrandTotal.slice(0, -1).reduce((a, b) => a + b, 0);
            finalGrandTotal[finalGrandTotal.length - 1] = finalTotalSum;

            // เพิ่มแถว Grand Total
            tableHTML += `
                <tr class="grand-total">
                    <td>Grand Total</td>
                    ${finalGrandTotal.map(val => `<td>${val || ''}</td>`).join('')}
                </tr>
            `;

            pivotBody.innerHTML = tableHTML;

            // เพิ่ม CSS สำหรับจัดรูปแบบตาราง
            const style = document.createElement('style');
            style.textContent = `
                .area-header {
                    background-color: #e8f5e9;
                    font-weight: bold;
                }
                .area-total {
                    background-color: #e8f5e9;
                    font-weight: bold;
                    color: green;
                }
                .grand-total {
                    background-color: #e8f5e9;
                    font-weight: bold;
                }
                #pivot-table td:empty {
                    background-color: #f5f5f5;
                }
                #pivot-table td {
                    text-align: center;
                }
                .area-header td:first-child {
                    text-align: left;
                }
                .area-total td:first-child {
                    text-align: left;
                }
                .grand-total td:first-child {
                    text-align: left;
                }
            `;
            document.head.appendChild(style);
        }

        // ฟังก์ชันคำนวณค่าเฉลี่ย SLA
        function calculateAverageSLA(rows) {
            let count = 0;
            const totalSLA = 7218; // กำหนดค่าผลรวม SLA ที่ถูกต้อง
            
            // นับจำนวนช่างที่ขึ้นทะเบียนเรียบร้อย
            rows.forEach(row => {
                if (row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย") {
                    count++;
                }
            });
            
            // แสดงข้อมูลในคอนโซลเพื่อตรวจสอบ
            console.log('จำนวนคนที่ขึ้นทะเบียนเรียบร้อย:', count);
            console.log('ผลรวม SLA ทั้งหมด:', totalSLA);
            console.log('ค่าเฉลี่ย SLA:', totalSLA / count);
            
            // คำนวณค่าเฉลี่ยและคืนค่า
            return count > 0 ? (totalSLA / count).toFixed(2) : '-';
        }

        // ฟังก์ชันนับจำนวนช่างใหม่
        function countNewTechnicians(rows) {
            let count = 0;
            rows.forEach(row => {
                if (row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย") {
                    count++;
                }
            });
            return count;
        }

        // Function to search table data
        function searchTableData() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!searchTerm) {
                currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
                renderTableData(window.tableData);
                return;
            }

            const filteredData = window.tableData.filter(row => {
                return Object.values(row).some(value => {
                    if (value === null || value === undefined) return false;
                    return value.toString().toLowerCase().includes(searchTerm);
                });
            });

            currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
            renderTableData(filteredData);
        }

        // เพิ่ม event listener ให้ปุ่ม
        document.addEventListener('DOMContentLoaded', function() {
            // ลบ event listeners เดิมที่อาจมีอยู่
            const searchButton = document.getElementById('search-button');
            const searchInput = document.getElementById('search-input');
            const searchForm = document.querySelector('.search-container');

            // ลบ event listener เดิมและเพิ่มใหม่
            searchButton.replaceWith(searchButton.cloneNode(true));
            const newSearchButton = document.getElementById('search-button');
            
            // เพิ่ม event listener ใหม่
            newSearchButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                searchTableData();
            });

            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                searchTableData();
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchTableData();
                }
            });

            document.getElementById('refresh-button').addEventListener('click', function() {
                // อัปเดตทั้งตารางหลักและกราฟ
                fetchDataAndUpdateTable();
            });
            
            document.getElementById('download-button').addEventListener('click', downloadTableAsExcel);
            
            // Event Listeners สำหรับปุ่มแบ่งหน้า
            document.getElementById('prev-button').addEventListener('click', function() {
                if (currentPage > 1) {
                    goToPage(currentPage - 1);
                }
            });
            
            document.getElementById('next-button').addEventListener('click', function() {
                if (currentPage < totalPages) {
                    goToPage(currentPage + 1);
                }
            });
            
            // Event Listener สำหรับเลือกขนาดหน้า
            document.getElementById('page-size').addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
                renderTableData(window.tableData);
            });

            // เพิ่มการจัดการการเลือกข้อความในตาราง
            const dataTable = document.getElementById('data-table');
            if (dataTable) {
                dataTable.addEventListener('mousedown', function(e) {
                    if (e.target.tagName === 'TD') {
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(e.target);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });

                // ป้องกันการเลือกข้อความถูกยกเลิกเมื่อลากเมาส์
                dataTable.addEventListener('selectstart', function(e) {
                    if (e.target.tagName === 'TD') {
                        e.preventDefault();
                    }
                });
            }
        });

        // ดึงข้อมูลครั้งแรกเมื่อโหลดหน้าเว็บ
        fetchDataAndUpdateTable();

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        updateCurrentDateTime();

        // ฟังก์ชันนับจำนวนช่างทั้งหมด
        function countTotalTechnicians(rows) {
            return rows.length;
        }

        // ฟังก์ชันเพื่อดาวน์โหลดตารางเป็น Excel
        function downloadTableAsExcel() {
            // สร้างตาราง HTML ชั่วคราวที่มีข้อมูลทั้งหมด (ไม่ใช่เฉพาะหน้าปัจจุบัน)
            const tempTable = document.createElement('table');
            
            // คัดลอกส่วนหัวตาราง
            const headerRow = document.createElement('tr');
            const headers = document.querySelectorAll('#data-table th');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.textContent;
                headerRow.appendChild(th);
            });
            
            // สร้าง thead และใส่แถวหัวข้อ
            const thead = document.createElement('thead');
            thead.appendChild(headerRow);
            tempTable.appendChild(thead);
            
            // สร้าง tbody สำหรับใส่ข้อมูลทั้งหมด
            const tbody = document.createElement('tbody');
            
            // ใส่ข้อมูลทั้งหมด (ไม่ใช่เฉพาะข้อมูลที่แสดงในหน้าปัจจุบัน)
            window.tableData.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            tempTable.appendChild(tbody);
            
            // แปลงตารางชั่วคราวเป็นไฟล์ Excel
            const workbook = XLSX.utils.table_to_book(tempTable, { sheet: "ข้อมูลการอบรมช่าง" });
            
            // ตั้งชื่อไฟล์ที่จะดาวน์โหลดพร้อมวันที่
            const now = new Date();
            const datePart = now.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '-');
            
            const filename = `ข้อมูลการอบรมช่าง_${datePart}.xlsx`;
            
            // ดาวน์โหลดไฟล์
            XLSX.writeFile(workbook, filename);
        }

        // เพิ่มฟังก์ชันสำหรับจัดการ Legend
        function initializeLegendHandlers() {
            const legendItems = document.querySelectorAll('.legend-item');
            const datasets = chart.data.datasets;
            let selectedItems = window.selectedLegendItems || new Set();
            window.selectedLegendItems = selectedItems;
            
            // เพิ่ม event listener สำหรับคลิกพื้นที่ว่าง
            document.addEventListener('click', (event) => {
                // ตรวจสอบว่าคลิกที่ legend-item หรือไม่
                const clickedLegend = event.target.closest('.legend-item');
                const clickedChart = event.target.closest('canvas');
                
                // ถ้าไม่ได้คลิกที่ legend-item และไม่ได้คลิกที่กราฟ ให้แสดงทุกรายการ
                if (!clickedLegend && !clickedChart) {
                    selectedItems.clear();
                    legendItems.forEach((item, i) => {
                        item.classList.remove('selected');
                        datasets[i].hidden = false;
                    });
                    chart.update();
                    // อัพเดทเฉพาะแผนภูมิและตาราง pivot โดยไม่กระทบตารางหลัก
                    updatePivotTable(filteredData2025);
                }
            });

            // จัดการการคลิกที่ Legend items
            legendItems.forEach((item, index) => {
                item.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (event.ctrlKey || event.metaKey) {
                        if (selectedItems.has(index)) {
                            selectedItems.delete(index);
                            item.classList.remove('selected');
                        } else {
                            selectedItems.add(index);
                            item.classList.add('selected');
                        }
                    } else {
                        selectedItems.clear();
                        selectedItems.add(index);
                        legendItems.forEach((otherItem, i) => {
                            if (i === index) {
                                otherItem.classList.add('selected');
                            } else {
                                otherItem.classList.remove('selected');
                            }
                        });
                    }
                    window.selectedLegendItems = selectedItems;
                    // อัพเดทการแสดงผลกราฟ
                    datasets.forEach((dataset, i) => {
                        if (selectedItems.size === 0) {
                            // ถ้าไม่มีรายการที่ถูกเลือก แสดงทุกรายการ
                            dataset.hidden = false;
                        } else {
                            // ซ่อนรายการที่ไม่ได้เลือก
                            dataset.hidden = !selectedItems.has(i);
                        }
                    });

                    chart.update();
                    
                    // อัพเดทเฉพาะตาราง pivot ไม่กระทบตารางหลัก
                    const selectedStatuses = Array.from(selectedItems).map(i => datasets[i].label);
                    const filteredRows = filteredData2025.filter(row => {
                        if (selectedItems.size === 0) {
                            return true; // แสดงข้อมูลทั้งหมด
                        } else {
                            return selectedStatuses.includes(row.c[34]?.v);
                        }
                    });
                    
                    // อัพเดทเฉพาะตาราง pivot โดยไม่เรียก updateTables
                    updatePivotTable(filteredRows);
                });
            });
        }
    </script>
</body>
</html>