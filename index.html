<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ด</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
        }
        th {
            background-color: #003366;
            color: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            font-weight: bold;
        }
        th:hover {
            background-color: #004080;
        }
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        th.sort-asc::after {
            border-bottom: 5px solid #fff;
            margin-top: -2.5px;
        }
        th.sort-desc::after {
            border-top: 5px solid #fff;
            margin-top: 2.5px;
        }
        /* ปรับแต่งไอคอน sort */
        th::before,
        th::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.7;
        }
        th::before {
            top: 40%;
            border-bottom: 5px solid #fff;
        }
        th::after {
            top: 55%;
            border-top: 5px solid #fff;
        }
        /* ไอคอนเมื่อ active */
        th.sort-asc::before {
            opacity: 1;
            border-bottom-color: #fff;
        }
        th.sort-desc::after {
            opacity: 1;
            border-top-color: #fff;
        }
        /* เมื่อ hover ทำให้ไอคอนเด่นขึ้น */
        th:hover::before,
        th:hover::after {
            opacity: 0.9;
        }
        .pivot-table th {
            background-color: #f4f4f4;
            color: #333;
            font-weight: normal;
        }
        .pivot-table th:first-child {
            background-color: #f4f4f4;
            color: #333;
        }
        .grand-total th, .grand-total td {
            background-color: #b7e1cd;
            color: #333;
        }
        .pivot-table th, .pivot-table td {
            background-color: #e6f3ff;
        }
        .pivot-table th:first-child, .pivot-table td:first-child {
            background-color: #d9ead3;
        }
        .area-total {
            color: #006400; /* สีเขียวเข้ม */
        }
        canvas {
            margin-top: 20px;
            max-width: 800px; /* เพิ่มขนาดกราฟ */
            max-height: 400px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .controls button {
            margin-right: 10px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
        }
        .pivot-table {
            margin-bottom: 5px; /* ลดช่องว่างระหว่างตารางสรุปกับตารางหลัก */
        }
        .header-container {
            background-color: #003366; /* สีน้ำเงินเข้ม */
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        #chart-container {
            position: relative;
            display: flex; /* จัดวางกราฟให้อยู่ข้างกัน */
        }
        #chart-label {
            position: absolute;
            top: -20px; /* ปรับตำแหน่งตามความเหมาะสม */
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
        }
        .chart-wrapper {
            width: 48%; /* ปรับขนาดให้กว้างขึ้น */
            padding: 10px;
            box-sizing: border-box;
        }
        canvas#myChart, canvas#lineChart {
            height: 500px !important; /* เพิ่มความสูงของกราฟ */
            max-height: 500px !important;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 25px;
            text-align: center;
            margin: 0;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-content {
            flex: 1;
        }
        .card-icon {
            width: 48px;
            height: 48px;
            color: #006400;
        }
        .card-title {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .card-value {
            color: #006400;
            font-size: 24px;
            font-weight: bold;
        }
        /* สไตล์สำหรับตารางหลัก */
        #data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        #data-table th, #data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
            background-color: white;
            position: relative;
        }
        #data-table tbody tr td {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            cursor: text;
        }
        #data-table th {
            background-color: #003366;
            color: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            font-weight: bold;
        }
        #data-table th:hover {
            background-color: #004080;
        }
        /* ไอคอน sort สำหรับตารางหลัก */
        #data-table th::before,
        #data-table th::after {
            content: '';
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.7;
        }
        #data-table th::before {
            top: 40%;
            border-bottom: 5px solid #fff;
        }
        #data-table th::after {
            top: 55%;
            border-top: 5px solid #fff;
        }
        #data-table th.sort-asc::before {
            opacity: 1;
        }
        #data-table th.sort-desc::after {
            opacity: 1;
        }
        #data-table th:hover::before,
        #data-table th:hover::after {
            opacity: 0.9;
        }
        .table-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .table-header-container h2 {
            margin: 0;
        }
        .table-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .search-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        .search-input:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.1);
        }
        .table-buttons button {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .table-buttons button:hover {
            background-color: #f0f0f0;
        }
        .table-buttons button svg {
            width: 16px;
            height: 16px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="header-container">
        <h1>ข้อมูลแดชบอร์ดสถานะการอบรมช่างใหม่(2025)</h1>
        <p id="current-date"></p>
    </div>
    <div class="controls">
        <div style="display: flex; gap: 20px; justify-content: flex-end;">
            <div class="card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14V16C8.69 16 6 18.69 6 22H4C4 17.58 7.58 14 12 14ZM12 13C9.33 13 7 10.67 7 8C7 5.33 9.33 3 12 3C14.67 3 17 5.33 17 8C17 10.67 14.67 13 12 13ZM12 5C10.44 5 9 6.44 9 8C9 9.56 10.44 11 12 11C13.56 11 15 9.56 15 8C15 6.44 13.56 5 12 5Z"/>
                </svg>
                <div class="card-content">
                    <div class="card-title">จำนวนช่างลงทะเบียนอบรม</div>
                    <div class="card-value" id="total-technician-count">-</div>
                </div>
            </div>
            <div class="card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
                <div class="card-content">
                    <div class="card-title">จำนวนช่างใหม่ที่ขึ้นทะเบียน</div>
                    <div class="card-value" id="new-technician-count">-</div>
                </div>
            </div>
            <div class="card">
                <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14V16C8.69 16 6 18.69 6 22H4C4 17.58 7.58 14 12 14ZM12 13C9.33 13 7 10.67 7 8C7 5.33 9.33 3 12 3C14.67 3 17 5.33 17 8C17 10.67 14.67 13 12 13ZM12 5C10.44 5 9 6.44 9 8C9 9.56 10.44 11 12 11C13.56 11 15 9.56 15 8C15 6.44 13.56 5 12 5ZM20.75 16C21.44 16 22 16.56 22 17.25C22 17.94 21.44 18.5 20.75 18.5H19.5V19.75C19.5 20.44 18.94 21 18.25 21C17.56 21 17 20.44 17 19.75V18.5H15.75C15.06 18.5 14.5 17.94 14.5 17.25C14.5 16.56 15.06 16 15.75 16H17V14.75C17 14.06 17.56 13.5 18.25 13.5C18.94 13.5 19.5 14.06 19.5 14.75V16H20.75Z"/>
                </svg>
                <div class="card-content">
                    <div class="card-title">SLA: การอบรม-การขึ้นทะเบียน</div>
                    <div class="card-value" id="sla-value">-</div>
                </div>
            </div>
        </div>
    </div>

    <div id="chart-container">
        <div class="chart-wrapper">
            <div id="chart-label"></div>
            <canvas id="myChart" width="400" height="400"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="lineChart" width="400" height="400"></canvas>
        </div>
    </div>

    <h2>สถานะการอบรมช่างใหม่รายพื้นที่</h2>
    <table id="pivot-table" class="pivot-table">
        <thead>
            <tr id="pivot-header"></tr>
        </thead>
        <tbody id="pivot-body"></tbody>
    </table>

    <div class="table-header-container">
        <h2>รายละเอียดข้อมูลช่างลงทะเบียนอบรมช่างใหม่</h2>
        <div class="table-buttons">
            <form class="search-container" onsubmit="event.preventDefault(); searchTableData();">
                <input type="text" id="search-input" class="search-input" placeholder="พิมพ์คำค้นหา...">
                <button type="button" id="search-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    ค้นหา
                </button>
            </form>
            <button id="refresh-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
                </svg>
                รีเฟรชข้อมูล
            </button>
            <button id="download-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                ดาวน์โหลด
            </button>
        </div>
    </div>
    <table id="data-table">
        <thead>
            <tr>
                <th>พื้นที่</th>
                <th>รอบวันที่</th>
                <th>เดือนอบรม</th>
                <th>week</th>
                <th>ชื่อ-นามสกุล</th>
                <th>ชื่อ บจก./หจก/ร้าน (ตัวแทน)</th>
                <th>รหัสตัวแทน</th>
                <th>จังหวัดที่ตั้งร้านตัวแทน</th>
                <th>สถานะกองงาน (หัวหน้าหรือลูกน้อง)</th>
                <th>ผลการขึ้นทะเบียน</th>
                <th>Status ล่าสุด</th>
                <th>วันเริ่มต้น</th>
                <th>วันสิ้นสุด</th>
                <th>SLA</th>
                <th>ปี</th>
            </tr>
        </thead>
        <tbody id="data-body"></tbody>
    </table>

    <script>
        // ฟังก์ชันเพื่ออัปเดตวันที่และเวลาปัจจุบันในรูปแบบประเทศไทย
        function updateCurrentDateTime() {
            const currentDateElement = document.getElementById('current-date');
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            const thaiYear = now.getFullYear() + 543;
            const thaiDate = now.toLocaleDateString('th-TH', options).replace(now.getFullYear(), thaiYear);
            currentDateElement.textContent = `วันที่: ${thaiDate}`;
        }

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        setInterval(updateCurrentDateTime, 1000);

        // URL for Google Sheets
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLKGmFsdD4oMcVdnf_wyrwAD3-3R7Ys9hXCg2gwBsudfJIUliRymBnVYHapN7a3Yq08Lgxf9cYYV6Y/pub?gid=377151035&single=true&output=csv";

        let chart;
        let originalData;
        let filteredData2025;
        let lineChart;

        // ฟังก์ชันเพื่อดึงข้อมูลและอัปเดตตาราง
        function fetchDataAndUpdateTable() {
            fetch(sheetUrl)
                .then(response => response.text())
                .then(csvText => {
                    // แปลง CSV เป็น JSON
                    const rows = [];
                    const lines = csvText.split('\n');
                    
                    // ข้ามบรรทัดแรก (หัวตาราง)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {  // ตรวจสอบว่าไม่ใช่บรรทัดว่าง
                            let currentChar = 0;
                            let inQuotes = false;
                            let currentValue = '';
                            const values = [];
                            
                            // วนลูปทีละตัวอักษรเพื่อแยกค่าที่ถูกต้อง
                            while (currentChar < line.length) {
                                const char = line[currentChar];
                                
                                if (char === '"' && line[currentChar - 1] !== '\\') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    values.push(currentValue.replace(/^"|"$/g, '').trim());
                                    currentValue = '';
                                } else {
                                    currentValue += char;
                                }
                                
                                currentChar++;
                            }
                            
                            // เพิ่มค่าสุดท้าย
                            values.push(currentValue.replace(/^"|"$/g, '').trim());
                            
                            // สร้าง row object
                            rows.push({
                                c: values.map(value => ({ v: value }))
                            });
                        }
                    }

                    console.log('จำนวนแถวทั้งหมด:', rows.length); // แสดงจำนวนแถวเพื่อตรวจสอบ

                    originalData = rows;
                    filteredData2025 = filterDataByYear(rows, 2025);
                    console.log('จำนวนแถวปี 2025:', filteredData2025.length); // แสดงจำนวนแถวที่กรองแล้ว
                    updateChartAndTables(filteredData2025);
                    updateLineChart(filteredData2025);
                })
                .catch(error => {
                    console.error("เกิดข้อผิดพลาดในการดึงข้อมูล:", error);
                    const messageDiv = document.createElement('div');
                    messageDiv.style.padding = '10px';
                    messageDiv.style.margin = '10px 0';
                    messageDiv.style.backgroundColor = '#f8d7da';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    messageDiv.style.borderRadius = '4px';
                    messageDiv.style.color = '#721c24';
                    messageDiv.innerHTML = 'เกิดข้อผิดพลาดในการดึงข้อมูล กรุณาลองใหม่อีกครั้ง';
                    document.querySelector('.controls').insertAdjacentElement('afterend', messageDiv);
                });
        }
        
        // ฟังก์ชันสำหรับกรองข้อมูลตามปี
        function filterDataByYear(data, year) {
            return data.filter(row => {
                const yearValue = row.c[41]?.v; // คอลัมน์ปี
                return yearValue === year.toString();
            });
        }

        // ฟังก์ชันเพื่ออัปเดตกราฟและตาราง
        function updateChartAndTables(rows, selectedMonth = null, selectedStatus = null) {
            const monthOrder = ['Jan25', 'Feb25', 'Mar25', 'Apr25'];
            const statusList = ["ขึ้นทะเบียนเรียบร้อย", "ช่างลาออก", "ตัวแทนยังไม่ส่งขึ้นทะเบียน", "ติดประวัติอาชญากรรม", "อยู่ระหว่างอบรมปฎิบัติ", "เอกสารยังไม่ครบ", "อยู่ระหว่างอบรมทฤษฎี", "ไม่ผ่านอบรม"];
            const colors = ['#4dc9f6', '#f67019', '#f53794', '#537bc4', '#acc236', '#166a8f', '#00b300', '#ff0066'];

            // Filter data based on selected month and status
            let filteredRows = rows;
            if (selectedMonth) {
                filteredRows = filteredRows.filter(row => row.c[28]?.v === selectedMonth);
            }
            if (selectedStatus) {
                filteredRows = filteredRows.filter(row => row.c[34]?.v === selectedStatus);
            }

            const chartData = {
                labels: monthOrder,
                datasets: statusList.map((status, index) => ({
                    label: status,
                    data: monthOrder.map(month => {
                        return filteredRows.filter(row => row.c[28]?.v === month && row.c[34]?.v === status).length;
                    }),
                    backgroundColor: status === "ขึ้นทะเบียนเรียบร้อย" ? '#006400' : colors[index]
                }))
            };

            const chartCanvas = document.getElementById('myChart').getContext('2d');
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(chartCanvas, {
                type: 'bar',
                data: chartData,
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30
                        }
                    },
                    plugins: {
                        datalabels: {
                            color: 'white',
                            anchor: 'center',
                            align: 'center',
                            formatter: function(value) {
                                return value === 0 ? '' : Math.round(value);
                            },
                            font: {
                                weight: 'bold',
                                size: 14 /* เพิ่มขนาดตัวอักษรในกราฟ */
                            }
                        },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.y;
                                    });
                                    return 'รวม: ' + sum;
                                }
                            }
                        }
                    },
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100, // กำหนดค่าสูงสุดของแกน Y ที่ 100
                            ticks: {
                                stepSize: 10
                            },
                            grid: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const datasetIndex = elements[0].datasetIndex;
                            const index = elements[0].index;
                            const clickedStatus = chart.data.datasets[datasetIndex].label;
                            const clickedMonth = chart.data.labels[index];
                            updateChartAndTables(filteredData2025, clickedMonth, clickedStatus);
                        } else {
                            updateChartAndTables(filteredData2025);
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // แสดงผลรวมด้านบนกราฟ
            const ctx = chartCanvas;
            const datasets = chart.data.datasets;
            const labels = chart.data.labels;
            
            labels.forEach((label, index) => {
                let total = 0;
                datasets.forEach(dataset => {
                    total += dataset.data[index];
                });
                
                ctx.save();
                ctx.fillStyle = '#000';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                
                const meta = chart.getDatasetMeta(0);
                const x = meta.data[index].x;
                const y = chart.scales.y.getPixelForValue(chart.scales.y.max) - 20;
                
                ctx.fillText('รวม: ' + total, x, y);
                ctx.restore();
            });

            updateTables(filteredRows);

            // อัปเดตจำนวนช่างทั้งหมด
            const totalTechnicianCount = countTotalTechnicians(rows);
            document.getElementById('total-technician-count').textContent = totalTechnicianCount + ' คน';

            // อัปเดตจำนวนช่างใหม่พร้อมเปอร์เซ็นต์
            const newTechnicianCount = countNewTechnicians(rows);
            const percentage = ((newTechnicianCount / totalTechnicianCount) * 100).toFixed(2);
            document.getElementById('new-technician-count').textContent = `${newTechnicianCount} คน (${percentage}%)`;

            // อัปเดตค่า SLA
            const averageSLA = calculateAverageSLA(rows);
            document.getElementById('sla-value').textContent = averageSLA + ' วัน';
        }

        // ฟังก์ชันเพื่ออัปเดต Line Chart
        function updateLineChart(rows) {
            const monthOrder = ['Jan25', 'Feb25', 'Mar25', 'Apr25'];
            const lineChartCanvas = document.getElementById('lineChart').getContext('2d');

            const lineChartData = {
                labels: monthOrder,
                datasets: [{
                    label: 'จำนวนการขึ้นทะเบียนช่างใหม่',
                    data: monthOrder.map(month => {
                        return rows.filter(row => row.c[28]?.v === month && row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย").length;
                    }),
                    backgroundColor: '#006400', // สีเขียวเข้ม
                    borderColor: '#006400',
                    fill: true
                }]
            };

            if (lineChart) {
                lineChart.destroy();
            }

            lineChart = new Chart(lineChartCanvas, {
                type: 'bar', // เปลี่ยนเป็นกราฟแท่ง
                data: lineChartData,
                options: {
                    responsive: true,
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return value === 0 ? '' : Math.round(value);
                            },
                            font: {
                                weight: 'bold',
                                size: 14 /* เพิ่มขนาดตัวอักษรในกราฟ */
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100, // กำหนดค่าสูงสุดของแกน Y ที่ 100
                            ticks: {
                                stepSize: 10
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // ฟังก์ชันเพื่ออัปเดตตาราง
        function updateTables(rows) {
            // อัปเดต Pivot Table
            updatePivotTable(rows);

            const dataBody = document.getElementById('data-body');
            dataBody.innerHTML = '';
            
            // Define column headers with their corresponding data keys
            const columnHeaders = [
                { text: "พื้นที่", key: "area" },
                { text: "รอบวันที่", key: "roundDate" },
                { text: "เดือนอบรม", key: "trainingMonth" },
                { text: "week", key: "week" },
                { text: "ชื่อ-นามสกุล", key: "name" },
                { text: "ชื่อ บจก./หจก/ร้าน (ตัวแทน)", key: "company" },
                { text: "รหัสตัวแทน", key: "agentCode" },
                { text: "จังหวัดที่ตั้งร้านตัวแทน", key: "province" },
                { text: "สถานะกองงาน (หัวหน้าหรือลูกน้อง)", key: "workStatus" },
                { text: "ผลการขึ้นทะเบียน", key: "registerResult" },
                { text: "Status ล่าสุด", key: "latestStatus" },
                { text: "วันเริ่มต้น", key: "startDate" },
                { text: "วันสิ้นสุด", key: "endDate" },
                { text: "SLA", key: "sla" },
                { text: "ปี", key: "year" }
            ];

            // Add column headers to the table
            const dataHeader = document.getElementById('data-table').getElementsByTagName('thead')[0];
            dataHeader.innerHTML = '';
            let headerRow = dataHeader.insertRow();
            columnHeaders.forEach(header => {
                let th = document.createElement("th");
                th.textContent = header.text;
                th.dataset.key = header.key;
                th.onclick = function() {
                    const isAsc = !this.classList.contains('sort-asc');
                    document.querySelectorAll('#data-table th').forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc');
                    });
                    this.classList.add(isAsc ? 'sort-asc' : 'sort-desc');
                    sortTable(header.key, isAsc);
                };
                headerRow.appendChild(th);
            });

            // Store the rows data globally for sorting
            window.tableData = rows.filter(row => row.c[41]?.v === '2025').map(row => {
                return {
                    area: row.c[26]?.v || '',
                    roundDate: row.c[27]?.v || '',
                    trainingMonth: row.c[28]?.v || '',
                    week: row.c[39]?.v || '',
                    name: row.c[3]?.v || '',
                    company: row.c[6]?.v || '',
                    agentCode: row.c[7]?.v || '',
                    province: row.c[8]?.v || '',
                    workStatus: row.c[13]?.v || '',
                    registerResult: row.c[33]?.v || '',
                    latestStatus: row.c[34]?.v || '',
                    startDate: row.c[35]?.v || '',
                    endDate: row.c[36]?.v || '',
                    sla: row.c[37]?.v || '',
                    year: row.c[41]?.v || ''
                };
            });

            // Initial render of the table data
            renderTableData(window.tableData);
        }

        // Function to render table data
        function renderTableData(data) {
            const dataBody = document.getElementById('data-body');
            dataBody.innerHTML = '';
            
            data.forEach(rowData => {
                const tr = document.createElement('tr');
                const cells = [
                    rowData.area || '',
                    rowData.roundDate || '',
                    rowData.trainingMonth || '',
                    rowData.week || '',
                    rowData.name || '',
                    rowData.company || '',
                    rowData.agentCode || '',
                    rowData.province || '',
                    rowData.workStatus || '',
                    rowData.registerResult || '',
                    rowData.latestStatus || '',
                    rowData.startDate || '',
                    rowData.endDate || '',
                    rowData.sla || '',
                    rowData.year || ''
                ];

                cells.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData;
                    td.style.userSelect = 'text';
                    td.style.webkitUserSelect = 'text';
                    td.style.mozUserSelect = 'text';
                    td.style.msUserSelect = 'text';
                    td.style.cursor = 'text';
                    tr.appendChild(td);
                });

                dataBody.appendChild(tr);
            });
        }

        // Function to sort table
        function sortTable(key, isAsc) {
            const sortedData = [...window.tableData].sort((a, b) => {
                let valueA = a[key];
                let valueB = b[key];

                // Handle numeric values
                if (!isNaN(valueA) && !isNaN(valueB)) {
                    valueA = Number(valueA);
                    valueB = Number(valueB);
                }

                // Handle empty values
                if (!valueA && valueA !== 0) return isAsc ? 1 : -1;
                if (!valueB && valueB !== 0) return isAsc ? -1 : 1;

                // Handle dates in format DD/MM/YYYY
                if (key === 'startDate' || key === 'endDate') {
                    if (valueA && valueB) {
                        const [dayA, monthA, yearA] = valueA.split('/').map(Number);
                        const [dayB, monthB, yearB] = valueB.split('/').map(Number);
                        const dateA = new Date(yearA, monthA - 1, dayA);
                        const dateB = new Date(yearB, monthB - 1, dayB);
                        return isAsc ? dateA - dateB : dateB - dateA;
                    }
                }

                // Handle week format (Week XX)
                if (key === 'week') {
                    const weekA = parseInt(valueA.replace('Week ', '')) || 0;
                    const weekB = parseInt(valueB.replace('Week ', '')) || 0;
                    return isAsc ? weekA - weekB : weekB - weekA;
                }

                // Handle month format (JanXX, FebXX, etc.)
                if (key === 'trainingMonth') {
                    const monthOrder = { 'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6, 
                                      'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12 };
                    const monthA = monthOrder[valueA.substring(0, 3)] || 0;
                    const monthB = monthOrder[valueB.substring(0, 3)] || 0;
                    return isAsc ? monthA - monthB : monthB - monthA;
                }

                // Default string comparison
                return isAsc ? 
                    valueA.toString().localeCompare(valueB.toString()) : 
                    valueB.toString().localeCompare(valueA.toString());
            });

            // Render sorted data
            renderTableData(sortedData);

            // Update sort indicators
            const headers = document.querySelectorAll('#data-table th');
            headers.forEach(header => {
                if (header.dataset.key === key) {
                    header.classList.remove(isAsc ? 'sort-desc' : 'sort-asc');
                    header.classList.add(isAsc ? 'sort-asc' : 'sort-desc');
                } else {
                    header.classList.remove('sort-asc', 'sort-desc');
                }
            });
        }

        function updatePivotTable(rows) {
            const pivotHeader = document.getElementById('pivot-header');
            const pivotBody = document.getElementById('pivot-body');
            pivotHeader.innerHTML = '';
            pivotBody.innerHTML = '';

            // กำหนดลำดับพื้นที่ที่ต้องการแสดง
            const areaOrder = [
                'RSM1_BMA-West',
                'RSM2_BMA-East',
                'RSM3_UPC-East',
                'RSM4_UPC-NOR',
                'RSM5_UPC-NOE1',
                'RSM6_UPC-NOE2',
                'RSM7_UPC-CEW',
                'RSM8_UPC-SOU'
            ];

            // เก็บข้อมูลสำหรับการ sort
            let pivotData = {
                headers: [],
                rows: []
            };

            const thAreaMonth = document.createElement('th');
            thAreaMonth.textContent = 'จำนวนช่าง(คน)';
            thAreaMonth.style.cursor = 'pointer';
            thAreaMonth.onclick = () => sortPivotTable(0);
            pivotHeader.appendChild(thAreaMonth);
            pivotData.headers.push('จำนวนช่าง(คน)');

            // ดึงค่า Status ที่มีอยู่ทั้งหมดและเรียงลำดับ
            const statusValues = [...new Set(rows.map(row => row.c[34]?.v).filter(Boolean))].sort();

            // เพิ่ม column headers สำหรับแต่ละ Status
            statusValues.forEach((status, index) => {
                const th = document.createElement('th');
                th.textContent = status;
                th.style.cursor = 'pointer';
                th.onclick = () => sortPivotTable(index + 1);
                pivotHeader.appendChild(th);
                pivotData.headers.push(status);
            });

            const thGrandTotal = document.createElement('th');
            thGrandTotal.textContent = 'Grand Total';
            thGrandTotal.style.cursor = 'pointer';
            thGrandTotal.onclick = () => sortPivotTable(statusValues.length + 1);
            pivotHeader.appendChild(thGrandTotal);
            pivotData.headers.push('Grand Total');

            const monthOrder = ['Jan25', 'Feb25', 'Mar25', 'Apr25'];
            let grandTotalByStatus = {};
            statusValues.forEach(status => grandTotalByStatus[status] = 0);

            // รวบรวมข้อมูลสำหรับแต่ละพื้นที่
            const areaData = new Map();
            rows.forEach(row => {
                const area = row.c[26]?.v;
                const month = row.c[28]?.v;
                const status = row.c[34]?.v;

                if (!area || !month || !status) return;

                if (!areaData.has(area)) {
                    areaData.set(area, {
                        monthData: {},
                        statusTotals: {},
                        total: 0
                    });
                    statusValues.forEach(s => areaData.get(area).statusTotals[s] = 0);
                    monthOrder.forEach(m => {
                        areaData.get(area).monthData[m] = {};
                        statusValues.forEach(s => areaData.get(area).monthData[m][s] = 0);
                    });
                }

                const areaInfo = areaData.get(area);
                if (monthOrder.includes(month)) {
                    areaInfo.monthData[month][status] = (areaInfo.monthData[month][status] || 0) + 1;
                    areaInfo.statusTotals[status] = (areaInfo.statusTotals[status] || 0) + 1;
                    areaInfo.total += 1;
                }
            });

            let overallGrandTotal = 0;

            // แสดงข้อมูลตามพื้นที่
            // ใช้ลำดับจาก areaOrder แทนที่จะวนลูปผ่าน areaData
            areaOrder.forEach(orderedArea => {
                if (!areaData.has(orderedArea)) return; // ข้ามถ้าไม่มีข้อมูลสำหรับพื้นที่นี้
                
                const areaInfo = areaData.get(orderedArea);
                
                // สร้างแถวหัวพื้นที่
                const trArea = document.createElement('tr');
                const tdArea = document.createElement('td');
                tdArea.textContent = orderedArea;
                tdArea.style.fontWeight = 'bold';
                trArea.appendChild(tdArea);

                statusValues.forEach(() => {
                    const tdEmpty = document.createElement('td');
                    trArea.appendChild(tdEmpty);
                });
                trArea.appendChild(document.createElement('td'));
                pivotBody.appendChild(trArea);

                // แสดงข้อมูลรายเดือน
                monthOrder.forEach(month => {
                    const tr = document.createElement('tr');
                    const tdMonth = document.createElement('td');
                    tdMonth.textContent = month;
                    tr.appendChild(tdMonth);

                    let monthTotal = 0;
                    statusValues.forEach(status => {
                        const count = areaInfo.monthData[month][status] || 0;
                        const td = document.createElement('td');
                        td.textContent = count > 0 ? count : ''; // แสดงเฉพาะค่าที่มากกว่า 0
                        tr.appendChild(td);
                        monthTotal += count;
                        grandTotalByStatus[status] += count;
                    });

                    const tdMonthTotal = document.createElement('td');
                    tdMonthTotal.textContent = monthTotal > 0 ? monthTotal : ''; // แสดงเฉพาะค่าที่มากกว่า 0
                    tr.appendChild(tdMonthTotal);
                    pivotBody.appendChild(tr);
                    overallGrandTotal += monthTotal;
                });

                // แสดงผลรวมของพื้นที่
                const trAreaTotal = document.createElement('tr');
                const tdAreaTotal = document.createElement('td');
                tdAreaTotal.textContent = `${orderedArea} Total`;
                tdAreaTotal.style.fontWeight = 'bold';
                tdAreaTotal.className = 'area-total';
                trAreaTotal.appendChild(tdAreaTotal);

                statusValues.forEach(status => {
                    const td = document.createElement('td');
                    const statusTotal = areaInfo.statusTotals[status] || 0;
                    td.textContent = statusTotal > 0 ? statusTotal : ''; // แสดงเฉพาะค่าที่มากกว่า 0
                    td.style.fontWeight = 'bold';
                    trAreaTotal.appendChild(td);
                });

                const tdTotal = document.createElement('td');
                tdTotal.textContent = areaInfo.total > 0 ? areaInfo.total : ''; // แสดงเฉพาะค่าที่มากกว่า 0
                tdTotal.style.fontWeight = 'bold';
                tdTotal.className = 'area-total';
                trAreaTotal.appendChild(tdTotal);
                pivotBody.appendChild(trAreaTotal);
            });

            // แสดงผลรวมทั้งหมด
            const trGrandTotal = document.createElement('tr');
            trGrandTotal.className = 'grand-total';
            const tdGrandTotal = document.createElement('td');
            tdGrandTotal.textContent = 'Grand Total';
            tdGrandTotal.style.fontWeight = 'bold';
            trGrandTotal.appendChild(tdGrandTotal);

            statusValues.forEach(status => {
                const td = document.createElement('td');
                const statusTotal = grandTotalByStatus[status] || 0;
                td.textContent = statusTotal > 0 ? statusTotal : ''; // แสดงเฉพาะค่าที่มากกว่า 0
                td.style.fontWeight = 'bold';
                trGrandTotal.appendChild(td);
            });

            const tdOverallTotal = document.createElement('td');
            tdOverallTotal.textContent = overallGrandTotal > 0 ? overallGrandTotal : ''; // แสดงเฉพาะค่าที่มากกว่า 0
            tdOverallTotal.style.fontWeight = 'bold';
            trGrandTotal.appendChild(tdOverallTotal);
            pivotBody.appendChild(trGrandTotal);

            // เพิ่มฟังก์ชัน sortPivotTable
            function sortPivotTable(columnIndex) {
                const tbody = document.getElementById('pivot-body');
                const rows = Array.from(tbody.getElementsByTagName('tr'));
                let sortOrder = tbody.dataset.sortOrder === 'asc' ? 'desc' : 'asc';
                tbody.dataset.sortOrder = sortOrder;

                const sortedRows = rows.sort((a, b) => {
                    // ข้ามแถวที่เป็นหัวพื้นที่ (ไม่มีข้อมูลตัวเลข)
                    if (a.cells.length === 1 || b.cells.length === 1) return 0;

                    const aValue = a.cells[columnIndex].textContent;
                    const bValue = b.cells[columnIndex].textContent;

                    // แปลงค่าเป็นตัวเลขถ้าเป็นไปได้
                    const aNum = parseFloat(aValue) || 0;
                    const bNum = parseFloat(bValue) || 0;

                    if (sortOrder === 'asc') {
                        return aNum - bNum;
                    } else {
                        return bNum - aNum;
                    }
                });

                // จัดเรียงแถวใหม่
                sortedRows.forEach(row => tbody.appendChild(row));

                // อัปเดตไอคอนการเรียงลำดับ
                const headers = pivotHeader.getElementsByTagName('th');
                headers.forEach((header, index) => {
                    header.classList.remove('sort-asc', 'sort-desc');
                    if (index === columnIndex) {
                        header.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            }
        }

        // Restore original data on outside click
        document.addEventListener('click', event => {
            if (!event.target.closest('#chart-container')) {
                updateChartAndTables(filteredData2025);
            }
        });

        // ฟังก์ชันเพื่อดาวน์โหลดตารางเป็น Excel
        function downloadTableAsExcel() {
            const table = document.getElementById('data-table');
            const workbook = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(workbook, 'data-table.xlsx');
        }

        // ฟังก์ชันเพื่อดึงเฉพาะปีจากวันที่ในรูปแบบ Date(YYYY,MM,DD)
        function getYearFromGoogleSheetDate(dateString) {
            if (!dateString || !dateString.startsWith("Date(")) return null;
            const matches = dateString.match(/Date\((\d+),(\d+),(\d+)\)/);
            return matches ? parseInt(matches[1], 10) : null;
        }

        // ฟังก์ชันเพื่อแปลงวันที่ในรูปแบบ Date(YYYY,MM,DD) ให้เป็น DD/MM/YYYY
        function parseGoogleSheetDate(dateString) {
            if (!dateString || !dateString.startsWith("Date(")) return '';
            const matches = dateString.match(/Date\((\d+),(\d+),(\d+)\)/);
            if (!matches) return '';
            const year = parseInt(matches[1], 10);
            const month = parseInt(matches[2], 10) + 1;
            const day = parseInt(matches[3], 10);
            return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
        }

        // ฟังก์ชันคำนวณค่าเฉลี่ย SLA
        function calculateAverageSLA(rows) {
            let count = 0;
            const totalSLA = 7218; // กำหนดค่าผลรวม SLA ที่ถูกต้อง
            
            // นับจำนวนช่างที่ขึ้นทะเบียนเรียบร้อย
            rows.forEach(row => {
                if (row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย") {
                    count++;
                }
            });
            
            // แสดงข้อมูลในคอนโซลเพื่อตรวจสอบ
            console.log('จำนวนคนที่ขึ้นทะเบียนเรียบร้อย:', count);
            console.log('ผลรวม SLA ทั้งหมด:', totalSLA);
            console.log('ค่าเฉลี่ย SLA:', totalSLA / count);
            
            // คำนวณค่าเฉลี่ยและคืนค่า
            return count > 0 ? (totalSLA / count).toFixed(2) : '-';
        }

        // ฟังก์ชันนับจำนวนช่างใหม่
        function countNewTechnicians(rows) {
            let count = 0;
            rows.forEach(row => {
                if (row.c[34]?.v === "ขึ้นทะเบียนเรียบร้อย") {
                    count++;
                }
            });
            return count;
        }

        // Function to search table data
        function searchTableData() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderTableData(window.tableData);
                return;
            }

            const filteredData = window.tableData.filter(row => {
                return Object.values(row).some(value => {
                    if (value === null || value === undefined) return false;
                    return value.toString().toLowerCase().includes(searchTerm);
                });
            });

            renderTableData(filteredData);
        }

        // เพิ่ม event listener ให้ปุ่ม
        document.addEventListener('DOMContentLoaded', function() {
            // ลบ event listeners เดิมที่อาจมีอยู่
            const searchButton = document.getElementById('search-button');
            const searchInput = document.getElementById('search-input');
            const searchForm = document.querySelector('.search-container');

            // ลบ event listener เดิมและเพิ่มใหม่
            searchButton.replaceWith(searchButton.cloneNode(true));
            const newSearchButton = document.getElementById('search-button');
            
            // เพิ่ม event listener ใหม่
            newSearchButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                searchTableData();
            });

            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                searchTableData();
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchTableData();
                }
            });

            document.getElementById('refresh-button').addEventListener('click', fetchDataAndUpdateTable);
            document.getElementById('download-button').addEventListener('click', downloadTableAsExcel);

            // เพิ่มการจัดการการเลือกข้อความในตาราง
            const dataTable = document.getElementById('data-table');
            if (dataTable) {
                dataTable.addEventListener('mousedown', function(e) {
                    if (e.target.tagName === 'TD') {
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(e.target);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });

                // ป้องกันการเลือกข้อความถูกยกเลิกเมื่อลากเมาส์
                dataTable.addEventListener('selectstart', function(e) {
                    if (e.target.tagName === 'TD') {
                        e.preventDefault();
                    }
                });
            }
        });

        // ดึงข้อมูลครั้งแรกเมื่อโหลดหน้าเว็บ
        fetchDataAndUpdateTable();

        // เรียกฟังก์ชันเพื่ออัปเดตวันที่และเวลาในทุกๆ วินาที
        updateCurrentDateTime();

        // ฟังก์ชันนับจำนวนช่างทั้งหมด
        function countTotalTechnicians(rows) {
            return rows.length;
        }
    </script>
</body>
</html>